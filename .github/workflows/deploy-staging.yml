name: Deploy to Staging

on:
  # Disabled automatic deployment - run manually only
  # push:
  #   branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'

jobs:
  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install system dependencies for python-ldap
      run: |
        sudo apt-get update
        sudo apt-get install -y libldap2-dev libsasl2-dev
    
    - name: Install dependencies
      working-directory: New Folder With Items
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # Tests disabled - already validated in CI/CD workflow
    # - name: Run tests
    #   working-directory: New Folder With Items
    #   env:
    #     DJANGO_SETTINGS_MODULE: rotasystems.settings
    #   run: |
    #     python manage.py test scheduling --noinput
    
    - name: Build deployment package
      working-directory: New Folder With Items
      run: |
        mkdir -p deploy
        cp -r scheduling deploy/
        cp -r rotasystems deploy/
        cp -r incident_safety deploy/
        cp -r experience_feedback deploy/
        cp manage.py deploy/
        cp requirements.txt deploy/
        cd deploy && tar -czf ../staging-release.tar.gz *
        echo "âœ… Deployment package created: staging-release.tar.gz"
        ls -lh ../staging-release.tar.gz
    
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: staging-release
        path: New Folder With Items/staging-release.tar.gz
        retention-days: 7
    
    # SSH deployment disabled - configure STAGING_HOST, STAGING_USER, STAGING_SSH_KEY, STAGING_PATH secrets to enable
    # - name: Deploy to staging server
    #   env:
    #     STAGING_HOST: ${{ secrets.STAGING_HOST }}
    #     STAGING_USER: ${{ secrets.STAGING_USER }}
    #     STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
    #     STAGING_PATH: ${{ secrets.STAGING_PATH }}
    #   run: |
    #     echo "ðŸš€ Deploying to staging environment..."
    #     
    #     # Setup SSH
    #     mkdir -p ~/.ssh
    #     echo "$STAGING_SSH_KEY" > ~/.ssh/staging_key
    #     chmod 600 ~/.ssh/staging_key
    #     ssh-keyscan -H $STAGING_HOST >> ~/.ssh/known_hosts
    #     
    #     # Upload release package
    #     scp -i ~/.ssh/staging_key staging-release.tar.gz $STAGING_USER@$STAGING_HOST:$STAGING_PATH/
    #     
    #     # Deploy on server
    #     ssh -i ~/.ssh/staging_key $STAGING_USER@$STAGING_HOST << 'ENDSSH'
    #       [SSH deployment commands disabled]
    #     ENDSSH
    
    # Smoke tests disabled - enable after configuring staging server
    # - name: Run staging smoke tests
    #   env:
    #     STAGING_URL: ${{ secrets.STAGING_URL }}
    #   run: |
    #     echo "ðŸ§ª Running smoke tests on staging..."
    
    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Staging deployment successful"
        else
          echo "âŒ Staging deployment failed"
        fi
