name: Deploy to Staging

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.14'

jobs:
  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      env:
        DJANGO_SETTINGS_MODULE: rotasystems.settings
      run: |
        python manage.py test scheduling --noinput
    
    - name: Build deployment package
      run: |
        mkdir -p deploy
        cp -r scheduling deploy/
        cp -r rotasystems deploy/
        cp manage.py deploy/
        cp requirements.txt deploy/
        cd deploy && tar -czf ../staging-release.tar.gz *
    
    - name: Deploy to staging server
      env:
        STAGING_HOST: ${{ secrets.STAGING_HOST }}
        STAGING_USER: ${{ secrets.STAGING_USER }}
        STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
        STAGING_PATH: ${{ secrets.STAGING_PATH }}
      run: |
        echo "ðŸš€ Deploying to staging environment..."
        
        # Setup SSH
        mkdir -p ~/.ssh
        echo "$STAGING_SSH_KEY" > ~/.ssh/staging_key
        chmod 600 ~/.ssh/staging_key
        ssh-keyscan -H $STAGING_HOST >> ~/.ssh/known_hosts
        
        # Upload release package
        scp -i ~/.ssh/staging_key staging-release.tar.gz $STAGING_USER@$STAGING_HOST:$STAGING_PATH/
        
        # Deploy on server
        ssh -i ~/.ssh/staging_key $STAGING_USER@$STAGING_HOST << 'ENDSSH'
          cd $STAGING_PATH
          
          # Backup current version
          if [ -d "current" ]; then
            cp -r current backup_$(date +%Y%m%d_%H%M%S)
          fi
          
          # Extract new version
          mkdir -p releases/$(date +%Y%m%d_%H%M%S)
          tar -xzf staging-release.tar.gz -C releases/$(date +%Y%m%d_%H%M%S)
          
          # Update symlink to new release
          ln -sfn releases/$(date +%Y%m%d_%H%M%S) current
          
          # Activate virtual environment and run migrations
          cd current
          source venv/bin/activate
          pip install -r requirements.txt
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          
          # Restart application (adjust for your setup: gunicorn, uwsgi, etc.)
          sudo systemctl restart staff-rota-staging
          
          echo "âœ… Deployment complete"
        ENDSSH
    
    - name: Run staging smoke tests
      env:
        STAGING_URL: ${{ secrets.STAGING_URL }}
      run: |
        echo "ðŸ§ª Running smoke tests on staging..."
        
        # Wait for application to start
        sleep 10
        
        # Health check
        curl -f ${STAGING_URL}/admin/ || exit 1
        echo "âœ… Admin page accessible"
        
        # Test critical endpoints
        curl -f ${STAGING_URL}/management/ || exit 1
        echo "âœ… Management dashboard accessible"
        
        # Test API endpoints
        curl -f ${STAGING_URL}/management/api/ai-assistant/ -X POST -H "Content-Type: application/json" -d '{"query":"test"}' || echo "âš ï¸ AI endpoint needs authentication"
        
        echo "âœ… Smoke tests passed"
    
    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Staging deployment successful"
        else
          echo "âŒ Staging deployment failed"
        fi
