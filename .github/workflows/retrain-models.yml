name: Automated Model Retraining

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  retrain-models:
    name: Retrain Prophet Models
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: ${{ secrets.DB_NAME }}
          POSTGRES_USER: ${{ secrets.DB_USER }}
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7
        ports:
          - 6379:6379
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Restore database backup
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        echo "ðŸ“¥ Restoring latest production database for retraining..."
        # Download latest production database backup
        # Restore to retraining environment
    
    - name: Check for model drift
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        DJANGO_SETTINGS_MODULE: rotasystems.settings
      run: |
        python manage.py monitor_forecasts --no-email > drift_report.txt
        cat drift_report.txt
    
    - name: Retrain models (parallel)
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        REDIS_URL: redis://localhost:6379/0
        DJANGO_SETTINGS_MODULE: rotasystems.settings
      run: |
        echo "ðŸ”„ Retraining Prophet models with parallel processing..."
        python -c "
        import os, django
        os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'rotasystems.settings')
        django.setup()
        
        from scheduling.prophet_integration import train_prophet_model
        from scheduling.models import CareHome, Unit
        from concurrent.futures import ThreadPoolExecutor, as_completed
        import time
        
        units = Unit.objects.all()
        
        print(f'Starting parallel training for {units.count()} units...')
        start_time = time.time()
        
        with ThreadPoolExecutor(max_workers=4) as executor:
            futures = {
                executor.submit(train_prophet_model, unit, days=365): unit 
                for unit in units
            }
            
            for future in as_completed(futures):
                unit = futures[future]
                try:
                    model_path = future.result()
                    print(f'âœ“ {unit.care_home.name}/{unit.name}: {model_path}')
                except Exception as e:
                    print(f'âœ— {unit.care_home.name}/{unit.name}: {e}')
        
        elapsed = time.time() - start_time
        print(f'\nTotal training time: {elapsed:.1f}s')
        print(f'Average per unit: {elapsed/units.count():.1f}s')
        "
    
    - name: Validate retrained models
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        DJANGO_SETTINGS_MODULE: rotasystems.settings
      run: |
        echo "âœ… Validating retrained models..."
        python -c "
        import os, django, pickle
        from pathlib import Path
        os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'rotasystems.settings')
        django.setup()
        
        from scheduling.models import Unit
        
        units = Unit.objects.all()
        valid_count = 0
        
        for unit in units:
            model_path = f'prophet_models/{unit.care_home.name}_{unit.name}_model.pkl'
            if Path(model_path).exists():
                with open(model_path, 'rb') as f:
                    model = pickle.load(f)
                    # Basic validation
                    if hasattr(model, 'predict'):
                        valid_count += 1
                        print(f'âœ“ {unit.care_home.name}/{unit.name}')
                    else:
                        print(f'âœ— {unit.care_home.name}/{unit.name} - Invalid model')
            else:
                print(f'âœ— {unit.care_home.name}/{unit.name} - Model not found')
        
        print(f'\nValidation: {valid_count}/{units.count()} models valid')
        if valid_count < units.count():
            exit(1)
        "
    
    - name: Calculate model performance metrics
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        DJANGO_SETTINGS_MODULE: rotasystems.settings
      run: |
        echo "ðŸ“Š Calculating MAPE for retrained models..."
        python -c "
        import os, django
        os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'rotasystems.settings')
        django.setup()
        
        from scheduling.forecast_monitoring import ForecastMonitor
        from scheduling.models import CareHome, Unit
        from datetime import date, timedelta
        
        monitor = ForecastMonitor()
        
        for care_home in CareHome.objects.all():
            for unit in care_home.units.all():
                metrics = monitor.get_recent_performance(care_home, unit, days=30)
                if metrics:
                    avg_mape = sum(m.mape for m in metrics) / len(metrics)
                    print(f'{care_home.name}/{unit.name}: MAPE={avg_mape:.1f}%')
        "
    
    - name: Archive old models
      run: |
        DATE=$(date +%Y-%m-%d)
        mkdir -p model_archives/${DATE}
        cp -r prophet_models/* model_archives/${DATE}/ || true
        echo "ðŸ“¦ Archived old models to model_archives/${DATE}/"
    
    - name: Upload retrained models
      uses: actions/upload-artifact@v3
      with:
        name: prophet-models-retrained
        path: prophet_models/
        retention-days: 90
    
    - name: Deploy models to production
      if: success()
      env:
        PRODUCTION_HOST: ${{ secrets.PRODUCTION_HOST }}
      run: |
        echo "ðŸš€ Deploying retrained models to production..."
        # Upload prophet_models/ directory to production server
        # Restart application to load new models
        # Clear forecast cache to force regeneration
    
    - name: Clear forecast cache
      if: success()
      env:
        REDIS_URL: ${{ secrets.PRODUCTION_REDIS_URL }}
      run: |
        echo "ðŸ—‘ï¸ Clearing forecast cache..."
        python -c "
        import redis
        r = redis.from_url('${{ secrets.PRODUCTION_REDIS_URL }}')
        keys = r.keys('rota:forecast:*')
        if keys:
            r.delete(*keys)
            print(f'Cleared {len(keys)} forecast cache entries')
        else:
            print('No forecast cache entries to clear')
        "
    
    - name: Generate retraining report
      if: always()
      run: |
        DATE=$(date +%Y-%m-%d)
        cat > retraining_report_${DATE}.txt << EOF
        ========================================
        PROPHET MODEL RETRAINING REPORT
        ========================================
        Date: ${DATE}
        Status: ${{ job.status }}
        
        Drift Analysis:
        $(cat drift_report.txt)
        
        Deployment Status: ${{ job.status }}
        
        Next scheduled retraining: Next Sunday 2 AM UTC
        ========================================
        EOF
        cat retraining_report_${DATE}.txt
    
    - name: Upload retraining report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: retraining-report
        path: retraining_report_*.txt
    
    - name: Notify team
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Model retraining completed successfully"
          echo "ðŸ“§ Send success notification to team"
        else
          echo "âŒ Model retraining failed"
          echo "ðŸ“§ Send failure alert to team"
        fi
