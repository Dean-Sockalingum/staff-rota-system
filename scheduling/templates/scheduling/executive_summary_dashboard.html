{% extends "scheduling/base.html" %}
{% load static %}

{% block title %}Executive Summary Dashboard{% endblock %}

{% block extra_css %}
<style>
    .executive-dashboard {
        background: #f8f9fa;
        min-height: 100vh;
        padding: 20px;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .dashboard-header h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 700;
    }
    
    .dashboard-header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
    }
    
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .kpi-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }
    
    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--kpi-color, #667eea);
    }
    
    .kpi-card.success::before { background: #10b981; }
    .kpi-card.warning::before { background: #f59e0b; }
    .kpi-card.danger::before { background: #ef4444; }
    
    .kpi-label {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .kpi-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 10px;
    }
    
    .kpi-trend {
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        gap: 5px;
    }
    
    .kpi-trend.up {
        color: #10b981;
    }
    
    .kpi-trend.down {
        color: #ef4444;
    }
    
    .kpi-trend.neutral {
        color: #6b7280;
    }
    
    .kpi-target {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 5px;
    }
    
    .chart-section {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-section h2 {
        font-size: 1.5rem;
        margin: 0 0 20px 0;
        color: #1f2937;
    }
    
    .insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .insight-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid var(--insight-color, #667eea);
    }
    
    .insight-card.critical {
        --insight-color: #ef4444;
        background: #fef2f2;
    }
    
    .insight-card.warning {
        --insight-color: #f59e0b;
        background: #fffbeb;
    }
    
    .insight-card.success {
        --insight-color: #10b981;
        background: #f0fdf4;
    }
    
    .insight-card.info {
        --insight-color: #3b82f6;
        background: #eff6ff;
    }
    
    .insight-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    .insight-icon {
        font-size: 1.5rem;
    }
    
    .insight-title {
        font-weight: 600;
        color: #1f2937;
    }
    
    .insight-message {
        color: #4b5563;
        margin-bottom: 10px;
    }
    
    .insight-recommendation {
        color: #6b7280;
        font-style: italic;
        font-size: 0.875rem;
    }
    
    .filters-bar {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: end;
    }
    
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    
    .filter-group label {
        display: block;
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 5px;
        font-weight: 500;
    }
    
    .filter-group select,
    .filter-group input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
    }
    
    .btn-apply {
        padding: 8px 20px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
    }
    
    .btn-apply:hover {
        background: #5568d3;
    }
    
    .btn-export {
        padding: 8px 20px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
    }
    
    .btn-export:hover {
        background: #059669;
    }
    
    .comparison-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .comparison-table th {
        background: #f3f4f6;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #1f2937;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .comparison-table td {
        padding: 12px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .comparison-table tr:hover {
        background: #f9fafb;
    }
    
    .rank-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .rank-badge.rank-1 {
        background: #d1fae5;
        color: #065f46;
    }
    
    .rank-badge.rank-2 {
        background: #dbeafe;
        color: #1e40af;
    }
    
    .rank-badge.rank-3 {
        background: #fef3c7;
        color: #92400e;
    }
</style>
{% endblock %}

{% block content %}
<div class="executive-dashboard">
    <!-- Header -->
    <div class="dashboard-header">
        <h1>üìä Executive Summary Dashboard</h1>
        <p>Comprehensive analytics, trends, and forecasts for strategic decision-making</p>
        <p style="font-size: 0.875rem; opacity: 0.8;">
            Period: {{ start_date|date:"d M Y" }} - {{ end_date|date:"d M Y" }}
            {% if selected_home %}| Care Home: {{ selected_home.name }}{% else %}| All Care Homes{% endif %}
        </p>
    </div>
    
    <!-- Filters -->
    <div class="filters-bar">
        <div class="filter-group">
            <label for="careHomeFilter">Care Home</label>
            <select id="careHomeFilter" name="care_home_id">
                <option value="">All Homes</option>
                {% for home in care_homes %}
                <option value="{{ home.id }}" {% if selected_home and selected_home.id == home.id %}selected{% endif %}>
                    {{ home.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label for="startDateFilter">Start Date</label>
            <input type="date" id="startDateFilter" name="start_date" value="{{ start_date|date:'Y-m-d' }}">
        </div>
        
        <div class="filter-group">
            <label for="endDateFilter">End Date</label>
            <input type="date" id="endDateFilter" name="end_date" value="{{ end_date|date:'Y-m-d' }}">
        </div>
        
        <button class="btn-apply" onclick="applyFilters()">Apply Filters</button>
        <button class="btn-export" onclick="exportPDF()">üìÑ Export PDF</button>
    </div>
    
    <!-- KPI Cards -->
    <div class="kpi-grid">
        <!-- Fill Rate KPI -->
        <div class="kpi-card {{ kpis.kpis.fill_rate.status }}">
            <div class="kpi-label">Fill Rate</div>
            <div class="kpi-value">{{ kpis.kpis.fill_rate.value }}%</div>
            <div class="kpi-trend {{ kpis.kpis.fill_rate.trend.direction }}">
                {% if kpis.kpis.fill_rate.trend.direction == 'up' %}‚Üó{% elif kpis.kpis.fill_rate.trend.direction == 'down' %}‚Üò{% else %}‚Üí{% endif %}
                {{ kpis.kpis.fill_rate.trend.percentage }}% vs previous period
            </div>
            <div class="kpi-target">Target: {{ kpis.kpis.fill_rate.target }}%</div>
        </div>
        
        <!-- Agency Rate KPI -->
        <div class="kpi-card {{ kpis.kpis.agency_rate.status }}">
            <div class="kpi-label">Agency Usage</div>
            <div class="kpi-value">{{ kpis.kpis.agency_rate.value }}%</div>
            <div class="kpi-trend {{ kpis.kpis.agency_rate.trend.direction }}">
                {% if kpis.kpis.agency_rate.trend.direction == 'up' %}‚Üó{% elif kpis.kpis.agency_rate.trend.direction == 'down' %}‚Üò{% else %}‚Üí{% endif %}
                {{ kpis.kpis.agency_rate.trend.percentage }}% vs previous period
            </div>
            <div class="kpi-target">Target: ‚â§{{ kpis.kpis.agency_rate.target }}%</div>
        </div>
        
        <!-- Total Shifts KPI -->
        <div class="kpi-card">
            <div class="kpi-label">Total Shifts</div>
            <div class="kpi-value">{{ kpis.kpis.total_shifts.value }}</div>
            <div class="kpi-trend {{ kpis.kpis.total_shifts.trend.direction }}">
                {% if kpis.kpis.total_shifts.trend.direction == 'up' %}‚Üó{% elif kpis.kpis.total_shifts.trend.direction == 'down' %}‚Üò{% else %}‚Üí{% endif %}
                {{ kpis.kpis.total_shifts.trend.change }} shifts ({{ kpis.kpis.total_shifts.trend.percentage }}%)
            </div>
        </div>
        
        <!-- Total Cost KPI -->
        <div class="kpi-card">
            <div class="kpi-label">Total Cost</div>
            <div class="kpi-value" style="font-size: 1.8rem;">{{ kpis.kpis.total_cost.formatted }}</div>
            <div class="kpi-trend {{ kpis.kpis.total_cost.trend.direction }}">
                {% if kpis.kpis.total_cost.trend.direction == 'up' %}‚Üó{% elif kpis.kpis.total_cost.trend.direction == 'down' %}‚Üò{% else %}‚Üí{% endif %}
                {{ kpis.kpis.total_cost.trend.percentage }}% vs previous period
            </div>
        </div>
        
        <!-- Total Staff KPI -->
        <div class="kpi-card">
            <div class="kpi-label">Active Staff</div>
            <div class="kpi-value">{{ kpis.kpis.total_staff.value }}</div>
            <div class="kpi-trend {{ kpis.kpis.total_staff.trend.direction }}">
                {% if kpis.kpis.total_staff.trend.direction == 'up' %}‚Üó{% elif kpis.kpis.total_staff.trend.direction == 'down' %}‚Üò{% else %}‚Üí{% endif %}
                {{ kpis.kpis.total_staff.trend.change }} staff ({{ kpis.kpis.total_staff.trend.percentage }}%)
            </div>
        </div>
        
        <!-- Pending Leave KPI -->
        <div class="kpi-card">
            <div class="kpi-label">Pending Leave Requests</div>
            <div class="kpi-value">{{ kpis.kpis.pending_leave.value }}</div>
            <div class="kpi-trend {{ kpis.kpis.pending_leave.trend.direction }}">
                {% if kpis.kpis.pending_leave.trend.direction == 'up' %}‚Üó{% elif kpis.kpis.pending_leave.trend.direction == 'down' %}‚Üò{% else %}‚Üí{% endif %}
                {{ kpis.kpis.pending_leave.trend.change }} requests
            </div>
        </div>
    </div>
    
    <!-- AI Insights -->
    <div class="chart-section">
        <h2>üí° Executive Insights & Recommendations</h2>
        <div class="insights-grid">
            {% for insight in insights %}
            <div class="insight-card {{ insight.type }}">
                <div class="insight-header">
                    <div class="insight-icon">{{ insight.icon }}</div>
                    <div class="insight-title">{{ insight.title }}</div>
                </div>
                <div class="insight-message">{{ insight.message }}</div>
                <div class="insight-recommendation">üí° {{ insight.recommendation }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Trend Chart -->
    <div class="chart-section">
        <h2>üìà 12-Week Trend Analysis</h2>
        <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 15px;">
            Green: Overall Fill Rate | Blue: Day Shifts | Purple: Night Shifts | Orange: Agency Usage
        </p>
        <canvas id="trendChart" height="80"></canvas>
        
        <!-- Current Week Staffing Status by Home -->
        <div id="currentStaffingStatus" style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
            <h3 style="font-size: 0.95rem; font-weight: 600; margin-bottom: 10px; color: #374151;">
                Current Week Staffing by Care Home
            </h3>
            <div id="homeStaffingBars" style="display: grid; gap: 8px;">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Forecast Chart -->
    {% if forecasts.forecasts %}
    <div class="chart-section">
        <h2>üîÆ 4-Week Forecast</h2>
        <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 20px;">
            Method: {{ forecasts.method }} | Historical Data: {{ forecasts.historical_weeks }} weeks
        </p>
        <canvas id="forecastChart" height="80"></canvas>
    </div>
    {% endif %}
    
    <!-- Comparative Analysis -->
    <div class="chart-section">
        <h2>üè• Multi-Home Comparison</h2>
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Care Home</th>
                    <th>Fill Rate</th>
                    <th>Agency Rate</th>
                    <th>Total Cost</th>
                    <th>Overall Rank</th>
                </tr>
            </thead>
            <tbody>
                {% for item in comparison %}
                <tr>
                    <td>
                        <span class="rank-badge rank-{{ forloop.counter }}">
                            #{{ forloop.counter }}
                        </span>
                    </td>
                    <td><strong>{{ item.home_name }}</strong></td>
                    <td>
                        {{ item.kpis.fill_rate.value }}%
                        <span style="color: #6b7280; font-size: 0.75rem;">(Rank: #{{ item.rank_fill_rate }})</span>
                    </td>
                    <td>
                        {{ item.kpis.agency_rate.value }}%
                        <span style="color: #6b7280; font-size: 0.75rem;">(Rank: #{{ item.rank_agency_rate }})</span>
                    </td>
                    <td>
                        {{ item.kpis.total_cost.formatted }}
                        <span style="color: #6b7280; font-size: 0.75rem;">(Rank: #{{ item.rank_cost }})</span>
                    </td>
                    <td><strong>{{ item.overall_rank }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Trend Chart with Day/Night Breakdown
    const trendData = {{ trends_json|safe }};
    const trendLabels = trendData.map(t => {
        const start = new Date(t.week_start);
        return start.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' });
    });
    
    const trendChart = new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
            labels: trendLabels,
            datasets: [
                {
                    label: 'Overall Fill Rate (%)',
                    data: trendData.map(t => t.fill_rate),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y',
                    borderWidth: 2
                },
                {
                    label: 'Day Shifts Fill Rate (%)',
                    data: trendData.map(t => t.day_fill_rate),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y',
                    borderWidth: 2
                },
                {
                    label: 'Night Shifts Fill Rate (%)',
                    data: trendData.map(t => t.night_fill_rate),
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y',
                    borderWidth: 2
                },
                {
                    label: 'Agency Rate (%)',
                    data: trendData.map(t => t.agency_rate),
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y'
                }
            ]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    min: 0,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Percentage (%)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const idx = context.dataIndex;
                            const week = trendData[idx];
                            
                            let tooltip = `Total Shifts: ${week.total_shifts}\n`;
                            tooltip += `Day Shifts: ${week.day_shifts_total} | Night Shifts: ${week.night_shifts_total}\n`;
                            
                            // Show home-specific data if available
                            if (week.homes && week.homes.length > 0) {
                                tooltip += '\n--- Staffing by Care Home ---\n';
                                
                                // Sort homes by fill rate (lowest first - most urgent)
                                const sortedHomes = [...week.homes].sort((a, b) => a.fill_rate - b.fill_rate);
                                
                                sortedHomes.forEach(home => {
                                    const statusIcon = home.fill_rate < 85 ? '‚ö†Ô∏è ' : home.fill_rate < 95 ? '‚ö° ' : '‚úì ';
                                    tooltip += `${statusIcon}${home.name}: ${home.fill_rate}%\n`;
                                    tooltip += `  Day: ${home.day_fill_rate}% | Night: ${home.night_fill_rate}%`;
                                    if (home.vacancies > 0) {
                                        tooltip += ` (${home.vacancies} vacancies)`;
                                    }
                                    tooltip += '\n';
                                });
                            }
                            
                            return tooltip.split('\n');
                        }
                    }
                }
            }
        }
    });
    
    // Forecast Chart
    {% if forecasts.forecasts %}
    const forecastData = {{ forecasts_list_json|safe }};
    const forecastLabels = forecastData.map(f => {
        const start = new Date(f.week_start);
        return start.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' });
    });
    
    const forecastChart = new Chart(document.getElementById('forecastChart'), {
        type: 'line',
        data: {
            labels: forecastLabels,
            datasets: [
                {
                    label: 'Forecasted Fill Rate (%)',
                    data: forecastData.map(f => f.fill_rate),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderDash: [5, 5],
                    tension: 0.4
                },
                {
                    label: 'Forecasted Agency Rate (%)',
                    data: forecastData.map(f => f.agency_rate),
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    borderDash: [5, 5],
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Percentage (%)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const idx = context.dataIndex;
                            return `Confidence: ${forecastData[idx].confidence}%\nEst. Cost: ¬£${forecastData[idx].cost.toLocaleString()}`;
                        }
                    }
                }
            }
        }
    });
    {% endif %}
    
    // Populate current week staffing status bars
    (function() {
        if (trendData.length > 0) {
            const currentWeek = trendData[trendData.length - 1]; // Most recent week
            const container = document.getElementById('homeStaffingBars');
            
            if (currentWeek.homes && currentWeek.homes.length > 0) {
                // Sort homes by fill rate (lowest first - most urgent)
                const sortedHomes = [...currentWeek.homes].sort((a, b) => a.fill_rate - b.fill_rate);
                
                sortedHomes.forEach(home => {
                    const bar = document.createElement('div');
                    bar.style.cssText = 'display: flex; align-items: center; gap: 10px;';
                    
                    // Home name with status icon
                    const statusIcon = home.fill_rate < 85 ? '‚ö†Ô∏è' : home.fill_rate < 95 ? '‚ö°' : '‚úì';
                    const statusColor = home.fill_rate < 85 ? '#dc2626' : home.fill_rate < 95 ? '#f59e0b' : '#10b981';
                    
                    const nameDiv = document.createElement('div');
                    nameDiv.style.cssText = `width: 150px; font-size: 0.85rem; font-weight: 500; color: ${statusColor};`;
                    nameDiv.textContent = `${statusIcon} ${home.name}`;
                    
                    // Fill rate bar container
                    const barContainer = document.createElement('div');
                    barContainer.style.cssText = 'flex: 1; height: 30px; background: #e5e7eb; border-radius: 6px; position: relative; overflow: hidden;';
                    
                    // Day shift portion (left side)
                    const dayBar = document.createElement('div');
                    const dayWidth = (home.day_shifts / (home.day_shifts + home.night_shifts)) * 100;
                    dayBar.style.cssText = `position: absolute; left: 0; top: 0; bottom: 0; width: ${dayWidth}%; background: linear-gradient(90deg, #3b82f6 0%, #3b82f6 ${home.day_fill_rate}%, #e5e7eb ${home.day_fill_rate}%); border-right: 1px solid white;`;
                    
                    // Night shift portion (right side)
                    const nightBar = document.createElement('div');
                    const nightWidth = (home.night_shifts / (home.day_shifts + home.night_shifts)) * 100;
                    nightBar.style.cssText = `position: absolute; right: 0; top: 0; bottom: 0; width: ${nightWidth}%; background: linear-gradient(90deg, #8b5cf6 0%, #8b5cf6 ${home.night_fill_rate}%, #e5e7eb ${home.night_fill_rate}%);`;
                    
                    // Labels in bar
                    const labelDiv = document.createElement('div');
                    labelDiv.style.cssText = 'position: absolute; inset: 0; display: flex; justify-content: space-around; align-items: center; font-size: 0.75rem; font-weight: 600; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);';
                    labelDiv.innerHTML = `<span>Day: ${home.day_fill_rate}%</span><span>Night: ${home.night_fill_rate}%</span>`;
                    
                    barContainer.appendChild(dayBar);
                    barContainer.appendChild(nightBar);
                    barContainer.appendChild(labelDiv);
                    
                    // Overall fill rate
                    const rateDiv = document.createElement('div');
                    rateDiv.style.cssText = 'width: 80px; text-align: right; font-size: 0.85rem; font-weight: 600;';
                    rateDiv.textContent = `${home.fill_rate}%`;
                    rateDiv.style.color = statusColor;
                    
                    // Vacancies
                    const vacancyDiv = document.createElement('div');
                    vacancyDiv.style.cssText = 'width: 100px; text-align: right; font-size: 0.75rem; color: #6b7280;';
                    vacancyDiv.textContent = home.vacancies > 0 ? `${home.vacancies} vacant` : 'Fully staffed';
                    
                    bar.appendChild(nameDiv);
                    bar.appendChild(barContainer);
                    bar.appendChild(rateDiv);
                    bar.appendChild(vacancyDiv);
                    
                    container.appendChild(bar);
                });
            } else {
                container.innerHTML = '<p style="color: #6b7280; font-size: 0.85rem; text-align: center;">No per-home data available (viewing single care home)</p>';
            }
        }
    })();
    
    // Filter functions
    function applyFilters() {
        const careHome = document.getElementById('careHomeFilter').value;
        const startDate = document.getElementById('startDateFilter').value;
        const endDate = document.getElementById('endDateFilter').value;
        
        const params = new URLSearchParams();
        if (careHome) params.append('care_home_id', careHome);
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        
        window.location.href = `?${params.toString()}`;
    }
    
    function exportPDF() {
        const careHome = document.getElementById('careHomeFilter').value;
        const params = new URLSearchParams();
        if (careHome) params.append('care_home_id', careHome);
        
        window.location.href = `/executive-summary/export-pdf/?${params.toString()}`;
    }
</script>
{% endblock %}
