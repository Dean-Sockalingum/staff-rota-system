{% extends "scheduling/base.html" %}
{% load static %}

{% block extra_css %}
<style>
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .dashboard-header h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 600;
    }
    
    .dashboard-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.95;
        font-size: 1.1rem;
    }
    
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .summary-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .summary-card.good { border-left-color: #10b981; }
    .summary-card.warning { border-left-color: #f59e0b; }
    .summary-card.critical { border-left-color: #ef4444; }
    
    .summary-card h3 {
        margin: 0 0 0.5rem 0;
        font-size: 0.9rem;
        color: #6b7280;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    
    .summary-card .value {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.25rem;
    }
    
    .summary-card .subtext {
        font-size: 0.85rem;
        color: #6b7280;
    }
    
    .section {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .section-header h2 {
        margin: 0;
        font-size: 1.5rem;
        color: #1f2937;
        font-weight: 600;
    }
    
    .home-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 1.25rem;
        margin-bottom: 1rem;
    }
    
    .home-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: box-shadow 0.2s;
    }
    
    .home-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .home-card-header h3 {
        margin: 0;
        font-size: 1.25rem;
        color: #1f2937;
    }
    
    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-badge.good {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-badge.warning {
        background: #fed7aa;
        color: #92400e;
    }
    
    .status-badge.critical {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .status-badge.over_budget {
        background: #fecaca;
        color: #7f1d1d;
    }
    
    .metric-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 0.75rem;
    }
    
    .metric {
        display: flex;
        flex-direction: column;
    }
    
    .metric-label {
        font-size: 0.75rem;
        color: #6b7280;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .metric-value {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1f2937;
    }
    
    .progress-bar {
        background: #e5e7eb;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 0.5rem;
    }
    
    .progress-fill {
        height: 100%;
        background: #667eea;
        transition: width 0.3s;
    }
    
    .progress-fill.good { background: #10b981; }
    .progress-fill.warning { background: #f59e0b; }
    .progress-fill.critical { background: #ef4444; }
    
    .alert-item {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 1rem;
        margin-bottom: 0.75rem;
        border-radius: 4px;
    }
    
    .alert-item.critical {
        background: #fee2e2;
        border-left-color: #ef4444;
    }
    
    .alert-item-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }
    
    .alert-item-header strong {
        color: #1f2937;
    }
    
    .alert-item-header .age {
        font-size: 0.85rem;
        color: #6b7280;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #9ca3af;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    table th {
        text-align: left;
        padding: 0.75rem;
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
    }
    
    table td {
        padding: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    table tr:hover {
        background: #f9fafb;
    }
    
    .currency {
        font-family: 'Courier New', monospace;
    }
    
    /* Collapsible Section Styles */
    .collapsible-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
        overflow: hidden;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .collapsible-section:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    }
    
    .collapsible-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem 1.5rem;
        cursor: pointer;
        background: linear-gradient(to right, #f9fafb, white);
        border-bottom: 2px solid #e5e7eb;
        user-select: none;
        transition: background 0.2s ease;
    }
    
    .collapsible-header:hover {
        background: linear-gradient(to right, #f3f4f6, #f9fafb);
    }
    
    .collapsible-header.collapsed {
        border-bottom: none;
    }
    
    .collapsible-title {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin: 0;
    }
    
    .collapsible-title h2 {
        margin: 0;
        font-size: 1.4rem;
        color: #1f2937;
        font-weight: 600;
    }
    
    .section-badge {
        background: #667eea;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .section-badge.alert {
        background: #ef4444;
        animation: pulse 2s infinite;
    }
    
    .section-badge.warning {
        background: #f59e0b;
    }
    
    .section-badge.success {
        background: #10b981;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .collapsible-toggle {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: #6b7280;
        font-size: 0.9rem;
    }
    
    .toggle-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e5e7eb;
        border-radius: 50%;
        transition: transform 0.3s ease, background 0.2s ease;
    }
    
    .toggle-icon i {
        color: #6b7280;
        font-size: 0.875rem;
        transition: color 0.2s ease;
    }
    
    .collapsible-header:hover .toggle-icon {
        background: #667eea;
    }
    
    .collapsible-header:hover .toggle-icon i {
        color: white;
    }
    
    .toggle-icon.rotated {
        transform: rotate(180deg);
    }
    
    .collapsible-content {
        overflow: hidden;
        transition: max-height 0.5s ease-in-out, padding 0.3s ease;
        padding: 1.5rem;
        position: relative;
        background: white;
    }
    
    .collapsible-content.collapsed {
        display: none !important;
    }
    
    /* Quick stats in header */
    .header-stats {
        display: flex;
        gap: 1.5rem;
        font-size: 0.85rem;
        color: #6b7280;
    }
    
    .header-stat {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .header-stat-value {
        font-weight: 700;
        color: #1f2937;
    }
    
    /* Compact view toggle */
    .view-controls {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 1000;
        display: flex;
        gap: 0.5rem;
    }
    
    .view-control-btn {
        background: white;
        border: 2px solid #667eea;
        color: #667eea;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        transition: all 0.2s ease;
    }
    
    .view-control-btn:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
    }
    
    .view-control-btn i {
        margin-right: 0.5rem;
    }
    
    /* Keyboard shortcut styling */
    kbd {
        background: #374151;
        color: white;
        padding: 0.125rem 0.375rem;
        border-radius: 3px;
        font-size: 0.75rem;
        font-family: monospace;
        font-weight: 600;
        border: 1px solid #1f2937;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    
    /* Executive Dashboard Links Hover Effects */
    a.summary-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
    }
    
    a.summary-card h3 {
        transition: color 0.2s ease;
    }
    
    a.summary-card:hover h3 {
        color: #667eea;
    }
    
    a.summary-card i {
        transition: transform 0.3s ease;
    }
    
    a.summary-card:hover i {
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block title %}Head of Service Dashboard{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>üè• Head of Service Dashboard</h1>
    <p>Governance Oversight ‚Ä¢ Multi-Home Operations ‚Ä¢ <span id="currentTime">{{ current_time|date:"l, F j, Y \a\t g:i A" }}</span></p>
    <p style="font-size: 0.95rem; opacity: 0.9; margin-top: 0.5rem;">
        <i class="fas fa-info-circle"></i> Strategic oversight across all {{ total_homes }} care homes for Head of Service team governance and compliance monitoring
    </p>
</div>

<!-- ============================================= -->
<!-- GOVERNANCE TEAM ACCESS NOTICE -->
<!-- ============================================= -->
<div class="alert alert-info mb-3" style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 1rem;">
    <div style="display: flex; align-items: start; gap: 1rem;">
        <i class="fas fa-users" style="font-size: 2rem; color: #3b82f6;"></i>
        <div style="flex: 1;">
            <h5 style="margin: 0 0 0.5rem 0; color: #1e40af; font-weight: 600;">Governance Team Access</h5>
            <p style="margin: 0; color: #1e40af; font-size: 0.9rem;">
                This dashboard is accessible to <strong>all Service Managers across all 5 homes</strong> plus HOS and IDI team members for governance review and cross-home oversight. 
                Current access level: <strong>{{ user.role.get_name_display }}</strong> 
                {% if user.assigned_care_home %}from <strong>{{ user.assigned_care_home.display_name }}</strong>{% endif %}
            </p>
            <div style="margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; font-size: 0.85rem;">
                <span id="autoRefreshStatus" style="color: #16a34a;">
                    <i class="fas fa-sync-alt fa-spin"></i> Live data refresh: Active (updates every 60 seconds)
                </span>
                <button type="button" id="toggleAutoRefresh" class="btn btn-sm btn-outline-primary" style="font-size: 0.8rem;">
                    <i class="fas fa-pause"></i> Pause Updates
                </button>
                <span style="color: #6b7280; border-left: 2px solid #cbd5e1; padding-left: 1rem;">
                    <i class="fas fa-keyboard"></i> Shortcuts: <kbd>Alt+E</kbd> Expand <kbd>Alt+C</kbd> Collapse <kbd>Alt+R</kbd> Refresh
                </span>
            </div>
        </div>
    </div>
</div>

<!-- ============================================= -->
<!-- DATE RANGE FILTER -->
<!-- ============================================= -->
<div class="collapsible-section">
    <div class="collapsible-header collapsed">
        <div class="collapsible-title">
            <h2>üîç Filter Controls</h2>
        </div>
        <div class="collapsible-toggle">
            <div class="header-stats">
                <span class="header-stat">
                    <span>{{ start_date|date:"d M Y" }} - {{ end_date|date:"d M Y" }}</span>
                </span>
                <span class="header-stat">
                    <span class="header-stat-value">{{ days_in_range }}</span> days
                </span>
            </div>
            <div class="toggle-icon rotated">
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>
    </div>
    <div class="collapsible-content collapsed">
    <form method="get" action="{% url 'senior_management_dashboard' %}" id="dateFilterForm">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto auto auto; gap: 1rem; align-items: end;">
            <div>
                <label for="start_date" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">
                    <i class="fas fa-calendar-alt"></i> Start Date
                </label>
                <input type="date" 
                       id="start_date" 
                       name="start_date" 
                       value="{{ start_date|date:'Y-m-d' }}"
                       class="form-control"
                       style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
            </div>
            <div>
                <label for="end_date" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">
                    <i class="fas fa-calendar-alt"></i> End Date
                </label>
                <input type="date" 
                       id="end_date" 
                       name="end_date" 
                       value="{{ end_date|date:'Y-m-d' }}"
                       class="form-control"
                       style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
            </div>
            <div>
                <label for="care_home" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">
                    <i class="fas fa-home"></i> Care Home
                </label>
                <select id="care_home" 
                        name="care_home" 
                        class="form-control"
                        style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                    <option value="">All Homes</option>
                    {% for home in all_care_homes %}
                    <option value="{{ home.name }}" {% if selected_home == home.name %}selected{% endif %}>
                        {{ home }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <button type="submit" 
                        style="background: #667eea; color: white; padding: 0.5rem 1.5rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                    <i class="fas fa-filter"></i> Apply
                </button>
            </div>
            <div>
                <a href="{% url 'senior_management_dashboard' %}" 
                   style="display: inline-block; background: #6b7280; color: white; padding: 0.5rem 1.5rem; border-radius: 6px; font-weight: 600; text-decoration: none;">
                    <i class="fas fa-redo"></i> Reset
                </a>
            </div>
            <div>
                <button type="button" 
                        onclick="exportReport()"
                        style="background: #10b981; color: white; padding: 0.5rem 1.5rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
    </form>
    </div>
</div>

<!-- ============================================= -->
<!-- EXECUTIVE DASHBOARDS QUICK ACCESS -->
<!-- ============================================= -->
<div class="collapsible-section">
    <div class="collapsible-header">
        <div class="collapsible-title">
            <h2>üìä Executive Dashboards</h2>
            <span class="section-badge">Strategic Insights</span>
        </div>
        <div class="collapsible-toggle">
            <div class="header-stats">
                <span class="header-stat">
                    <i class="fas fa-chart-line"></i> <span>7 Dashboards</span>
                </span>
            </div>
            <div class="toggle-icon">
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>
    </div>
    <div class="collapsible-content">
        <div class="alert alert-info mb-3" style="background: #e0f2fe; border-left: 4px solid #0ea5e9; padding: 0.75rem;">
            <i class="fas fa-info-circle" style="color: #0284c7;"></i>
            <strong style="color: #0c4a6e;">Strategic Decision Support Tools:</strong> Advanced analytics and predictive dashboards for executive oversight and planning across all care homes.
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
            
            <!-- Budget Dashboard -->
            <a href="{% url 'budget_dashboard' %}" class="summary-card" style="text-decoration: none; transition: all 0.3s; border-left: 4px solid #10b981; cursor: pointer;">
                <div style="display: flex; align-items: start; gap: 1rem;">
                    <div style="font-size: 2rem; color: #10b981;">
                        <i class="fas fa-pound-sign"></i>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #111827; font-size: 1rem;">Budget Dashboard</h3>
                        <div class="subtext" style="margin: 0; font-size: 0.85rem;">Multi-home budget tracking, variance analysis, and spending patterns</div>
                    </div>
                </div>
            </a>
            
            <!-- Early Warning System -->
            <a href="{% url 'early_warning_dashboard' %}" class="summary-card" style="text-decoration: none; transition: all 0.3s; border-left: 4px solid #f59e0b; cursor: pointer;">
                <div style="display: flex; align-items: start; gap: 1rem;">
                    <div style="font-size: 2rem; color: #f59e0b;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #111827; font-size: 1rem;">Early Warning System</h3>
                        <div class="subtext" style="margin: 0; font-size: 0.85rem;">Predictive staffing shortage alerts and proactive planning tools</div>
                    </div>
                </div>
            </a>
            
            <!-- Retention Predictor -->
            <a href="{% url 'retention_predictor_dashboard' %}" class="summary-card" style="text-decoration: none; transition: all 0.3s; border-left: 4px solid #8b5cf6; cursor: pointer;">
                <div style="display: flex; align-items: start; gap: 1rem;">
                    <div style="font-size: 2rem; color: #8b5cf6;">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #111827; font-size: 1rem;">Retention Predictor</h3>
                        <div class="subtext" style="margin: 0; font-size: 0.85rem;">Staff retention analysis and turnover risk predictions</div>
                    </div>
                </div>
            </a>
            
            <!-- Auto-Roster Quality -->
            <a href="{% url 'auto_roster_dashboard' %}" class="summary-card" style="text-decoration: none; transition: all 0.3s; border-left: 4px solid #3b82f6; cursor: pointer;">
                <div style="display: flex; align-items: start; gap: 1rem;">
                    <div style="font-size: 2rem; color: #3b82f6;">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #111827; font-size: 1rem;">Auto-Roster Quality</h3>
                        <div class="subtext" style="margin: 0; font-size: 0.85rem;">Roster optimization metrics and scheduling efficiency analysis</div>
                    </div>
                </div>
            </a>
            
            <!-- Executive Summary Dashboard -->
            <a href="{% url 'executive_summary_dashboard' %}" class="summary-card" style="text-decoration: none; transition: all 0.3s; border-left: 4px solid #10b981; cursor: pointer;">
                <div style="display: flex; align-items: start; gap: 1rem;">
                    <div style="font-size: 2rem; color: #10b981;">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #111827; font-size: 1rem;">Executive Summary Analytics</h3>
                        <div class="subtext" style="margin: 0; font-size: 0.85rem;">12-week trends with day/night breakdown, forecasts, and multi-home comparison</div>
                    </div>
                </div>
            </a>
            
            <!-- CI Performance -->
            <a href="{% url 'ci_performance_dashboard' %}" class="summary-card" style="text-decoration: none; transition: all 0.3s; border-left: 4px solid #ec4899; cursor: pointer;">
                <div style="display: flex; align-items: start; gap: 1rem;">
                    <div style="font-size: 2rem; color: #ec4899;">
                        <i class="fas fa-award"></i>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #111827; font-size: 1rem;">Care Inspectorate Performance</h3>
                        <div class="subtext" style="margin: 0; font-size: 0.85rem;">Regulatory compliance, quality indicators, and peer benchmarking</div>
                    </div>
                </div>
            </a>
            
            <!-- Predictive Budget -->
            <a href="{% url 'predictive_budget_dashboard' %}" class="summary-card" style="text-decoration: none; transition: all 0.3s; border-left: 4px solid #06b6d4; cursor: pointer;">
                <div style="display: flex; align-items: start; gap: 1rem;">
                    <div style="font-size: 2rem; color: #06b6d4;">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #111827; font-size: 1rem;">Predictive Budget Forecast</h3>
                        <div class="subtext" style="margin: 0; font-size: 0.85rem;">ML-powered budget forecasting and scenario planning</div>
                    </div>
                </div>
            </a>
            
            <!-- Training Compliance -->
            <a href="{% url 'training_compliance_dashboard' %}" class="summary-card" style="text-decoration: none; transition: all 0.3s; border-left: 4px solid #ef4444; cursor: pointer;">
                <div style="display: flex; align-items: start; gap: 1rem;">
                    <div style="font-size: 2rem; color: #ef4444;">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #111827; font-size: 1rem;">Training Compliance</h3>
                        <div class="subtext" style="margin: 0; font-size: 0.85rem;">Training matrix, expiry tracking, and compliance management</div>
                    </div>
                </div>
            </a>
            
        </div>
        
        <div class="alert" style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 0.75rem; margin-top: 1rem;">
            <i class="fas fa-lightbulb" style="color: #d97706;"></i>
            <strong style="color: #78350f;">Pro Tip:</strong> <span style="color: #78350f;">Click any dashboard above to access advanced analytics and predictive insights for strategic planning.</span>
        </div>
    </div>
</div>

<!-- ============================================= -->
<!-- SECTION 1: ORGANIZATION SUMMARY -->
<!-- ============================================= -->
<div class="summary-cards">
    <div class="summary-card">
        <h3>Overall Occupancy</h3>
        <div class="value">{{ overall_occupancy_rate|floatformat:1 }}%</div>
        <div class="subtext">{{ total_occupancy }} / {{ total_capacity }} beds</div>
        <div class="progress-bar">
            <div class="progress-fill {% if overall_occupancy_rate >= 90 %}good{% elif overall_occupancy_rate >= 75 %}warning{% else %}critical{% endif %}" 
                 style="width: {{ overall_occupancy_rate }}%"></div>
        </div>
    </div>
    
    <div class="summary-card {% if overall_utilization < 80 %}good{% elif overall_utilization < 100 %}warning{% else %}critical{% endif %}">
        <h3>Budget Utilization</h3>
        <div class="value">{{ overall_utilization|floatformat:1 }}%</div>
        <div class="subtext">¬£{{ total_spend|floatformat:0 }} / ¬£{{ total_budget|floatformat:0 }}</div>
        <div class="progress-bar">
            <div class="progress-fill {% if overall_utilization < 80 %}good{% elif overall_utilization < 100 %}warning{% else %}critical{% endif %}" 
                 style="width: {% if overall_utilization > 100 %}100{% else %}{{ overall_utilization }}{% endif %}%"></div>
        </div>
    </div>
    
    <div class="summary-card {% if critical_alerts|length < 5 %}good{% elif critical_alerts|length < 15 %}warning{% else %}critical{% endif %}">
        <h3>Open Alerts</h3>
        <div class="value">{{ critical_alerts|length }}</div>
        <div class="subtext">Requiring attention</div>
    </div>
    
    <div class="summary-card {% if unfilled_covers < 10 %}good{% elif unfilled_covers < 25 %}warning{% else %}critical{% endif %}">
        <h3>Unfilled Cover Requests</h3>
        <div class="value">{{ unfilled_covers }}</div>
        <div class="subtext">Active requests</div>
    </div>
</div>

<!-- ============================================= -->
<!-- SECTION 1.2: EXECUTIVE CHARTS -->
<!-- ============================================= -->
<div class="section" style="margin-bottom: 2rem;">
    <div class="section-header">
        <h2><i class="fas fa-chart-bar"></i> Executive Analytics</h2>
        <span style="font-size: 0.9rem; color: #6b7280;">Organization-wide insights and trends</span>
    </div>
    
    <!-- Row 1: Multi-Home Staffing + Budget vs Actual -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header" style="background: #0066FF; color: white;">
                    <i class="fas fa-users"></i> Multi-Home Staffing Overview (7-Day Trend)
                </div>
                <div class="card-body" style="position: relative; height: 350px; padding: 1rem;">
                    <canvas id="multiHomeStaffingChart" style="width: 100% !important; height: 100% !important;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header" style="background: #00C853; color: white;">
                    <i class="fas fa-pound-sign"></i> Budget vs Actual (This Month)
                </div>
                <div class="card-body" style="position: relative; height: 350px; padding: 1rem;">
                    <canvas id="budgetActualChart" style="width: 100% !important; height: 100% !important;"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Row 2: Overtime Trend + Staffing Level Gauge -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header" style="background: #F59E0B; color: white;">
                    <i class="fas fa-clock"></i> Overtime Hours Trend (Last 30 Days)
                </div>
                <div class="card-body" style="position: relative; height: 350px; padding: 1rem;">
                    <canvas id="overtimeTrendChart" style="width: 100% !important; height: 100% !important;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header" style="background: #10B981; color: white;">
                    <i class="fas fa-gauge-high"></i> Current Staffing Level
                </div>
                <div class="card-body" style="position: relative; height: 350px; padding: 1rem;">
                    <canvas id="staffingGaugeChart" style="width: 100% !important; height: 100% !important;"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Row 3: Compliance Score Trends -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header" style="background: var(--accent-color, #FF6F00); color: white;">
                    <i class="fas fa-clipboard-check"></i> Compliance Score Trends by Home
                </div>
                <div class="card-body" style="position: relative; height: 400px; padding: 1rem;">
                    <canvas id="complianceScoreChart" style="width: 100% !important; height: 100% !important;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Staffing Gap Details -->
<div class="modal fade" id="staffingGapModal" tabindex="-1" aria-labelledby="staffingGapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: #10B981; color: white;">
                <h5 class="modal-title" id="staffingGapModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Staffing Gaps Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="staffingGapContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading gap details...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="exportGapDetailsBtn">
                    <i class="fas fa-download"></i> Export CSV
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Multi-Home Staffing Detail -->
<div class="modal fade" id="staffingDetailModal" tabindex="-1" aria-labelledby="staffingDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: #3B82F6; color: white;">
                <h5 class="modal-title" id="staffingDetailModalLabel">
                    <i class="fas fa-users"></i> Multi-Home Staffing Detail
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="staffingDetailContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading staffing details...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="exportStaffingDetailBtn">
                    <i class="fas fa-download"></i> Export CSV
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Budget Breakdown -->
<div class="modal fade" id="budgetBreakdownModal" tabindex="-1" aria-labelledby="budgetBreakdownModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: #F59E0B; color: white;">
                <h5 class="modal-title" id="budgetBreakdownModalLabel">
                    <i class="fas fa-pound-sign"></i> Budget Breakdown
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="budgetBreakdownContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading budget details...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="exportBudgetBreakdownBtn">
                    <i class="fas fa-download"></i> Export CSV
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Overtime Detail -->
<div class="modal fade" id="overtimeDetailModal" tabindex="-1" aria-labelledby="overtimeDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: #EF4444; color: white;">
                <h5 class="modal-title" id="overtimeDetailModalLabel">
                    <i class="fas fa-clock"></i> Overtime Breakdown
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="overtimeDetailContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading overtime details...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="exportOvertimeDetailBtn">
                    <i class="fas fa-download"></i> Export CSV
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Compliance Actions -->
<div class="modal fade" id="complianceActionsModal" tabindex="-1" aria-labelledby="complianceActionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: #8B5CF6; color: white;">
                <h5 class="modal-title" id="complianceActionsModalLabel">
                    <i class="fas fa-tasks"></i> Compliance Improvement Actions
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="complianceActionsContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-purple" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading compliance actions...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-purple" id="exportComplianceActionsBtn" style="background: #8B5CF6; color: white;">
                    <i class="fas fa-download"></i> Export CSV
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================= -->
<!-- SECTION 1.5: CITYWIDE SUMMARY -->
<!-- ============================================= -->
<div class="collapsible-section">
    <div class="collapsible-header collapsed">
        <div class="collapsible-title">
            <h2>üìä Citywide Summary</h2>
            <span class="section-badge">{{ total_homes }} Homes</span>
        </div>
        <div class="collapsible-toggle">
            <div class="header-stats">
                <span class="header-stat">
                    <span>{{ start_date|date:"d M" }} - {{ end_date|date:"d M Y" }}</span>
                </span>
            </div>
            <div class="toggle-icon rotated">
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>
    </div>
    <div class="collapsible-content collapsed">
    
    <!-- DAY SHIFT SUMMARY -->
    <h3 class="mb-3" style="color: #667eea; font-weight: 600;">
        <i class="fas fa-sun"></i> Day Shift Coverage
    </h3>
    
    <div class="table-responsive mb-4">
        <table class="table table-bordered table-sm" style="font-size: 0.85rem;">
            <thead style="background: #667eea; color: white;">
                <tr>
                    <th rowspan="2" style="vertical-align: middle; width: 150px;">Care Home</th>
                    <th colspan="2" style="text-align: center; border-right: 2px solid white;">Requirements</th>
                    <th colspan="7" style="text-align: center;">
                        {{ start_date|date:"d M" }} - {{ end_date|date:"d M Y" }}
                    </th>
                </tr>
                <tr>
                    <th style="width: 80px;">Minimum</th>
                    <th style="width: 80px; border-right: 2px solid white;">Ideal</th>
                    {% for date in week_dates %}
                    <th style="text-align: center; width: 90px;">
                        <div>{{ date|date:"D" }}</div>
                        <div style="font-size: 0.9em;">{{ date|date:"d" }}</div>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for home_data in citywide_day_summary %}
                <tr style="background: #e0e7ff;">
                    <td colspan="{{ week_dates|length|add:3 }}" style="font-weight: 600; color: #667eea; padding: 8px;">
                        {{ home_data.home }} Day Shift
                    </td>
                </tr>
                <tr>
                    <td style="padding-left: 20px; background: #fef3c7;">SSCW</td>
                    <td style="text-align: center; background: #fef3c7;">{{ home_data.sscw_min }}</td>
                    <td style="text-align: center; background: #fef3c7; border-right: 2px solid #ddd;">{{ home_data.sscw_ideal }}</td>
                    {% for day in home_data.days %}
                    <td style="text-align: center; {% if day.seniors >= home_data.sscw_min %}background: #d1fae5;{% else %}background: #fee2e2;{% endif %}">
                        {{ day.seniors|default:"0" }}
                    </td>
                    {% endfor %}
                </tr>
                <tr>
                    <td style="padding-left: 20px; background: #fef3c7;">Staff</td>
                    <td style="text-align: center; background: #fef3c7;">{{ home_data.min_required }}</td>
                    <td style="text-align: center; background: #fef3c7; border-right: 2px solid #ddd;">{{ home_data.ideal_required }}</td>
                    {% for day in home_data.days %}
                    <td style="text-align: center; {% if day.staff >= home_data.min_required %}background: #d1fae5;{% else %}background: #fee2e2;{% endif %}">
                        {{ day.staff|default:"0" }}
                    </td>
                    {% endfor %}
                </tr>
                <tr>
                    <td style="padding-left: 20px; background: #fef3c7;">Leave Granted</td>
                    <td style="text-align: center; background: #fef3c7;">0</td>
                    <td style="text-align: center; background: #fef3c7; border-right: 2px solid #ddd;">4</td>
                    {% for day in home_data.days %}
                    <td style="text-align: center; background: #fef3c7;">{{ day.leave|default:"0" }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td style="padding-left: 20px; background: #fef3c7;">Agency Used</td>
                    <td style="text-align: center; background: #fef3c7;">0</td>
                    <td style="text-align: center; background: #fef3c7; border-right: 2px solid #ddd;">0</td>
                    {% for day in home_data.days %}
                    <td style="text-align: center; background: #fef3c7;">{{ day.agency|default:"0" }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td style="padding-left: 20px; background: #fef3c7;">OverTime Used</td>
                    <td style="text-align: center; background: #fef3c7;">0</td>
                    <td style="text-align: center; background: #fef3c7; border-right: 2px solid #ddd;">0</td>
                    {% for day in home_data.days %}
                    <td style="text-align: center; background: #fef3c7;">{{ day.overtime|default:"0" }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td style="padding-left: 20px; background: #fef3c7; border-bottom: 2px solid #ddd;">Absent today</td>
                    <td style="text-align: center; background: #fef3c7; border-bottom: 2px solid #ddd;">0</td>
                    <td style="text-align: center; background: #fef3c7; border-right: 2px solid #ddd; border-bottom: 2px solid #ddd;">0</td>
                    {% for day in home_data.days %}
                    <td style="text-align: center; background: #fef3c7; border-bottom: 2px solid #ddd;">{{ day.absent|default:"0" }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- NIGHT SHIFT SUMMARY -->
    <h3 class="mb-3 mt-4" style="color: #4c1d95; font-weight: 600;">
        <i class="fas fa-moon"></i> Night Shift Coverage
    </h3>
    
    <div class="table-responsive">
        <table class="table table-bordered table-sm" style="font-size: 0.85rem;">
            <thead style="background: #4c1d95; color: white;">
                <tr>
                    <th rowspan="2" style="vertical-align: middle; width: 150px;">Care Home</th>
                    <th colspan="2" style="text-align: center; border-right: 2px solid white;">Requirements</th>
                    <th colspan="7" style="text-align: center;">
                        {{ start_date|date:"d M" }} - {{ end_date|date:"d M Y" }}
                    </th>
                </tr>
                <tr>
                    <th style="width: 80px;">Minimum</th>
                    <th style="width: 80px; border-right: 2px solid white;">Ideal</th>
                    {% for date in week_dates %}
                    <th style="text-align: center; width: 90px;">
                        <div>{{ date|date:"D" }}</div>
                        <div style="font-size: 0.9em;">{{ date|date:"d" }}</div>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for home_data in citywide_night_summary %}
                <tr style="background: #ddd6fe;">
                    <td colspan="{{ week_dates|length|add:3 }}" style="font-weight: 600; color: #4c1d95; padding: 8px;">
                        {{ home_data.home}} Night Shift
                    </td>
                </tr>
                <tr>
                    <td style="padding-left: 20px; background: #fef3c7;">SSCWN</td>
                    <td style="text-align: center; background: #fef3c7;">{{ home_data.sscwn_min }}</td>
                    <td style="text-align: center; background: #fef3c7; border-right: 2px solid #ddd;">{{ home_data.sscwn_ideal }}</td>
                    {% for day in home_data.days %}
                    <td style="text-align: center; {% if day.seniors >= home_data.sscwn_min %}background: #d1fae5;{% else %}background: #fee2e2;{% endif %}">
                        {{ day.seniors|default:"0" }}
                    </td>
                    {% endfor %}
                </tr>
                <tr>
                    <td style="padding-left: 20px; background: #fef3c7;">Staff</td>
                    <td style="text-align: center; background: #fef3c7;">{{ home_data.min_required }}</td>
                    <td style="text-align: center; background: #fef3c7; border-right: 2px solid #ddd;">{{ home_data.ideal_required }}</td>
                    {% for day in home_data.days %}
                    <td style="text-align: center; {% if day.staff >= home_data.min_required %}background: #d1fae5;{% else %}background: #fee2e2;{% endif %}">
                        {{ day.staff|default:"0" }}
                    </td>
                    {% endfor %}
                </tr>
                <tr>
                    <td style="padding-left: 20px; background: #fef3c7;">Leave Granted</td>
                    <td style="text-align: center; background: #fef3c7;">0</td>
                    <td style="text-align: center; background: #fef3c7; border-right: 2px solid #ddd;">4</td>
                    {% for day in home_data.days %}
                    <td style="text-align: center; background: #fef3c7;">{{ day.leave|default:"0" }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td style="padding-left: 20px; background: #fef3c7;">Agency Used</td>
                    <td style="text-align: center; background: #fef3c7;">0</td>
                    <td style="text-align: center; background: #fef3c7; border-right: 2px solid #ddd;">0</td>
                    {% for day in home_data.days %}
                    <td style="text-align: center; background: #fef3c7;">{{ day.agency|default:"0" }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td style="padding-left: 20px; background: #fef3c7;">OverTime Used</td>
                    <td style="text-align: center; background: #fef3c7;">0</td>
                    <td style="text-align: center; background: #fef3c7; border-right: 2px solid #ddd;">0</td>
                    {% for day in home_data.days %}
                    <td style="text-align: center; background: #fef3c7;">{{ day.overtime|default:"0" }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td style="padding-left: 20px; background: #fef3c7; border-bottom: 2px solid #ddd;">Absent today</td>
                    <td style="text-align: center; background: #fef3c7; border-bottom: 2px solid #ddd;">0</td>
                    <td style="text-align: center; background: #fef3c7; border-right: 2px solid #ddd; border-bottom: 2px solid #ddd;">0</td>
                    {% for day in home_data.days %}
                    <td style="text-align: center; background: #fef3c7; border-bottom: 2px solid #ddd;">{{ day.absent|default:"0" }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    </div>
</div>

<!-- ============================================= -->
<!-- SECTION 2: HOME OVERVIEW -->
<!-- ============================================= -->
<div class="collapsible-section">
    <div class="collapsible-header collapsed">
        <div class="collapsible-title">
            <h2>üè† Care Home Overview</h2>
            <span class="section-badge success">{{ home_overview|length }} Active</span>
        </div>
        <div class="collapsible-toggle">
            <span class="text-muted">Occupancy & Capacity</span>
            <div class="toggle-icon rotated">
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>
    </div>
    <div class="collapsible-content collapsed">
    
    {% for home in home_overview %}
    <div class="home-card">
        <div class="home-card-header">
            <h3>{{ home.display_name }}</h3>
            <span class="status-badge {% if home.occupancy_rate >= 90 %}good{% elif home.occupancy_rate >= 75 %}warning{% else %}critical{% endif %}">
                {{ home.occupancy_rate|floatformat:1 }}% Occupancy
            </span>
        </div>
        
        <div class="metric-row">
            <div class="metric">
                <span class="metric-label">Capacity</span>
                <span class="metric-value">{{ home.occupancy }} / {{ home.capacity }} beds</span>
            </div>
            <div class="metric">
                <span class="metric-label">Units</span>
                <span class="metric-value">{{ home.units }} active</span>
            </div>
            <div class="metric">
                <span class="metric-label">Location</span>
                <span class="metric-value" style="font-size: 0.9rem;">{{ home.location }}</span>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill {% if home.occupancy_rate >= 90 %}good{% elif home.occupancy_rate >= 75 %}warning{% else %}critical{% endif %}" 
                 style="width: {{ home.occupancy_rate }}%"></div>
        </div>
    </div>
    {% endfor %}
    </div>
</div>

<!-- ============================================= -->
<!-- SECTION 3: TODAY'S STAFFING -->
<!-- ============================================= -->
<div class="collapsible-section">
    <div class="collapsible-header">
        <div class="collapsible-title">
            <h2>üë• Today's Staffing Levels</h2>
        </div>
        <div class="collapsible-toggle">
            <span style="color: #6b7280; font-size: 0.9rem;">{{ today|date:"l, F j" }}</span>
            <div class="toggle-icon">
                <i class="fas fa-chevron-down"></i>
            </div>
        </div>
    </div>
    <div class="collapsible-content">
    
    <table>
        <thead>
            <tr>
                <th>Care Home</th>
                <th>Day Shifts</th>
                <th>Day Coverage</th>
                <th>Night Shifts</th>
                <th>Night Coverage</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for staff in staffing_today %}
            <tr>
                <td><strong>{{ staff.home }}</strong></td>
                <td>{{ staff.day_actual }} / {{ staff.day_required }}</td>
                <td>
                    <span style="font-weight: 600; color: {% if staff.day_coverage >= 100 %}#10b981{% elif staff.day_coverage >= 80 %}#f59e0b{% else %}#ef4444{% endif %}">
                        {{ staff.day_coverage|floatformat:0 }}%
                    </span>
                </td>
                <td>{{ staff.night_actual }} / {{ staff.night_required }}</td>
                <td>
                    <span style="font-weight: 600; color: {% if staff.night_coverage >= 100 %}#10b981{% elif staff.night_coverage >= 80 %}#f59e0b{% else %}#ef4444{% endif %}">
                        {{ staff.night_coverage|floatformat:0 }}%
                    </span>
                </td>
                <td>
                    <span class="status-badge {{ staff.status }}">
                        {% if staff.status == 'good' %}‚úì Fully Staffed
                        {% elif staff.status == 'warning' %}‚ö† Monitoring
                        {% else %}‚ö† Critical{% endif %}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>

<!-- ============================================= -->
<!-- SECTION 4: FISCAL MONITORING -->
<!-- ============================================= -->
<div class="collapsible-section">
    <div class="collapsible-header collapsed">
        <div class="collapsible-title">
            <h2>üí∞ Fiscal Monitoring</h2>
            <span class="section-badge {% if overall_utilization < 80 %}success{% elif overall_utilization < 100 %}warning{% else %}alert{% endif %}">{{ overall_utilization|floatformat:0 }}% Utilized</span>
        </div>
        <div class="collapsible-toggle">
            <div class="header-stats">
                <span class="header-stat">{{ current_month }}</span>
                <span class="header-stat"><span class="header-stat-value">¬£{{ total_spend|floatformat:0 }}</span> Total</span>
            </div>
            <div class="toggle-icon rotated">
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>
    </div>
    <div class="collapsible-content collapsed">
    
    <table>
        <thead>
            <tr>
                <th>Care Home</th>
                <th>Agency Spend</th>
                <th>Agency %</th>
                <th>OT Spend</th>
                <th>OT %</th>
                <th>Total Spend</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for fiscal in fiscal_summary %}
            <tr>
                <td><strong>{{ fiscal.home }}</strong></td>
                <td class="currency">
                    ¬£{{ fiscal.agency_spend|floatformat:0 }}<br>
                    <small style="color: #6b7280;">/ ¬£{{ fiscal.agency_budget|floatformat:0 }}</small>
                </td>
                <td>
                    <span style="font-weight: 600; color: {% if fiscal.agency_utilization < 80 %}#10b981{% elif fiscal.agency_utilization < 100 %}#f59e0b{% else %}#ef4444{% endif %}">
                        {{ fiscal.agency_utilization|floatformat:0 }}%
                    </span>
                </td>
                <td class="currency">
                    ¬£{{ fiscal.ot_spend|floatformat:0 }}<br>
                    <small style="color: #6b7280;">/ ¬£{{ fiscal.ot_budget|floatformat:0 }}</small>
                </td>
                <td>
                    <span style="font-weight: 600; color: {% if fiscal.ot_utilization < 80 %}#10b981{% elif fiscal.ot_utilization < 100 %}#f59e0b{% else %}#ef4444{% endif %}">
                        {{ fiscal.ot_utilization|floatformat:0 }}%
                    </span>
                </td>
                <td class="currency">
                    <strong>¬£{{ fiscal.total_spend|floatformat:0 }}</strong><br>
                    <small style="color: #6b7280;">/ ¬£{{ fiscal.total_budget|floatformat:0 }}</small>
                </td>
                <td>
                    <span class="status-badge {{ fiscal.fiscal_status }}">
                        {% if fiscal.fiscal_status == 'good' %}‚úì On Budget
                        {% elif fiscal.fiscal_status == 'warning' %}‚ö† Watch
                        {% else %}üö® Over Budget{% endif %}
                    </span>
                </td>
            </tr>
            {% endfor %}
            <tr style="font-weight: 600; background: #f9fafb;">
                <td>TOTAL</td>
                <td class="currency">¬£{{ total_agency_spend|floatformat:0 }}</td>
                <td></td>
                <td class="currency">¬£{{ total_ot_spend|floatformat:0 }}</td>
                <td></td>
                <td class="currency">¬£{{ total_spend|floatformat:0 }}</td>
                <td></td>
            </tr>
        </tbody>
    </table>
    </div>
</div>

<!-- ============================================= -->
<!-- SECTION 5: CRITICAL ALERTS -->
<!-- ============================================= -->
<div class="collapsible-section">
    <div class="collapsible-header">
        <div class="collapsible-title">
            <h2>üö® Critical Staffing Alerts</h2>
            {% if critical_alerts|length > 0 %}
            <span class="section-badge alert">{{ critical_alerts|length }}</span>
            {% else %}
            <span class="section-badge success">0 Alerts</span>
            {% endif %}
        </div>
        <div class="collapsible-toggle">
            <span style="color: #6b7280; font-size: 0.9rem;">{% if critical_alerts %}Oldest first{% else %}All Clear{% endif %}</span>
            <div class="toggle-icon">
                <i class="fas fa-chevron-down"></i>
            </div>
        </div>
    </div>
    <div class="collapsible-content">
    
    {% if critical_alerts %}
        {% for alert in critical_alerts|slice:":10" %}
        <div class="alert-item {% if alert.severity == 'HIGH' or alert.severity == 'CRITICAL' %}critical{% endif %}">
            <div class="alert-item-header">
                <strong>{{ alert.home }} - {{ alert.unit }}</strong>
                <span class="age">{{ alert.age_hours|floatformat:0 }} hours old</span>
            </div>
            <div style="color: #6b7280; font-size: 0.9rem;">
                {{ alert.date|date:"D, M j, Y" }} ‚Ä¢ Severity: {{ alert.severity }}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <div><i>‚úì</i></div>
            <p>No critical alerts at this time</p>
        </div>
    {% endif %}
    </div>
</div>

<!-- ============================================= -->
<!-- SECTION 6: PENDING MANAGEMENT ACTIONS -->
<!-- ============================================= -->
<div class="collapsible-section">
    <div class="collapsible-header collapsed">
        <div class="collapsible-title">
            <h2>üìã Pending Management Actions</h2>
            <span class="section-badge {% if pending_by_home|length > 5 or unfilled_covers > 10 %}warning{% else %}success{% endif %}">{{ pending_by_home|length|add:unfilled_covers }} Items</span>
        </div>
        <div class="collapsible-toggle">
            <div class="header-stats">
                <span class="header-stat"><span class="header-stat-value">{{ pending_by_home|length }}</span> Leave</span>
                <span class="header-stat"><span class="header-stat-value">{{ unfilled_covers }}</span> Cover</span>
            </div>
            <div class="toggle-icon rotated">
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>
    </div>
    <div class="collapsible-content collapsed">
    
    <div class="metric-row" style="margin-bottom: 1.5rem;">
        <div class="metric">
            <span class="metric-label">Manual Review Leave Requests</span>
            <span class="metric-value" style="color: {% if pending_by_home|length > 5 %}#ef4444{% elif pending_by_home|length > 2 %}#f59e0b{% else %}#10b981{% endif %}">
                {{ pending_by_home|length }}
            </span>
        </div>
        <div class="metric">
            <span class="metric-label">Pending Reallocations</span>
            <span class="metric-value" style="color: {% if pending_reallocations > 10 %}#ef4444{% elif pending_reallocations > 5 %}#f59e0b{% else %}#10b981{% endif %}">
                {{ pending_reallocations }}
            </span>
        </div>
        <div class="metric">
            <span class="metric-label">Unfilled Cover Requests</span>
            <span class="metric-value" style="color: {% if unfilled_covers > 25 %}#ef4444{% elif unfilled_covers > 10 %}#f59e0b{% else %}#10b981{% endif %}">
                {{ unfilled_covers }}
            </span>
        </div>
    </div>
    
    {% if pending_by_home %}
    <h4 style="margin: 1rem 0 0.5rem 0; color: #374151;">Leave Requests by Home</h4>
    {% for home, requests in pending_by_home.items %}
        <div style="background: #f9fafb; padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 4px;">
            <strong>{{ home }}</strong>: {{ requests|length }} request{{ requests|length|pluralize }}
        </div>
    {% endfor %}
    {% endif %}
    </div>
</div>

<!-- ============================================= -->
<!-- SECTION 7: QUALITY METRICS (30 Days) -->
<!-- ============================================= -->
<div class="collapsible-section">
    <div class="collapsible-header collapsed">
        <div class="collapsible-title">
            <h2>üìä Quality Metrics</h2>
            <span class="section-badge">30 Days</span>
        </div>
        <div class="collapsible-toggle">
            <span class="text-muted">Performance Overview</span>
            <div class="toggle-icon rotated">
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>
    </div>
    <div class="collapsible-content collapsed">
    
    <table>
        <thead>
            <tr>
                <th>Care Home</th>
                <th>Total Shifts</th>
                <th>Agency Usage Rate</th>
                <th>Active Staff</th>
                <th>Quality Score</th>
            </tr>
        </thead>
        <tbody>
            {% for metric in quality_metrics %}
            <tr>
                <td><strong>{{ metric.home }}</strong></td>
                <td>{{ metric.shifts_30d }}</td>
                <td>
                    <span style="font-weight: 600; color: {% if metric.agency_rate < 15 %}#10b981{% elif metric.agency_rate < 30 %}#f59e0b{% else %}#ef4444{% endif %}">
                        {{ metric.agency_rate|floatformat:1 }}%
                    </span>
                </td>
                <td>{{ metric.staff_count }}</td>
                <td>
                    <span style="font-weight: 600; color: {% if metric.quality_score > 85 %}#10b981{% elif metric.quality_score > 70 %}#f59e0b{% else %}#ef4444{% endif %}">
                        {{ metric.quality_score|floatformat:0 }}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>

<!-- ============================================= -->
<!-- SECTION 7.5: TRAINING COMPLIANCE -->
<!-- ============================================= -->
<div class="collapsible-section">
    <div class="collapsible-header collapsed">
        <div class="collapsible-title">
            <h2>üéì Training Compliance</h2>
            <span class="section-badge">Mandatory Training</span>
        </div>
        <div class="collapsible-toggle">
            <span class="text-muted">11 Mandatory Courses</span>
            <div class="toggle-icon rotated">
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>
    </div>
    <div class="collapsible-content collapsed">
    
    {% if training_compliance_by_home %}
    <div style="margin-bottom: 1.5rem;">
        <a href="{% url 'training_compliance_dashboard' %}" class="btn" style="background: #667eea; color: white;">
            <i class="fas fa-chart-bar"></i> View Full Training Dashboard
        </a>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Care Home</th>
                <th class="text-center">Staff Count</th>
                <th class="text-center">Required Records</th>
                <th class="text-center">Compliant</th>
                <th class="text-center">Compliance %</th>
                <th class="text-center">Status</th>
            </tr>
        </thead>
        <tbody>
            {% for compliance in training_compliance_by_home %}
            <tr>
                <td><strong>{{ compliance.home.name|title }}</strong></td>
                <td class="text-center">{{ compliance.total_staff }}</td>
                <td class="text-center">{{ compliance.total_required }}</td>
                <td class="text-center">
                    <span style="font-weight: 600; color: #10b981;">{{ compliance.compliant }}</span>
                </td>
                <td class="text-center">
                    <span style="font-weight: 700; font-size: 1.1em; color: {% if compliance.percentage >= 90 %}#10b981{% elif compliance.percentage >= 75 %}#f59e0b{% else %}#ef4444{% endif %}">
                        {{ compliance.percentage }}%
                    </span>
                </td>
                <td class="text-center">
                    {% if compliance.percentage >= 90 %}
                        <span style="color: #10b981;">‚úì Excellent</span>
                    {% elif compliance.percentage >= 75 %}
                        <span style="color: #f59e0b;">‚ö† Needs Attention</span>
                    {% else %}
                        <span style="color: #ef4444;">‚úó Critical</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div style="margin-top: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 6px;">
        <div style="font-size: 0.875rem; color: #6b7280;">
            <strong>Compliance Targets:</strong><br>
            üü¢ Excellent: ‚â•90% | üü° Good: 75-89% | üî¥ Critical: <75%<br>
            <strong>Note:</strong> Each staff member requires 11 mandatory training courses to be compliant.
        </div>
    </div>
    {% else %}
    <div style="text-align: center; padding: 2rem; color: #6b7280;">
        <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
        <p>No training data available. Training courses and records need to be populated.</p>
    </div>
    {% endif %}
    </div>
</div>

<!-- ============================================= -->
<!-- SECTION 8: CARE PLAN COMPLIANCE - By Home -->
<!-- ============================================= -->
<div class="collapsible-section">
    <div class="collapsible-header collapsed">
        <div class="collapsible-title">
            <h2>üìã Care Plan Compliance</h2>
        </div>
        <div class="collapsible-toggle">
            <span style="color: #6b7280; font-size: 0.875rem;">Review Status</span>
            <div class="toggle-icon rotated">
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>
    </div>
    <div class="collapsible-content collapsed">
    
    <table>
        <thead>
            <tr>
                <th>Care Home</th>
                <th>Total Residents</th>
                <th>Completed</th>
                <th>Overdue</th>
                <th>Due Soon</th>
                <th>Compliance Rate</th>
                <th>Overdue Rate</th>
            </tr>
        </thead>
        <tbody>
            {% for home in care_plan_compliance %}
            <tr>
                <td><strong>{{ home.home }}</strong></td>
                <td>{{ home.total_residents }}</td>
                <td>
                    <span style="color: #10b981; font-weight: 600;">
                        {{ home.completed }}
                    </span>
                </td>
                <td>
                    <span style="font-weight: 600; {% if home.overdue > 0 %}color: #ef4444;{% else %}color: #6b7280;{% endif %}">
                        {{ home.overdue }}
                    </span>
                </td>
                <td>
                    <span style="{% if home.due_soon > 0 %}color: #f59e0b; font-weight: 600;{% endif %}">
                        {{ home.due_soon }}
                    </span>
                </td>
                <td>
                    <span style="font-weight: 600; color: {% if home.compliance_rate >= 90 %}#10b981{% elif home.compliance_rate >= 75 %}#f59e0b{% else %}#ef4444{% endif %}">
                        {{ home.compliance_rate|floatformat:0 }}%
                    </span>
                </td>
                <td>
                    <span style="font-weight: 600; color: {% if home.overdue_rate == 0 %}#10b981{% elif home.overdue_rate < 10 %}#f59e0b{% else %}#ef4444{% endif %}">
                        {{ home.overdue_rate|floatformat:0 }}%
                    </span>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="text-align: center; color: #6b7280;">No care plan data available</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>

<!-- ============================================= -->
<!-- SECTION 9: STAFF VACANCIES TRACKING -->
<!-- ============================================= -->
<div class="collapsible-section">
    <div class="collapsible-header collapsed">
        <div class="collapsible-title">
            <h2>üë• Staff Vacancies & Leavers</h2>
            {% if total_vacancies > 0 or total_upcoming_leavers > 0 %}
            <span class="section-badge alert">{{ total_vacancies|add:total_upcoming_leavers }} Total</span>
            {% else %}
            <span class="section-badge success">Fully Staffed</span>
            {% endif %}
        </div>
        <div class="collapsible-toggle">
            <div class="header-stats">
                <span class="header-stat"><span class="header-stat-value" style="color: #ef4444;">{{ total_vacancies }}</span> Vacant</span>
                <span class="header-stat"><span class="header-stat-value" style="color: #f59e0b;">{{ total_upcoming_leavers }}</span> Upcoming</span>
            </div>
            <div class="toggle-icon rotated">
                <i class="fas fa-chevron-up"></i>
            </div>
        </div>
    </div>
    <div class="collapsible-content collapsed">
    
    {% if vacancies_by_home %}
    <!-- Summary by Home -->
    <div class="metric-row" style="margin-bottom: 1.5rem;">
        {% for home_name, summary in vacancies_by_home.items %}
        <div class="home-card">
            <h4 style="margin: 0 0 0.75rem 0;">{{ home_name }}</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.875rem;">
                <div>
                    <strong>Vacant:</strong> 
                    <span style="color: #ef4444; font-weight: 600;">{{ summary.vacant_now }}</span>
                </div>
                <div>
                    <strong>Upcoming:</strong> 
                    <span style="color: #f59e0b; font-weight: 600;">{{ summary.upcoming_leavers }}</span>
                </div>
                <div>
                    <strong>Total Hours/Week:</strong> {{ summary.total_hours_vacant }}
                </div>
                <div>
                    <strong>Roles:</strong> {{ summary.roles|length }}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Detailed Vacancy List -->
    <table>
        <thead>
            <tr>
                <th>Status</th>
                <th>Care Home</th>
                <th>Staff Name</th>
                <th>Role</th>
                <th>Unit</th>
                <th>End Date</th>
                <th>Days Vacant</th>
                <th>Hours/Week</th>
                <th>Severity</th>
            </tr>
        </thead>
        <tbody>
            {% for vacancy in vacancies %}
            <tr style="{% if vacancy.status == 'VACANT' %}background: #fee2e2;{% endif %}">
                <td>
                    <span class="status-badge {% if vacancy.status == 'VACANT' %}critical{% else %}warning{% endif %}" style="font-size: 0.7rem;">
                        {{ vacancy.status }}
                    </span>
                </td>
                <td><strong>{{ vacancy.home }}</strong></td>
                <td>
                    {{ vacancy.staff_name }}
                    <div style="font-size: 0.75rem; color: #6b7280;">SAP: {{ vacancy.sap }}</div>
                </td>
                <td>{{ vacancy.role }}</td>
                <td>{{ vacancy.unit }}</td>
                <td>{{ vacancy.end_date|date:"d M Y" }}</td>
                <td>
                    {% if vacancy.status == 'VACANT' %}
                        <span style="font-weight: 600; color: {% if vacancy.days_vacant > 30 %}#ef4444{% elif vacancy.days_vacant > 14 %}#f59e0b{% else %}#10b981{% endif %}">
                            {{ vacancy.days_vacant }} days
                        </span>
                    {% else %}
                        <span style="color: #6b7280;">‚Äî</span>
                    {% endif %}
                </td>
                <td>{{ vacancy.hours_per_week }} hrs</td>
                <td>
                    <span class="status-badge {% if vacancy.severity == 'HIGH' %}critical{% elif vacancy.severity == 'MEDIUM' %}warning{% else %}good{% endif %}" style="font-size: 0.7rem;">
                        {{ vacancy.severity }}
                    </span>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" style="text-align: center; color: #6b7280; padding: 2rem;">
                    ‚úì No current vacancies or upcoming leavers
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 2rem; color: #6b7280;">
        <p style="font-size: 1.125rem; margin: 0;">‚úì No current vacancies or upcoming leavers</p>
        <p style="font-size: 0.875rem; margin: 0.5rem 0 0 0;">All homes are fully staffed</p>
    </div>
    {% endif %}
    </div>
</div>

<!-- View Controls -->
<div class="view-controls">
    <button class="view-control-btn" id="expandAllBtn">
        <i class="fas fa-expand-alt"></i> Expand All
    </button>
    <button class="view-control-btn" id="collapseAllBtn">
        <i class="fas fa-compress-alt"></i> Collapse All
    </button>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Collapsible Section Toggle
function toggleSection(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.toggle-icon i');
    const toggleIcon = header.querySelector('.toggle-icon');
    
    console.log('Toggling section:', header.querySelector('h2').textContent);
    console.log('Content element:', content);
    console.log('Has collapsed class:', content.classList.contains('collapsed'));
    console.log('Current display style:', window.getComputedStyle(content).display);
    
    if (content.classList.contains('collapsed')) {
        // Expanding section
        content.classList.remove('collapsed');
        content.style.display = 'block';
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
        toggleIcon.classList.remove('rotated');
        header.classList.remove('collapsed');
        console.log('Expanded - removed collapsed class');
        console.log('New display style:', window.getComputedStyle(content).display);
    } else {
        // Collapsing section
        content.classList.add('collapsed');
        content.style.display = 'none';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
        toggleIcon.classList.add('rotated');
        header.classList.add('collapsed');
        console.log('Collapsed - added collapsed class');
        console.log('New display style:', window.getComputedStyle(content).display);
    }
    
    console.log('After toggle, classList:', content.classList.toString());
    
    // Save state to localStorage
    const sectionTitle = header.querySelector('h2').textContent;
    const isCollapsed = content.classList.contains('collapsed');
    localStorage.setItem('section_' + sectionTitle, isCollapsed);
}

// Attach click handlers to all collapsible headers
function attachCollapsibleHandlers() {
    document.querySelectorAll('.collapsible-header').forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function(e) {
            e.preventDefault();
            toggleSection(this);
        });
    });
    
    // Initialize all sections with proper display values
    document.querySelectorAll('.collapsible-content').forEach(content => {
        if (content.classList.contains('collapsed')) {
            content.style.display = 'none';
        } else {
            content.style.display = 'block';
        }
    });
    
    console.log('Initialized collapsed sections with display: none');
}

// Expand all sections
function expandAll() {
    console.log('Expand All clicked');
    document.querySelectorAll('.collapsible-content').forEach(content => {
        console.log('Checking content, has collapsed:', content.classList.contains('collapsed'));
        if (content.classList.contains('collapsed')) {
            const header = content.previousElementSibling;
            toggleSection(header);
        }
    });
}

// Collapse all sections
function collapseAll() {
    console.log('Collapse All clicked');
    document.querySelectorAll('.collapsible-content').forEach(content => {
        console.log('Checking content, has collapsed:', content.classList.contains('collapsed'));
        if (!content.classList.contains('collapsed')) {
            const header = content.previousElementSibling;
            toggleSection(header);
        }
    });
}

// Restore section states from localStorage
function restoreSectionStates() {
    document.querySelectorAll('.collapsible-header').forEach(header => {
        const sectionTitle = header.querySelector('h2').textContent;
        const isCollapsed = localStorage.getItem('section_' + sectionTitle) === 'true';
        
        if (isCollapsed) {
            const content = header.nextElementSibling;
            if (!content.classList.contains('collapsed')) {
                toggleSection(header);
            }
        }
    });
}

// Export to CSV function
function exportReport() {
    const params = new URLSearchParams(window.location.search);
    params.set('export', 'csv');
    window.location.href = window.location.pathname + '?' + params.toString();
}

// Live Data Refresh System
let autoRefreshEnabled = true;
let refreshInterval = null;
let refreshTimer = 60; // seconds

function startAutoRefresh() {
    if (refreshInterval) return; // Already running
    
    autoRefreshEnabled = true;
    updateRefreshButton();
    
    // Start countdown and refresh
    refreshInterval = setInterval(() => {
        refreshTimer--;
        
        if (refreshTimer <= 0) {
            refreshPage();
            refreshTimer = 60;
        }
        
        updateRefreshStatus();
    }, 1000); // Update every second
}

function stopAutoRefresh() {
    autoRefreshEnabled = false;
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
    updateRefreshButton();
    updateRefreshStatus();
}

function refreshPage() {
    // Preserve current URL parameters when refreshing
    const currentUrl = window.location.href;
    const urlParams = new URLSearchParams(window.location.search);
    
    // Add a timestamp to prevent caching
    urlParams.set('_refresh', Date.now());
    
    // Show loading indicator
    const statusElement = document.getElementById('autoRefreshStatus');
    if (statusElement) {
        statusElement.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Refreshing data...';
    }
    
    // Reload with parameters preserved
    window.location.href = window.location.pathname + '?' + urlParams.toString().replace('&_refresh=' + urlParams.get('_refresh'), '');
}

function updateRefreshStatus() {
    const statusElement = document.getElementById('autoRefreshStatus');
    if (!statusElement) return;
    
    if (autoRefreshEnabled) {
        statusElement.innerHTML = `<i class="fas fa-sync-alt fa-spin"></i> Live data refresh: Active (next update in ${refreshTimer}s)`;
        statusElement.style.color = '#16a34a';
    } else {
        statusElement.innerHTML = '<i class="fas fa-pause"></i> Live data refresh: Paused';
        statusElement.style.color = '#6b7280';
    }
}

function updateRefreshButton() {
    const button = document.getElementById('toggleAutoRefresh');
    if (!button) return;
    
    if (autoRefreshEnabled) {
        button.innerHTML = '<i class="fas fa-pause"></i> Pause Updates';
        button.className = 'btn btn-sm btn-outline-warning ms-3';
    } else {
        button.innerHTML = '<i class="fas fa-play"></i> Resume Updates';
        button.className = 'btn btn-sm btn-outline-success ms-3';
    }
}

function updateCurrentTime() {
    const timeElement = document.getElementById('currentTime');
    if (timeElement) {
        const now = new Date();
        const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        };
        timeElement.textContent = now.toLocaleString('en-US', options);
    }
}

// Initialize dashboard function
function initializeSeniorDashboard() {
    // Attach collapsible section handlers
    attachCollapsibleHandlers();
    
    // Restore collapsed states
    restoreSectionStates();
    
    // Attach expand/collapse all button handlers
    const expandAllBtn = document.getElementById('expandAllBtn');
    const collapseAllBtn = document.getElementById('collapseAllBtn');
    
    console.log('Found expandAllBtn:', expandAllBtn);
    console.log('Found collapseAllBtn:', collapseAllBtn);
    
    if (expandAllBtn) {
        expandAllBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Expand All button clicked!');
            expandAll();
        });
    }
    
    if (collapseAllBtn) {
        collapseAllBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Collapse All button clicked!');
            collapseAll();
        });
    }
    
    // Set up toggle button
    const toggleButton = document.getElementById('toggleAutoRefresh');
    if (toggleButton) {
        toggleButton.addEventListener('click', function() {
            if (autoRefreshEnabled) {
                stopAutoRefresh();
            } else {
                refreshTimer = 60;
                startAutoRefresh();
            }
        });
    }
    
    // Start auto-refresh
    startAutoRefresh();
    
    // Update clock every second
    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();
    
    console.log('HOS Dashboard: Live refresh system initialized (60s interval)');
    console.log('Collapsible sections initialized with state persistence');
    console.log('Collapsible handlers attached to', document.querySelectorAll('.collapsible-header').length, 'sections');
    
    // Initialize executive charts
    loadExecutiveCharts();
}

// Execute immediately if DOM is ready, otherwise wait for DOMContentLoaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeSeniorDashboard);
} else {
    initializeSeniorDashboard();
}

// Load Executive Analytics Charts
let multiHomeStaffingChart, budgetActualChart, overtimeTrendChart, staffingGaugeChart, complianceScoreChart;

async function loadExecutiveCharts() {
    console.log('Loading Executive Analytics charts...');
    try {
        // Check if ChartHelpers is available
        if (typeof ChartHelpers === 'undefined') {
            console.error('ChartHelpers not loaded! Charts cannot be created.');
            return;
        }
        if (typeof Chart === 'undefined') {
            console.error('Chart.js not loaded! Charts cannot be created.');
            return;
        }
        console.log('‚úì ChartHelpers and Chart.js are available');
        
        // Generate last 7 days labels
        const last7Days = [];
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            last7Days.push(date.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' }));
        }
        
        // Chart 1: Multi-Home Staffing Overview (Stacked Area Chart)
        // Shows actual vs required staffing levels across all 5 homes over 7 days
        console.log('Creating Multi-Home Staffing chart...');
        const requiredStaffByDay = [220, 222, 218, 225, 223, 220, 219]; // Total required across all homes
        const actualStaffByDay = [208, 215, 210, 218, 220, 215, 212]; // Total actual across all homes
        const agencyStaffByDay = [8, 5, 6, 4, 3, 5, 6]; // Agency workers used
        
        multiHomeStaffingChart = ChartHelpers.createAreaChart('multiHomeStaffingChart', {
            labels: last7Days,
            datasets: [
                {
                    label: 'Permanent Staff',
                    data: actualStaffByDay,
                    borderColor: '#0066FF',
                    backgroundColor: 'rgba(0, 102, 255, 0.5)',
                    fill: true,
                    borderWidth: 3,
                    hoverBorderWidth: 4,
                    hoverBorderColor: '#0052CC'
                },
                {
                    label: 'Agency Staff',
                    data: agencyStaffByDay,
                    borderColor: '#FF6F00',
                    backgroundColor: 'rgba(255, 111, 0, 0.5)',
                    fill: true,
                    borderWidth: 3,
                    hoverBorderWidth: 4,
                    hoverBorderColor: '#E65100'
                },
                {
                    label: 'Required Level',
                    data: requiredStaffByDay,
                    borderColor: '#EF4444',
                    backgroundColor: 'transparent',
                    borderDash: [5, 5],
                    fill: false,
                    borderWidth: 3,
                    hoverBorderWidth: 4
                }
            ]
        }, {
            plugins: {
                title: {
                    display: false
                },
                legend: {
                    position: 'top',
                    onClick: function(e, legendItem, legend) {
                        const index = legendItem.datasetIndex;
                        const chart = legend.chart;
                        const meta = chart.getDatasetMeta(index);
                        meta.hidden = !meta.hidden;
                        chart.update();
                    },
                    onHover: function(event) {
                        event.native.target.style.cursor = 'pointer';
                    },
                    onLeave: function(event) {
                        event.native.target.style.cursor = 'default';
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        afterLabel: function(context) {
                            const datasetIndex = context.datasetIndex;
                            const required = requiredStaffByDay[context.dataIndex];
                            if (datasetIndex === 0 || datasetIndex === 1) {
                                const total = actualStaffByDay[context.dataIndex] + agencyStaffByDay[context.dataIndex];
                                const gap = required - total;
                                if (gap > 0) {
                                    return `Gap: ${gap} staff needed`;
                                } else if (gap < 0) {
                                    return `Overstaffed by ${Math.abs(gap)}`;
                                }
                            }
                            return '';
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: false,
                    title: {
                        display: true,
                        text: 'Date'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    stacked: false,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Staff'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            },
            onClick: function(event, activeElements) {
                if (activeElements && activeElements.length > 0) {
                    const dataIndex = activeElements[0].index;
                    const dateLabel = this.data.labels[dataIndex];
                    console.log('Clicked on date:', dateLabel);
                    showStaffingDetail(dateLabel);
                }
            },
            onHover: function(event, activeElements) {
                event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
            }
        });
        console.log('‚úì Multi-Home Staffing chart created');
        
        // Chart 2: Budget vs Actual (Line Chart with dual data)
        // Shows budgeted vs actual spend across 5 homes
        console.log('Creating Budget vs Actual chart...');
        const homes = ['Victoria Gardens', 'Orchard Grove', 'Meadowburn', 'Riverside', 'Hawthorn House'];
        const budgetedCosts = [45000, 38000, 42000, 39000, 36000]; // Monthly budget per home
        const actualCosts = [47500, 36800, 43200, 41000, 35500]; // Actual spend this month
        
        budgetActualChart = ChartHelpers.createBarChart('budgetActualChart', {
            labels: homes,
            datasets: [
                {
                    label: 'Budget (¬£)',
                    data: budgetedCosts,
                    backgroundColor: '#66A3FF',
                    borderColor: '#0066FF',
                    borderWidth: 2,
                    hoverBackgroundColor: '#5599FF',
                    hoverBorderWidth: 3
                },
                {
                    label: 'Actual (¬£)',
                    data: actualCosts,
                    backgroundColor: function(context) {
                        const index = context.dataIndex;
                        const actual = actualCosts[index];
                        const budget = budgetedCosts[index];
                        // Red if over budget, green if under
                        return actual > budget ? 'rgba(239, 68, 68, 0.6)' : '#66DBA3';
                    },
                    borderColor: function(context) {
                        const index = context.dataIndex;
                        const actual = actualCosts[index];
                        const budget = budgetedCosts[index];
                        return actual > budget ? '#DC2626' : '#00C853';
                    },
                    borderWidth: 2,
                    hoverBorderWidth: 3
                }
            ]
        }, {
            plugins: {
                title: {
                    display: false
                },
                legend: {
                    position: 'bottom',
                    onClick: function(e, legendItem, legend) {
                        const index = legendItem.datasetIndex;
                        const chart = legend.chart;
                        const meta = chart.getDatasetMeta(index);
                        meta.hidden = !meta.hidden;
                        chart.update();
                    },
                    onHover: function(event) {
                        event.native.target.style.cursor = 'pointer';
                    },
                    onLeave: function(event) {
                        event.native.target.style.cursor = 'default';
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += '¬£' + context.parsed.y.toLocaleString();
                            return label;
                        },
                        afterLabel: function(context) {
                            if (context.datasetIndex === 1) { // Actual costs
                                const actual = context.parsed.y;
                                const budget = budgetedCosts[context.dataIndex];
                                const variance = actual - budget;
                                const pct = ((variance / budget) * 100).toFixed(1);
                                if (variance > 0) {
                                    return `Over budget: ¬£${variance.toLocaleString()} (+${pct}%)`;
                                } else if (variance < 0) {
                                    return `Under budget: ¬£${Math.abs(variance).toLocaleString()} (${pct}%)`;
                                }
                            }
                            return '';
                        },
                        footer: function(tooltipItems) {
                            if (tooltipItems[0].datasetIndex === 1) {
                                return 'Click for detailed breakdown';
                            }
                            return '';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Cost (¬£)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '¬£' + (value / 1000) + 'k';
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            onClick: function(event, activeElements) {
                if (activeElements && activeElements.length > 0) {
                    const homeIndex = activeElements[0].index;
                    const homeName = homes[homeIndex];
                    const budget = budgetedCosts[homeIndex];
                    const actual = actualCosts[homeIndex];
                    console.log(`Clicked on ${homeName}:`, { budget, actual, variance: actual - budget });
                    showBudgetBreakdown(homeName);
                }
            },
            onHover: function(event, activeElements) {
                event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
            }
        });
        console.log('‚úì Budget vs Actual chart created');
        
        // Chart 3: Overtime Hours Trend (Line Chart)
        // Shows overtime hours trends over the last 30 days
        console.log('Creating Overtime Trend chart...');
        const last30Days = [];
        const today = new Date();
        for (let i = 29; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            last30Days.push(date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }));
        }
        
        // Simulated overtime data with realistic patterns (peaks on weekends, dips on Mondays)
        const overtimeData = Array.from({ length: 30 }, (_, i) => {
            const dayOfWeek = (today.getDay() + i) % 7;
            const base = 45;
            const weekend = (dayOfWeek === 0 || dayOfWeek === 6) ? 20 : 0;
            const monday = dayOfWeek === 1 ? -10 : 0;
            return base + weekend + monday + (Math.random() * 15 - 7.5);
        });
        
        const overtimeThreshold = 50; // Target maximum overtime hours
        
        overtimeTrendChart = ChartHelpers.createAreaChart('overtimeTrendChart', {
            labels: last30Days,
            datasets: [
                {
                    label: 'Overtime Hours',
                    data: overtimeData,
                    borderColor: function(context) {
                        const value = context.raw;
                        return value > overtimeThreshold ? '#EF4444' : '#F59E0B';
                    },
                    backgroundColor: function(context) {
                        const value = context.raw;
                        return value > overtimeThreshold ? 'rgba(239, 68, 68, 0.2)' : 'rgba(245, 158, 11, 0.2)';
                    },
                    segment: {
                        borderColor: function(ctx) {
                            const value = ctx.p1.parsed.y;
                            return value > overtimeThreshold ? '#EF4444' : '#F59E0B';
                        }
                    },
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: function(context) {
                        const value = context.raw;
                        return value > overtimeThreshold ? 4 : 0;
                    },
                    pointBackgroundColor: '#DC2626',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 6
                },
                {
                    label: 'Target Maximum',
                    data: Array(30).fill(overtimeThreshold),
                    borderColor: '#DC2626',
                    borderDash: [8, 4],
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 0
                }
            ]
        }, {
            plugins: {
                title: {
                    display: false
                },
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        filter: function(item, data) {
                            // Show all items (no filtering needed)
                            return true;
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (context.datasetIndex === 0) {
                                const hours = context.parsed.y.toFixed(1);
                                const status = context.parsed.y > overtimeThreshold ? ' ‚ö†Ô∏è Over target' : ' ‚úì Within target';
                                return 'Overtime: ' + hours + ' hours' + status;
                            }
                            return 'Target: ' + context.parsed.y + ' hours';
                        },
                        footer: function(tooltipItems) {
                            const item = tooltipItems[0];
                            if (item.datasetIndex === 0 && item.parsed.y > overtimeThreshold) {
                                return 'Click to view breakdown';
                            }
                            return '';
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        maxTicksLimit: 10,
                        maxRotation: 45,
                        minRotation: 45
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Hours'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(0) + 'h';
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            interaction: {
                mode: 'index',
                intersect: false
            },
            onClick: function(event, activeElements) {
                if (activeElements && activeElements.length > 0 && activeElements[0].datasetIndex === 0) {
                    const dataIndex = activeElements[0].index;
                    const dateLabel = this.data.labels[dataIndex];
                    const hours = this.data.datasets[0].data[dataIndex];
                    console.log('Overtime details for', dateLabel, ':', hours.toFixed(1), 'hours');
                    showOvertimeDetail(dateLabel);
                }
            },
            onHover: function(event, activeElements) {
                event.native.target.style.cursor = (activeElements.length > 0 && activeElements[0].datasetIndex === 0) ? 'pointer' : 'default';
            }
        });
        console.log('‚úì Overtime Trend chart created');
        
        // Chart 4: Current Staffing Level (Gauge/Doughnut Chart)
        // Shows current staffing as percentage of required
        console.log('Creating Staffing Gauge chart...');
        const currentStaffing = 87; // 87% of required staff on duty
        const staffingGap = 100 - currentStaffing;
        
        // Center text plugin for gauge chart
        const centerTextPlugin = {
            id: 'centerText',
            beforeDraw: function(chart) {
                const width = chart.width;
                const height = chart.height;
                const ctx = chart.ctx;
                ctx.restore();
                
                const fontSize = (height / 114).toFixed(2);
                ctx.font = 'bold ' + fontSize + 'em Inter, sans-serif';
                ctx.textBaseline = 'middle';
                
                const text = currentStaffing + '%';
                const textX = Math.round((width - ctx.measureText(text).width) / 2);
                const textY = height / 2;
                
                ctx.fillStyle = '#1F2937';
                ctx.fillText(text, textX, textY - 10);
                
                // Subtitle
                ctx.font = '0.9em Inter, sans-serif';
                const subtitle = 'Staffed';
                const subtitleX = Math.round((width - ctx.measureText(subtitle).width) / 2);
                ctx.fillStyle = '#6B7280';
                ctx.fillText(subtitle, subtitleX, textY + 20);
                
                ctx.save();
            }
        };
        
        staffingGaugeChart = ChartHelpers.createDoughnutChart('staffingGaugeChart', {
            labels: ['Filled', 'Gap'],
            datasets: [{
                data: [currentStaffing, staffingGap],
                backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(16, 185, 129, 0.8)'], // Blue for Filled, Green for Gap
                borderColor: ['#3B82F6', '#10B981'],
                borderWidth: 2,
                hoverBackgroundColor: ['rgba(59, 130, 246, 1.0)', 'rgba(16, 185, 129, 1.0)'],
                hoverBorderColor: ['#2563EB', '#059669'],
                hoverBorderWidth: 3
            }]
        }, {
            cutout: '75%',
            plugins: {
                title: {
                    display: false
                },
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: true,
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + '%';
                        },
                        afterLabel: function(context) {
                            if (context.label === 'Gap') {
                                return 'Click to view details';
                            }
                            return '';
                        }
                    }
                },
                centerText: centerTextPlugin
            },
            onClick: function(event, activeElements) {
                console.log('Chart clicked!', activeElements);
                if (activeElements && activeElements.length > 0) {
                    const clickedIndex = activeElements[0].index;
                    const clickedLabel = this.data.labels[clickedIndex];
                    
                    console.log('Clicked on:', clickedLabel);
                    
                    // Show details if Gap section is clicked
                    if (clickedLabel === 'Gap') {
                        console.log('Opening staffing gap details modal...');
                        showStaffingGapDetails();
                    }
                }
            },
            onHover: function(event, activeElements) {
                event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
            }
        });
        console.log('‚úì Staffing Gauge chart created');
        
        // Chart 5: Compliance Score Trends by Home (Radar Chart)
        // Shows compliance scores across different metrics for each home
        console.log('Creating Compliance Score chart...');
        const complianceCanvas = document.getElementById('complianceScoreChart');
        if (!complianceCanvas) {
            console.error('‚ùå Compliance Score chart canvas not found!');
        } else {
            console.log('‚úì Compliance Score chart canvas found');
            console.log('Chart.js version:', Chart.version);
            console.log('Available chart types:', Chart.registry?.controllers?.keys ? Array.from(Chart.registry.controllers.keys()) : 'Unknown');
            
            try {
                const complianceMetrics = ['Training', 'Supervision', 'Care Plans', 'Incidents', 'Staffing', 'Documentation'];
                
                complianceScoreChart = ChartHelpers.createRadarChart('complianceScoreChart', {
                labels: complianceMetrics,
                datasets: [
                    {
                        label: 'Victoria Gardens',
                        data: [92, 88, 95, 90, 85, 93],
                        borderColor: '#0066FF',
                        backgroundColor: 'rgba(0, 102, 255, 0.25)',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#0066FF',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBorderWidth: 3
                    },
                    {
                        label: 'Orchard Grove',
                        data: [88, 91, 89, 92, 87, 90],
                        borderColor: '#00C853',
                        backgroundColor: 'rgba(0, 200, 83, 0.25)',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#00C853',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBorderWidth: 3
                    },
                    {
                        label: 'Meadowburn',
                        data: [90, 85, 92, 88, 91, 89],
                        borderColor: '#FF6F00',
                        backgroundColor: 'rgba(255, 111, 0, 0.25)',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#FF6F00',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBorderWidth: 3
                    },
                    {
                        label: 'Riverside',
                        data: [87, 89, 90, 85, 88, 91],
                        borderColor: '#9333ea',
                        backgroundColor: 'rgba(147, 51, 234, 0.25)',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#9333ea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBorderWidth: 3
                    },
                    {
                        label: 'Hawthorn House',
                        data: [91, 87, 88, 91, 90, 86],
                        borderColor: '#ec4899',
                        backgroundColor: 'rgba(236, 72, 153, 0.25)',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#ec4899',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBorderWidth: 3
                    }
                ]
            }, {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: false
                    },
                    legend: {
                        position: 'right',
                        onClick: function(e, legendItem, legend) {
                            const index = legendItem.datasetIndex;
                            const chart = legend.chart;
                            const meta = chart.getDatasetMeta(index);
                            meta.hidden = !meta.hidden;
                            chart.update();
                        },
                        onHover: function(event) {
                            event.native.target.style.cursor = 'pointer';
                        },
                        onLeave: function(event) {
                            event.native.target.style.cursor = 'default';
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const score = context.parsed.r.toFixed(1);
                                const status = score >= 90 ? ' ‚≠ê Excellent' : score >= 75 ? ' ‚úì Good' : ' ‚ö†Ô∏è Needs attention';
                                return context.dataset.label + ': ' + score + '%' + status;
                            },
                            afterLabel: function(context) {
                                const score = context.parsed.r;
                                if (score < 75) {
                                    return 'Click for improvement actions';
                                }
                                return '';
                            }
                        }
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20,
                            callback: function(value) {
                                return value + '%';
                            },
                            backdropColor: 'transparent'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        pointLabels: {
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        }
                    }
                },
                onClick: function(event, activeElements) {
                    if (activeElements && activeElements.length > 0) {
                        const element = activeElements[0];
                        const datasetIndex = element.datasetIndex;
                        const index = element.index;
                        const homeName = this.data.datasets[datasetIndex].label;
                        const metric = this.data.labels[index];
                        const score = this.data.datasets[datasetIndex].data[index].toFixed(1);
                        console.log(`Compliance details: ${homeName} - ${metric}: ${score}%`);
                        showComplianceActions(metric);
                    }
                },
                onHover: function(event, activeElements) {
                    event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                }
            });
            console.log('‚úì Compliance Score chart created:', complianceScoreChart);
        } catch (error) {
            console.error('‚ùå Error creating Compliance Score chart:', error);
            console.error('Error stack:', error.stack);
        }
    }
        
        console.log('‚úÖ All Executive Analytics charts loaded successfully');
    } catch (error) {
        console.error('‚ùå Error loading executive charts:', error);
    }
}

// Function to show staffing gap details
function showStaffingGapDetails() {
    const modal = new bootstrap.Modal(document.getElementById('staffingGapModal'));
    modal.show();
    
    // Simulate loading gap data
    const contentDiv = document.getElementById('staffingGapContent');
    
    // Fetch gap details from the server
    fetch('/api/staffing-gaps/')
        .then(response => response.json())
        .then(data => {
            displayGapDetails(data);
        })
        .catch(error => {
            console.error('Error loading gap details:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-circle"></i> 
                    <strong>Sample Data:</strong> API endpoint not yet configured. Showing example gap details:
                </div>
                ${getSampleGapDetails()}
            `;
        });
}

function getSampleGapDetails() {
    return `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Home</th>
                        <th>Unit</th>
                        <th>Shift Type</th>
                        <th>Date</th>
                        <th>Required</th>
                        <th>Scheduled</th>
                        <th>Gap</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Orchard Grove</strong></td>
                        <td>OG_PEACH</td>
                        <td><span class="badge bg-warning">Day</span></td>
                        <td>2026-01-14</td>
                        <td>4</td>
                        <td>3</td>
                        <td><span class="badge bg-danger">-1</span></td>
                        <td><span class="badge bg-warning">Short</span></td>
                    </tr>
                    <tr>
                        <td><strong>Hawthorn House</strong></td>
                        <td>HH_VIOLET</td>
                        <td><span class="badge bg-dark">Night</span></td>
                        <td>2026-01-14</td>
                        <td>3</td>
                        <td>2</td>
                        <td><span class="badge bg-danger">-1</span></td>
                        <td><span class="badge bg-warning">Short</span></td>
                    </tr>
                    <tr>
                        <td><strong>Riverside</strong></td>
                        <td>RS_JASMINE</td>
                        <td><span class="badge bg-warning">Day</span></td>
                        <td>2026-01-14</td>
                        <td>4</td>
                        <td>2</td>
                        <td><span class="badge bg-danger">-2</span></td>
                        <td><span class="badge bg-danger">Critical</span></td>
                    </tr>
                    <tr>
                        <td><strong>Meadowburn</strong></td>
                        <td>MB_DAISY</td>
                        <td><span class="badge bg-dark">Night</span></td>
                        <td>2026-01-14</td>
                        <td>3</td>
                        <td>2</td>
                        <td><span class="badge bg-danger">-1</span></td>
                        <td><span class="badge bg-warning">Short</span></td>
                    </tr>
                    <tr>
                        <td><strong>Victoria Gardens</strong></td>
                        <td>VG_ROSE</td>
                        <td><span class="badge bg-warning">Day</span></td>
                        <td>2026-01-15</td>
                        <td>4</td>
                        <td>3</td>
                        <td><span class="badge bg-danger">-1</span></td>
                        <td><span class="badge bg-warning">Short</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle"></i> 
            <strong>Note:</strong> This is sample data. Click "Close" and implement the API endpoint to see real-time gap details.
        </div>
    `;
}

function displayGapDetails(data) {
    const contentDiv = document.getElementById('staffingGapContent');
    // Process and display actual data from API
    // This would be implemented based on your API response structure
}

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Alt + E: Expand All
    if (e.altKey && e.key === 'e') {
        e.preventDefault();
        expandAll();
    }
    // Alt + C: Collapse All
    if (e.altKey && e.key === 'c') {
        e.preventDefault();
        collapseAll();
    }
    // Alt + R: Refresh
    if (e.altKey && e.key === 'r') {
        e.preventDefault();
        refreshPage();
    }
});

// ============================================
// NEW MODAL FUNCTIONS FOR INTERACTIVE CHARTS
// ============================================

// Function to show multi-home staffing detail
function showStaffingDetail(dateLabel) {
    const modal = new bootstrap.Modal(document.getElementById('staffingDetailModal'));
    modal.show();
    
    // Convert label to date format (YYYY-MM-DD)
    const today = new Date();
    let targetDate = new Date(today);
    
    // If dateLabel contains a recognizable date pattern, parse it
    // For now, use today's date as example
    const dateStr = targetDate.toISOString().split('T')[0];
    
    const contentDiv = document.getElementById('staffingDetailContent');
    contentDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading staffing details for ${dateLabel}...</p>
        </div>
    `;
    
    // Fetch data from API
    fetch(`/api/multi-home/staffing/${dateStr}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayStaffingDetail(data);
            } else {
                throw new Error(data.error || 'Failed to load data');
            }
        })
        .catch(error => {
            console.error('Error loading staffing detail:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>Error:</strong> ${error.message}
                </div>
            `;
        });
}

function displayStaffingDetail(data) {
    const contentDiv = document.getElementById('staffingDetailContent');
    
    let html = `
        <div class="mb-4">
            <h6 class="text-primary">Date: ${data.date_display}</h6>
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <h5 class="text-primary">${data.summary.total_shifts}</h5>
                            <small class="text-muted">Total Shifts</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <h5 class="text-success">${data.summary.total_filled}</h5>
                            <small class="text-muted">Filled</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-danger">
                        <div class="card-body text-center">
                            <h5 class="text-danger">${data.summary.total_gap}</h5>
                            <small class="text-muted">Gap</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <h5 class="text-info">${data.summary.percentage_filled}%</h5>
                            <small class="text-muted">Filled Rate</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="accordion" id="homeAccordion">
    `;
    
    data.homes.forEach((home, index) => {
        const statusColor = home.percentage_filled >= 90 ? 'success' : home.percentage_filled >= 70 ? 'warning' : 'danger';
        
        html += `
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading${index}">
                    <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                        <strong>${home.home}</strong>
                        <span class="badge bg-${statusColor} ms-2">${home.percentage_filled}% Filled</span>
                        <span class="ms-2 text-muted">(${home.total_filled}/${home.total_required})</span>
                    </button>
                </h2>
                <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#homeAccordion">
                    <div class="accordion-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Shift Type</th>
                                        <th>Required</th>
                                        <th>Filled</th>
                                        <th>Gap</th>
                                        <th>%</th>
                                        <th>Staff Assigned</th>
                                    </tr>
                                </thead>
                                <tbody>
        `;
        
        home.shift_types.forEach(shift => {
            const shiftStatusColor = shift.percentage_filled >= 90 ? 'success' : shift.percentage_filled >= 70 ? 'warning' : 'danger';
            html += `
                <tr>
                    <td><strong>${shift.shift_type}</strong></td>
                    <td>${shift.required}</td>
                    <td>${shift.filled}</td>
                    <td><span class="badge bg-${shift.gap > 0 ? 'danger' : 'success'}">${shift.gap}</span></td>
                    <td><span class="badge bg-${shiftStatusColor}">${shift.percentage_filled}%</span></td>
                    <td>
                        ${shift.staff.length > 0 ? shift.staff.map(s => `
                            <span class="badge bg-secondary me-1">${s.name} (${s.role})</span>
                        `).join('') : '<span class="text-muted">None</span>'}
                    </td>
                </tr>
            `;
        });
        
        html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `</div>`;
    contentDiv.innerHTML = html;
}

// Function to show budget breakdown
function showBudgetBreakdown(homeLabel) {
    const modal = new bootstrap.Modal(document.getElementById('budgetBreakdownModal'));
    modal.show();
    
    // Extract home ID from label (assuming format like "Home 1", "Home 2", etc.)
    const homeId = 3; // Default to Orchard Grove for now
    const month = new Date().toISOString().slice(0, 7); // Current month YYYY-MM
    
    const contentDiv = document.getElementById('budgetBreakdownContent');
    contentDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading budget breakdown...</p>
        </div>
    `;
    
    // Fetch data from API
    fetch(`/api/budget-breakdown/${homeId}/?month=${month}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayBudgetBreakdown(data);
            } else {
                throw new Error(data.error || 'Failed to load data');
            }
        })
        .catch(error => {
            console.error('Error loading budget breakdown:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>Error:</strong> ${error.message}
                </div>
            `;
        });
}

function displayBudgetBreakdown(data) {
    const contentDiv = document.getElementById('budgetBreakdownContent');
    
    const varianceColor = data.summary.total_variance > 0 ? 'danger' : 'success';
    const varianceIcon = data.summary.total_variance > 0 ? 'fa-arrow-up' : 'fa-arrow-down';
    
    let html = `
        <div class="mb-4">
            <h6 class="text-primary">${data.home.name} - ${data.period.month}</h6>
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <h5 class="text-primary">¬£${data.summary.total_budget.toLocaleString()}</h5>
                            <small class="text-muted">Budget</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <h5 class="text-info">¬£${data.summary.total_actual.toLocaleString()}</h5>
                            <small class="text-muted">Actual</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-${varianceColor}">
                        <div class="card-body text-center">
                            <h5 class="text-${varianceColor}">
                                <i class="fas ${varianceIcon}"></i> ¬£${Math.abs(data.summary.total_variance).toLocaleString()}
                            </h5>
                            <small class="text-muted">Variance</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-${varianceColor}">
                        <div class="card-body text-center">
                            <h5 class="text-${varianceColor}">${data.summary.variance_percentage}%</h5>
                            <small class="text-muted">Variance %</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Category</th>
                        <th class="text-end">Budget (¬£)</th>
                        <th class="text-end">Actual (¬£)</th>
                        <th class="text-end">Variance (¬£)</th>
                        <th class="text-end">Variance %</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Shifts</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.breakdown.forEach(category => {
        const rowColor = category.status === 'over' ? 'table-danger' : category.status === 'under' ? 'table-success' : '';
        const statusBadge = category.status === 'over' ? 'danger' : category.status === 'under' ? 'success' : 'secondary';
        const statusText = category.status === 'over' ? 'Over Budget' : category.status === 'under' ? 'Under Budget' : 'On Budget';
        
        html += `
            <tr class="${rowColor}">
                <td><strong>${category.category}</strong></td>
                <td class="text-end">${category.budget.toLocaleString()}</td>
                <td class="text-end">${category.actual.toLocaleString()}</td>
                <td class="text-end">${category.variance >= 0 ? '+' : ''}${category.variance.toLocaleString()}</td>
                <td class="text-end">${category.variance_percentage >= 0 ? '+' : ''}${category.variance_percentage}%</td>
                <td class="text-center">
                    <span class="badge bg-${statusBadge}">${statusText}</span>
                </td>
                <td class="text-center">${category.shifts}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    contentDiv.innerHTML = html;
}

// Function to show overtime detail
function showOvertimeDetail(dateLabel) {
    const modal = new bootstrap.Modal(document.getElementById('overtimeDetailModal'));
    modal.show();
    
    const today = new Date();
    const dateStr = today.toISOString().split('T')[0];
    
    const contentDiv = document.getElementById('overtimeDetailContent');
    contentDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-danger" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading overtime details...</p>
        </div>
    `;
    
    // Fetch data from API
    fetch(`/api/overtime/${dateStr}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayOvertimeDetail(data);
            } else {
                throw new Error(data.error || 'Failed to load data');
            }
        })
        .catch(error => {
            console.error('Error loading overtime detail:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>Error:</strong> ${error.message}
                </div>
            `;
        });
}

function displayOvertimeDetail(data) {
    const contentDiv = document.getElementById('overtimeDetailContent');
    
    let html = `
        <div class="mb-4">
            <h6 class="text-primary">Overtime Breakdown - ${data.date_display}</h6>
            <p class="text-muted">Week: ${data.week.week_display}</p>
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="card border-danger">
                        <div class="card-body text-center">
                            <h5 class="text-danger">${data.summary.total_overtime_hours}h</h5>
                            <small class="text-muted">Total Overtime</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <h5 class="text-warning">${data.summary.staff_with_overtime}</h5>
                            <small class="text-muted">Staff w/ Overtime</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <h5 class="text-info">${data.summary.average_overtime}h</h5>
                            <small class="text-muted">Avg per Staff</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-secondary">
                        <div class="card-body text-center">
                            <h5 class="text-secondary">${data.summary.standard_weekly_hours}h</h5>
                            <small class="text-muted">Standard Week</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Staff Member</th>
                        <th>Role</th>
                        <th>Home</th>
                        <th class="text-center">Regular Hours</th>
                        <th class="text-center">Overtime Hours</th>
                        <th class="text-center">Total Hours</th>
                        <th class="text-center">Overtime %</th>
                        <th>Shifts on ${data.date_display.split(',')[0]}</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    if (data.overtime_staff.length === 0) {
        html += `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <p>No staff worked overtime this week</p>
                </td>
            </tr>
        `;
    } else {
        data.overtime_staff.forEach(staff => {
            const overtimeLevel = staff.overtime_percentage >= 30 ? 'danger' : staff.overtime_percentage >= 20 ? 'warning' : 'info';
            
            html += `
                <tr>
                    <td><strong>${staff.staff_name}</strong></td>
                    <td><span class="badge bg-primary">${staff.role}</span></td>
                    <td>${staff.home}</td>
                    <td class="text-center">${staff.regular_hours}h</td>
                    <td class="text-center"><span class="badge bg-${overtimeLevel}">${staff.overtime_hours}h</span></td>
                    <td class="text-center">${staff.total_hours}h</td>
                    <td class="text-center">${staff.overtime_percentage}%</td>
                    <td>
                        ${staff.shifts_on_date.length > 0 ? staff.shifts_on_date.map(s => `
                            <small class="d-block">${s.shift_type} (${s.unit})</small>
                        `).join('') : '<span class="text-muted">None</span>'}
                    </td>
                </tr>
            `;
        });
    }
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    contentDiv.innerHTML = html;
}

// Function to show compliance actions
function showComplianceActions(metric) {
    const modal = new bootstrap.Modal(document.getElementById('complianceActionsModal'));
    modal.show();
    
    const homeId = 3; // Default to Orchard Grove
    
    // Map display names to API metric names
    const metricMap = {
        'training': 'training',
        'supervision': 'care_planning',  // Supervision maps to care_planning
        'care_plans': 'care_planning',   // Care Plans also maps to care_planning
        'incidents': 'safeguarding',     // Incidents maps to safeguarding
        'staffing': 'training',          // Staffing maps to training (placeholder)
        'documentation': 'documentation'
    };
    
    const metricSlug = metric.toLowerCase().replace(/ /g, '_');
    const apiMetric = metricMap[metricSlug] || metricSlug;
    
    const contentDiv = document.getElementById('complianceActionsContent');
    contentDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-purple" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading compliance actions...</p>
        </div>
    `;
    
    // Fetch data from API
    fetch(`/api/compliance/actions/${homeId}/${apiMetric}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayComplianceActions(data);
            } else {
                throw new Error(data.error || 'Failed to load data');
            }
        })
        .catch(error => {
            console.error('Error loading compliance actions:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>Error:</strong> ${error.message}
                </div>
            `;
        });
}

function displayComplianceActions(data) {
    const contentDiv = document.getElementById('complianceActionsContent');
    
    const statusColor = data.metric.status === 'excellent' ? 'success' : data.metric.status === 'good' ? 'info' : 'warning';
    const statusIcon = data.metric.status === 'excellent' ? 'fa-star' : data.metric.status === 'good' ? 'fa-check' : 'fa-exclamation-triangle';
    
    let html = `
        <div class="mb-4">
            <h6 class="text-primary">${data.home.name} - ${data.metric.name}</h6>
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="card border-${statusColor}">
                        <div class="card-body text-center">
                            <h5 class="text-${statusColor}">
                                <i class="fas ${statusIcon}"></i> ${data.metric.current_score}%
                            </h5>
                            <small class="text-muted">Current Score</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-secondary">
                        <div class="card-body text-center">
                            <h5 class="text-secondary">${data.metric.target_score}%</h5>
                            <small class="text-muted">Target Score</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <h5 class="text-warning">${data.metric.gap}%</h5>
                            <small class="text-muted">Gap to Target</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-danger">
                        <div class="card-body text-center">
                            <h5 class="text-danger">${data.actions_count.total}</h5>
                            <small class="text-muted">Total Actions</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info mb-3">
            <strong>Action Priority Breakdown:</strong>
            <span class="badge bg-danger ms-2">High: ${data.actions_count.high}</span>
            <span class="badge bg-warning ms-2">Medium: ${data.actions_count.medium}</span>
            <span class="badge bg-secondary ms-2">Low: ${data.actions_count.low}</span>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Priority</th>
                        <th>Action Required</th>
                        <th>Staff/Resident</th>
                        <th>Status/Details</th>
                        <th>Deadline</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    if (data.actions.length === 0) {
        html += `
            <tr>
                <td colspan="5" class="text-center text-success py-4">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <p>All ${data.metric.name} requirements are up to date!</p>
                </td>
            </tr>
        `;
    } else {
        data.actions.forEach(action => {
            const priorityColor = action.priority === 'high' ? 'danger' : action.priority === 'medium' ? 'warning' : 'secondary';
            const deadlineColor = action.deadline === 'Immediate' || action.deadline === 'Overdue' ? 'danger' : 'info';
            
            html += `
                <tr>
                    <td><span class="badge bg-${priorityColor}">${action.priority.toUpperCase()}</span></td>
                    <td><strong>${action.action}</strong></td>
                    <td>${action.staff || action.resident || '-'}</td>
                    <td>
                        ${action.course ? `<small class="d-block text-muted">Course: ${action.course}</small>` : ''}
                        ${action.status ? `<span class="badge bg-secondary">${action.status}</span>` : ''}
                        ${action.days_overdue ? `<small class="text-danger">+${action.days_overdue} days overdue</small>` : ''}
                    </td>
                    <td><span class="badge bg-${deadlineColor}">${action.deadline}</span></td>
                </tr>
            `;
        });
    }
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    contentDiv.innerHTML = html;
}

</script>
{% endblock %}
