{% extends "base.html" %}
{% load static %}

{% block title %}Search Results - Staff Rota System{% endblock %}

{% block extra_css %}
<style>
    .search-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .search-box {
        margin-bottom: 30px;
    }
    
    .search-box input {
        width: 100%;
        padding: 15px;
        font-size: 16px;
        border: 2px solid #ddd;
        border-radius: 8px;
    }
    
    .search-box input:focus {
        outline: none;
        border-color: #007bff;
    }
    
    .search-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .search-filter-btn {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .search-filter-btn:hover {
        background: #f0f0f0;
    }
    
    .search-filter-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .search-stats {
        margin-bottom: 20px;
        color: #666;
    }
    
    .search-results-section {
        margin-bottom: 30px;
    }
    
    .search-results-section h3 {
        margin-bottom: 15px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
    }
    
    .result-item {
        background: white;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border: 1px solid #ddd;
        transition: all 0.2s;
    }
    
    .result-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-color: #007bff;
    }
    
    .result-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .result-title a {
        color: #007bff;
        text-decoration: none;
    }
    
    .result-title a:hover {
        text-decoration: underline;
    }
    
    .result-meta {
        font-size: 14px;
        color: #666;
        margin-bottom: 8px;
    }
    
    .result-snippet {
        font-size: 14px;
        color: #333;
    }
    
    .highlight {
        background-color: #ffeb3b;
        font-weight: bold;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin-top: 20px;
    }
    
    .pagination a, .pagination span {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-decoration: none;
        color: #007bff;
    }
    
    .pagination span.current {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .no-results {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .autocomplete-container {
        position: relative;
    }
    
    .autocomplete-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .autocomplete-suggestions.show {
        display: block;
    }
    
    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .autocomplete-item:hover {
        background: #f0f0f0;
    }
    
    .autocomplete-type {
        font-size: 12px;
        color: #666;
        margin-left: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="search-container">
    <h1>Search</h1>
    
    <!-- Search Box -->
    <div class="search-box">
        <div class="autocomplete-container">
            <form method="get" action="{% url 'global_search' %}" id="searchForm">
                <input 
                    type="text" 
                    name="q" 
                    id="searchInput"
                    value="{{ query }}" 
                    placeholder="Search staff, shifts, leave requests, care homes..."
                    autocomplete="off"
                >
                <input type="hidden" name="type" id="searchType" value="{{ search_type }}">
                <input type="hidden" name="page" value="{{ page }}">
            </form>
            <div class="autocomplete-suggestions" id="autocompleteSuggestions"></div>
        </div>
    </div>
    
    <!-- Filter Buttons -->
    <div class="search-filters">
        <button class="search-filter-btn {% if search_type == 'all' %}active{% endif %}" 
                onclick="setSearchType('all')">All</button>
        <button class="search-filter-btn {% if search_type == 'staff' %}active{% endif %}" 
                onclick="setSearchType('staff')">Staff</button>
        <button class="search-filter-btn {% if search_type == 'shifts' %}active{% endif %}" 
                onclick="setSearchType('shifts')">Shifts</button>
        <button class="search-filter-btn {% if search_type == 'leave' %}active{% endif %}" 
                onclick="setSearchType('leave')">Leave Requests</button>
        <button class="search-filter-btn {% if search_type == 'homes' %}active{% endif %}" 
                onclick="setSearchType('homes')">Care Homes</button>
    </div>
    
    {% if query %}
        <!-- Search Stats -->
        <div class="search-stats">
            Found {{ total_results }} result{{ total_results|pluralize }} for "{{ query }}"
        </div>
        
        {% if total_results > 0 %}
            <!-- Staff Results -->
            {% if results.staff %}
            <div class="search-results-section">
                <h3>Staff ({{ results.staff.total }})</h3>
                {% for hit in results.staff.hits %}
                <div class="result-item">
                    <div class="result-title">
                        <a href="/staff/{{ hit.sap }}/">{{ hit.name }}</a>
                    </div>
                    <div class="result-meta">
                        SAP: {{ hit.sap }}
                        {% if hit.role %} | {{ hit.role }}{% endif %}
                        {% if hit.care_home %} | {{ hit.care_home }}{% endif %}
                    </div>
                    <div class="result-snippet">
                        {{ hit.email }}
                    </div>
                </div>
                {% endfor %}
                
                {% if results.staff.total > results.staff.per_page %}
                <div class="pagination">
                    {% if results.staff.page > 1 %}
                    <a href="?q={{ query }}&type=staff&page={{ results.staff.page|add:-1 }}">Previous</a>
                    {% endif %}
                    <span class="current">Page {{ results.staff.page }}</span>
                    {% if results.staff.page < results.staff.total|divisibleby:results.staff.per_page %}
                    <a href="?q={{ query }}&type=staff&page={{ results.staff.page|add:1 }}">Next</a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Shift Results -->
            {% if results.shifts %}
            <div class="search-results-section">
                <h3>Shifts ({{ results.shifts.total }})</h3>
                {% for hit in results.shifts.hits %}
                <div class="result-item">
                    <div class="result-title">
                        <a href="/shift/{{ hit.id }}/">{{ hit.shift_type }} - {{ hit.date }}</a>
                    </div>
                    <div class="result-meta">
                        {{ hit.start_time }} - {{ hit.end_time }}
                        {% if hit.assigned_to %} | Assigned to: {{ hit.assigned_to }}{% endif %}
                        {% if hit.care_home %} | {{ hit.care_home }}{% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Leave Request Results -->
            {% if results.leave %}
            <div class="search-results-section">
                <h3>Leave Requests ({{ results.leave.total }})</h3>
                {% for hit in results.leave.hits %}
                <div class="result-item">
                    <div class="result-title">
                        <a href="/leave/{{ hit.id }}/">{{ hit.staff_name }}</a>
                    </div>
                    <div class="result-meta">
                        {{ hit.start_date }} to {{ hit.end_date }} | Status: {{ hit.status }}
                    </div>
                    <div class="result-snippet">
                        {{ hit.reason }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Care Home Results -->
            {% if results.homes %}
            <div class="search-results-section">
                <h3>Care Homes ({{ results.homes.total }})</h3>
                {% for hit in results.homes.hits %}
                <div class="result-item">
                    <div class="result-title">
                        <a href="/care-home/{{ hit.id }}/">{{ hit.name }}</a>
                    </div>
                    <div class="result-meta">
                        {{ hit.address }}
                        {% if hit.phone %} | Phone: {{ hit.phone }}{% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        {% else %}
            <div class="no-results">
                <p>No results found for "{{ query }}"</p>
                <p>Try:</p>
                <ul style="list-style: none; padding: 0;">
                    <li>Checking your spelling</li>
                    <li>Using different keywords</li>
                    <li>Searching for a different type of record</li>
                </ul>
            </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    let searchTimeout;
    const searchInput = document.getElementById('searchInput');
    const suggestionsContainer = document.getElementById('autocompleteSuggestions');
    const searchForm = document.getElementById('searchForm');
    
    // Autocomplete
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < {{ SEARCH_AUTOCOMPLETE_MIN_LENGTH|default:2 }}) {
            suggestionsContainer.classList.remove('show');
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`{% url 'search_autocomplete' %}?q=${encodeURIComponent(query)}&type=${document.getElementById('searchType').value}`)
                .then(response => response.json())
                .then(data => {
                    if (data.suggestions.length > 0) {
                        showSuggestions(data.suggestions);
                    } else {
                        suggestionsContainer.classList.remove('show');
                    }
                });
        }, 300);
    });
    
    function showSuggestions(suggestions) {
        suggestionsContainer.innerHTML = '';
        
        suggestions.forEach(suggestion => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.innerHTML = `
                ${suggestion.label}
                <span class="autocomplete-type">${suggestion.type}</span>
            `;
            item.onclick = () => {
                window.location.href = suggestion.url;
            };
            suggestionsContainer.appendChild(item);
        });
        
        suggestionsContainer.classList.add('show');
    }
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.autocomplete-container')) {
            suggestionsContainer.classList.remove('show');
        }
    });
    
    // Search type filter
    function setSearchType(type) {
        document.getElementById('searchType').value = type;
        searchForm.submit();
    }
    
    // Auto-submit on Enter
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            suggestionsContainer.classList.remove('show');
            searchForm.submit();
        }
    });
</script>
{% endblock %}
