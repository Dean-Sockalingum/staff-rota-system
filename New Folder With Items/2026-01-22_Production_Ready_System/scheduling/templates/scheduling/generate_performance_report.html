{% extends 'scheduling/base.html' %}
{% load static %}

{% block title %}Generate Performance Report{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    .form-section {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .select2-container {
        width: 100% !important;
    }
    .select2-container--bootstrap-5 .select2-selection {
        min-height: 48px;
        font-size: 1.125rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'performance_dashboard' %}">Performance</a></li>
                    <li class="breadcrumb-item active">Generate Report</li>
                </ol>
            </nav>
            <h1><i class="fas fa-file-alt"></i> Generate Performance Report</h1>
            <p class="text-muted">Create a detailed performance report for a staff member</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="form-section">
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- Care Home Selection -->
                    <div class="form-group mb-4">
                        <label for="care_home_filter" class="font-weight-bold">
                            <i class="fas fa-home"></i> Filter by Care Home
                        </label>
                        <select id="care_home_filter" class="form-control form-control-lg">
                            <option value="">All Care Homes</option>
                            {% for home in care_homes %}
                            <option value="{{ home.id }}">{{ home.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Optionally filter staff by care home</small>
                    </div>
                    
                    <!-- Staff Selection with Search -->
                    <div class="form-group mb-4">
                        <label for="staff_id" class="font-weight-bold">
                            <i class="fas fa-user"></i> Search & Select Staff Member <span class="text-danger">*</span>
                        </label>
                        <select name="staff_id" id="staff_id" class="form-control form-control-lg" required>
                            <option value="">Start typing to search staff by name or SAP number...</option>
                        </select>
                        <small class="form-text text-muted">Type at least 2 characters to search for staff</small>
                    </div>

                    <!-- Date Range -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-4">
                                <label for="start_date" class="font-weight-bold">
                                    <i class="fas fa-calendar-alt"></i> Start Date <span class="text-danger">*</span>
                                </label>
                                <input type="date" name="start_date" id="start_date" class="form-control" 
                                       value="{{ start_date|date:'Y-m-d' }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-4">
                                <label for="end_date" class="font-weight-bold">
                                    <i class="fas fa-calendar-alt"></i> End Date <span class="text-danger">*</span>
                                </label>
                                <input type="date" name="end_date" id="end_date" class="form-control" 
                                       value="{{ end_date|date:'Y-m-d' }}" required>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Date Range Presets -->
                    <div class="form-group mb-4">
                        <label class="font-weight-bold">Quick Date Range</label>
                        <div class="btn-group d-block" role="group">
                            <button type="button" class="btn btn-outline-secondary" onclick="setDateRange(7)">Last 7 Days</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setDateRange(14)">Last 14 Days</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setDateRange(30)">Last 30 Days</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setDateRange(60)">Last 60 Days</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setDateRange(90)">Last 90 Days</button>
                        </div>
                    </div>

                    <!-- Report Info -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Report Contents:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Overall performance score and rating</li>
                            <li>Attendance, punctuality, and shift completion rates</li>
                            <li>Performance trends over the selected period</li>
                            <li>Identified issues and recommended actions</li>
                            <li>Historical performance comparison</li>
                        </ul>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-group text-right">
                        <a href="{% url 'performance_dashboard' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-file-pdf"></i> Generate Report
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // Initialize Select2 for staff search
    $(document).ready(function() {
        const $staffSelect = $('#staff_id');
        const $careHomeFilter = $('#care_home_filter');
        
        $staffSelect.select2({
            theme: 'bootstrap-5',
            placeholder: 'Start typing to search staff...',
            allowClear: true,
            minimumInputLength: 2,
            ajax: {
                url: '{% url "search_staff_for_performance" %}',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term,
                        care_home_id: $careHomeFilter.val()
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                },
                cache: true
            }
        });
        
        // Reinitialize search when care home filter changes
        $careHomeFilter.on('change', function() {
            $staffSelect.val(null).trigger('change');
        });
    });
    
    // Set date range based on days back
    function setDateRange(days) {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - days);
        
        document.getElementById('end_date').valueAsDate = endDate;
        document.getElementById('start_date').valueAsDate = startDate;
    }
    
    // Set default dates (last 30 days)
    document.addEventListener('DOMContentLoaded', function() {
        if (!document.getElementById('start_date').value) {
            setDateRange(30);
        }
    });
    
    // Validate date range
    document.querySelector('form').addEventListener('submit', function(e) {
        const startDate = new Date(document.getElementById('start_date').value);
        const endDate = new Date(document.getElementById('end_date').value);
        
        if (startDate > endDate) {
            e.preventDefault();
            alert('Start date must be before end date');
        }
        
        const staffId = document.getElementById('staff_id').value;
        if (!staffId) {
            e.preventDefault();
            alert('Please select a staff member');
        }
    });
</script>
{% endblock %}
            return false;
        }
        
        if (!document.getElementById('staff_id').value) {
            e.preventDefault();
            alert('Please select a staff member');
            return false;
        }
    });
</script>
{% endblock %}
