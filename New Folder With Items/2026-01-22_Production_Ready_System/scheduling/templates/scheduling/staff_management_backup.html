{% extends 'scheduling/base.html' %}

{% block title %}Staff Management - Home Unit Assignments{% endblock %}

{% block page_title %}Staff Management - Home Unit Assignments{% endblock %}

{% block extra_css %}
<style>
    :root {
        --sscw-color: #495057;
        --scw-color: #28a745;
        --sca-color: #007bff;
        --team-a-color: #e74c3c;
        --team-b-color: #f39c12;
        --team-c-color: #9b59b6;
    }
    
    .unit-card {
        border: 2px solid #dee2e6;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .unit-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px 8px 0 0;
    }
    
    .sscw-manager {
        background-color: #f8f9fa;
        border-left: 4px solid var(--sscw-color);
        padding: 10px 15px;
        margin: 10px 0;
        border-radius: 0 5px 5px 0;
    }
    
    .shift-section {
        margin: 20px 0;
        padding: 15px;
        border-radius: 8px;
    }
    
    .day-section {
        background-color: #fff3cd;
        border-left: 5px solid #ffc107;
    }
    
    .night-section {
        background-color: #d1ecf1;
        border-left: 5px solid #17a2b8;
    }
    
    .role-group {
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 8px;
        background-color: white;
        border: 1px solid #dee2e6;
    }
    
    .role-header {
        font-weight: bold;
        margin-bottom: 15px;
        padding: 8px 12px;
        border-radius: 5px;
    }
    
    .scw-role {
        background-color: #d4edda;
        color: #155724;
        border-left: 4px solid var(--scw-color);
    }
    
    .sca-role {
        background-color: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid var(--sca-color);
    }
    
    .team-group {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #e9ecef;
    }
    
    .team-a { border-left: 4px solid var(--team-a-color); }
    .team-b { border-left: 4px solid var(--team-b-color); }
    .team-c { border-left: 4px solid var(--team-c-color); }
    
    .team-header {
        font-weight: bold;
        margin-bottom: 8px;
        font-size: 0.9rem;
        color: #495057;
    }
    
    .staff-member {
        padding: 8px 12px;
        margin: 5px 0;
        background-color: #f8f9fa;
        border-radius: 5px;
        border-left: 3px solid #6c757d;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .staff-info {
        flex-grow: 1;
    }
    
    .staff-name {
        font-weight: 500;
        color: #212529;
    }
    
    .staff-sap {
        font-size: 0.85rem;
        color: #6c757d;
        margin-left: 10px;
    }
    
    .contracted-shifts {
        background-color: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
        min-width: 60px;
        text-align: center;
    }
    
    .stats-summary {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
    }
    
    .no-staff {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        padding: 20px;
    }
    
    .section-title {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
    }
    
    .day-icon, .night-icon {
        margin-right: 8px;
        font-size: 1.2rem;
    }
    
    .day-icon { color: #ffc107; }
    .night-icon { color: #17a2b8; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Statistics Summary -->
    <div class="stats-summary">
        <div class="row">
            <div class="col-md-3">
                <h4>{{ total_staff }}</h4>
                <p class="mb-0">Total Active Staff</p>
            </div>
            <div class="col-md-3">
                <h4>{{ care_staff }}</h4>
                <p class="mb-0">Care Staff</p>
            </div>
            <div class="col-md-3">
                <h4>{{ staff_with_home_units }}</h4>
                <p class="mb-0">Staff with Home Units</p>
            </div>
            <div class="col-md-3">
                <h4>{{ staff_without_home_units }}</h4>
                <p class="mb-0">Staff without Home Units</p>
            </div>
        </div>
    </div>

    <!-- Home Unit Assignments -->
    {% for unit_data in units_with_home_staff %}
    <div class="unit-card">
        <!-- Unit Header -->
        <div class="unit-header">
            <div class="row">
                <div class="col-md-8">
                    <h3 class="mb-1">{{ unit_data.unit.get_name_display }}</h3>
                    <p class="mb-0">Home Unit Assignment - {{ unit_data.total_home_staff }} staff assigned</p>
                </div>
                <div class="col-md-4 text-right">
                    <span class="badge badge-light badge-lg">
                        Day: {{ unit_data.total_day_staff }} | Night: {{ unit_data.total_night_staff }}
                    </span>
                </div>
            </div>
        </div>

        <div class="card-body">
            <!-- SSCW Managers -->
            {% if unit_data.sscw_managers %}
            <div class="mb-4">
                <h5 class="mb-3">SSCW Managers Responsible for {{ unit_data.unit.get_name_display }}:</h5>
                {% for sscw in unit_data.sscw_managers %}
                <div class="sscw-manager">
                    <strong>{{ sscw.first_name }} {{ sscw.last_name }}</strong> 
                    <span class="staff-sap">({{ sscw.sap }})</span>
                    - Team {{ sscw.team|default:"Unassigned" }}
                    <small class="text-muted"> - Senior Social Care Worker</small>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Day Shift Staff -->
            <div class="shift-section day-section">
                <div class="section-title">
                    <span class="day-icon">‚òÄÔ∏è</span>
                    Day Shift Staff ({{ unit_data.total_day_staff }} total)
                </div>
                
                {% if unit_data.day_staff_by_role %}
                    {% for role_name, teams_data in unit_data.day_staff_by_role.items %}
                    <div class="role-group">
                        <div class="role-header {% if role_name == 'SCW' %}scw-role{% else %}sca-role{% endif %}">
                            {% if role_name == 'SCW' %}
                                Social Care Workers (SCW)
                            {% else %}
                                Social Care Assistants (SCA)
                            {% endif %}
                        </div>
                        
                        {% for team, staff_list in teams_data.items %}
                        <div class="team-group team-{{ team|lower }}">
                            <div class="team-header">
                                Team {{ team }} ({{ staff_list|length }} staff)
                            </div>
                            
                            {% for staff_data in staff_list %}
                            <div class="staff-member">
                                <div class="staff-info">
                                    <span class="staff-name">{{ staff_data.staff.first_name }} {{ staff_data.staff.last_name }}</span>
                                    <span class="staff-sap">{{ staff_data.staff.sap }}</span>
                                </div>
                                <div class="contracted-shifts">
                                    {{ staff_data.contracted_shifts }} shifts/week
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-staff">No day shift staff assigned to this unit as home base</div>
                {% endif %}
            </div>

            <!-- Night Shift Staff -->
            <div class="shift-section night-section">
                <div class="section-title">
                    <span class="night-icon">üåô</span>
                    Night Shift Staff ({{ unit_data.total_night_staff }} total)
                </div>
                
                {% if unit_data.night_staff_by_role %}
                    {% for role_name, teams_data in unit_data.night_staff_by_role.items %}
                    <div class="role-group">
                        <div class="role-header {% if role_name == 'SCW' %}scw-role{% else %}sca-role{% endif %}">
                            {% if role_name == 'SCW' %}
                                Social Care Workers (SCW)
                            {% else %}
                                Social Care Assistants (SCA)
                            {% endif %}
                        </div>
                        
                        {% for team, staff_list in teams_data.items %}
                        <div class="team-group team-{{ team|lower }}">
                            <div class="team-header">
                                Team {{ team }} ({{ staff_list|length }} staff)
                            </div>
                            
                            {% for staff_data in staff_list %}
                            <div class="staff-member">
                                <div class="staff-info">
                                    <span class="staff-name">{{ staff_data.staff.first_name }} {{ staff_data.staff.last_name }}</span>
                                    <span class="staff-sap">{{ staff_data.staff.sap }}</span>
                                </div>
                                <div class="contracted-shifts">
                                    {{ staff_data.contracted_shifts }} shifts/week
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-staff">No night shift staff assigned to this unit as home base</div>
                {% endif %}
            </div>
        </div>
    </div>
    {% empty %}
    <div class="alert alert-info">
        <h4>No units found</h4>
        <p>No care units are currently configured in the system.</p>
    </div>
    {% endfor %}

    <!-- Staff without Home Units -->
    {% if staff_without_home_units > 0 %}
    <div class="alert alert-warning">
        <h5><i class="fas fa-exclamation-triangle"></i> Staff without Home Units</h5>
        <p>{{ staff_without_home_units }} SCW/SCA staff members do not have a home unit assigned. These staff may need to be allocated to base units for better organization.</p>
        <a href="{% url 'add_staff' %}" class="btn btn-warning btn-sm">Manage Staff Assignments</a>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add smooth scrolling for better UX
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelector(this.getAttribute('href')).scrollIntoView({
                behavior: 'smooth'
            });
        });
    });
    
    // Add click handlers for staff members to show more details
    document.querySelectorAll('.staff-member').forEach(member => {
        member.addEventListener('click', function() {
            // Future enhancement: show staff details modal
            console.log('Staff member clicked:', this.querySelector('.staff-name').textContent);
        });
    });
});
</script>
{% endblock %}
 
                                                    {{ staff_info.staff.annual_leave_allowance }} days
                                                </small>
                                                <a href="{% url 'staff_detail' staff_info.staff.sap %}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i> View
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Show recent workers from other units if any -->
                        {% if unit.recent_workers %}
                        <div class="mt-3">
                            <h6 class="text-warning">
                                <i class="fas fa-exchange-alt"></i> Recent Workers from Other Units
                            </h6>
                            <div class="row">
                                {% for worker in unit.recent_workers %}
                                <div class="col-md-4 col-lg-3 mb-2">
                                    <div class="card border-warning">
                                        <div class="card-body py-2">
                                            <small>
                                                <strong>{{ worker.full_name }}</strong> ({{ worker.sap }})<br>
                                                <span class="badge badge-secondary">{{ worker.role.name }}</span>
                                                from {{ worker.unit.get_name_display }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> No staff currently assigned to this unit.
                        </div>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        
        <!-- Role-specific tabs -->
        {% for role in roles %}
        <div class="tab-pane fade" id="{{ role.name|lower }}-staff" role="tabpanel">
            <div class="row">
                {% for staff in role.staff_list %}
                <div class="col-md-4 col-lg-3 mb-3">
                    <div class="card staff-card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">{{ staff.full_name }}</h6>
                                <div>
                                    <span class="badge role-badge role-{{ role.name|lower }}">
                                        {{ role.name }}
                                    </span>
                                    {% if staff.team %}
                                    <span class="badge team-badge team-{{ staff.team|lower }}">
                                        Team {{ staff.team|upper }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <p class="text-muted small mb-1">
                                <i class="fas fa-id-badge"></i> {{ staff.sap }}
                            </p>
                            
                            {% if staff.home_unit %}
                            <p class="text-muted small mb-1">
                                <i class="fas fa-home"></i> <strong>Home:</strong> {{ staff.home_unit.get_name_display }}
                            </p>
                            {% endif %}
                            
                            {% if staff.unit %}
                            <p class="text-muted small mb-1">
                                <i class="fas fa-building"></i> <strong>Current:</strong> {{ staff.unit.get_name_display }}
                                {% if staff.unit != staff.home_unit %}
                                <span class="badge badge-warning ml-1">Deployed</span>
                                {% endif %}
                            </p>
                            {% endif %}
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-calendar-check"></i> 
                                    {{ staff.annual_leave_allowance }} days
                                </small>
                                <a href="{% url 'staff_detail' staff.sap %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-users"></i> No {{ role.get_name_display }} staff found.
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Search functionality
    document.getElementById('staffSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const staffMembers = document.querySelectorAll('.staff-member');
        
        staffMembers.forEach(function(member) {
            const name = member.dataset.name;
            const sap = member.dataset.sap.toLowerCase();
            const role = member.dataset.role.toLowerCase();
            
            if (name.includes(searchTerm) || sap.includes(searchTerm) || role.includes(searchTerm)) {
                member.style.display = 'block';
            } else {
                member.style.display = 'none';
            }
        });
    });

    // Role filter functionality
    document.querySelectorAll('.filter-role').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const filterRole = this.dataset.role.toLowerCase();
            const staffMembers = document.querySelectorAll('.staff-member');
            
            staffMembers.forEach(function(member) {
                const memberRole = member.dataset.role.toLowerCase();
                
                if (filterRole === 'all' || memberRole === filterRole) {
                    member.style.display = 'block';
                } else {
                    member.style.display = 'none';
                }
            });
        });
    });
</script>
{% endblock %}