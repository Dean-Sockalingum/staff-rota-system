# Generated by Django 4.2.27 on 2026-01-14 10:24

from django.conf import settings
import django.core.validators
from django.db import migrations, models
import django.db.models.deletion
import django.utils.timezone


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('scheduling', '0058_alter_user_sms_notifications_enabled'),
    ]

    operations = [
        migrations.CreateModel(
            name='RootCauseAnalysis',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('analysis_method', models.CharField(choices=[('5_WHYS', '5 Whys'), ('FISHBONE', 'Fishbone Diagram'), ('SWARM', 'SWARM Analysis'), ('TIMELINE', 'Timeline Analysis'), ('BARRIER', 'Barrier Analysis')], default='5_WHYS', max_length=20)),
                ('status', models.CharField(choices=[('IN_PROGRESS', 'In Progress'), ('UNDER_REVIEW', 'Under Review'), ('APPROVED', 'Approved'), ('REJECTED', 'Rejected - Needs Revision')], default='IN_PROGRESS', max_length=20)),
                ('investigation_start_date', models.DateField(default=django.utils.timezone.now)),
                ('investigation_end_date', models.DateField(blank=True, null=True)),
                ('review_due_date', models.DateField(blank=True, help_text='Date when this RCA should be reviewed', null=True)),
                ('why_1', models.TextField(blank=True, help_text='Why did this incident happen?', verbose_name='Why 1 - First Level')),
                ('why_2', models.TextField(blank=True, help_text='Why did the first cause occur?', verbose_name='Why 2 - Second Level')),
                ('why_3', models.TextField(blank=True, help_text='Why did the second cause occur?', verbose_name='Why 3 - Third Level')),
                ('why_4', models.TextField(blank=True, help_text='Why did the third cause occur?', verbose_name='Why 4 - Fourth Level')),
                ('why_5', models.TextField(blank=True, help_text='Why did the fourth cause occur? (Root cause identified)', verbose_name='Why 5 - Root Cause')),
                ('factor_people', models.TextField(blank=True, help_text='Staff training, competence, workload, communication', verbose_name='People Factors')),
                ('factor_environment', models.TextField(blank=True, help_text='Physical environment, equipment, facilities', verbose_name='Environment Factors')),
                ('factor_processes', models.TextField(blank=True, help_text='Procedures, protocols, workflows, documentation', verbose_name='Process Factors')),
                ('factor_organization', models.TextField(blank=True, help_text='Management, policies, culture, resources', verbose_name='Organizational Factors')),
                ('factor_external', models.TextField(blank=True, help_text='Regulations, suppliers, weather, external events', verbose_name='External Factors')),
                ('root_cause_summary', models.TextField(help_text='Clear statement of identified root cause(s)')),
                ('lessons_learned', models.TextField(help_text='Key lessons from this investigation')),
                ('recommendations', models.TextField(help_text='Specific recommendations to prevent recurrence')),
                ('evidence_reviewed', models.TextField(blank=True, help_text='List of evidence reviewed (documents, interviews, data)')),
                ('attachments', models.JSONField(blank=True, default=list, help_text='File paths or URLs to supporting documents')),
                ('approved_date', models.DateField(blank=True, null=True)),
                ('approval_comments', models.TextField(blank=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('approved_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='rca_approved', to=settings.AUTH_USER_MODEL)),
                ('incident', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='root_cause_analysis', to='scheduling.incidentreport')),
                ('investigation_team', models.ManyToManyField(blank=True, related_name='rca_investigations_participated', to=settings.AUTH_USER_MODEL)),
                ('lead_investigator', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='rca_investigations_led', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Root Cause Analysis',
                'verbose_name_plural': 'Root Cause Analyses',
                'ordering': ['-investigation_start_date'],
            },
        ),
        migrations.CreateModel(
            name='DutyOfCandourRecord',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('duty_of_candour_applies', models.BooleanField(default=False, help_text='Does this incident meet DoC criteria?')),
                ('harm_level', models.CharField(choices=[('DEATH', 'Death'), ('SEVERE', 'Severe Harm'), ('MODERATE', 'Moderate Harm'), ('LOW', 'Low Harm'), ('NONE', 'No Harm')], help_text='Level of harm to inform DoC requirement', max_length=20)),
                ('assessment_rationale', models.TextField(help_text="Why does/doesn't DoC apply to this incident?")),
                ('assessment_date', models.DateField(default=django.utils.timezone.now)),
                ('family_contact_name', models.CharField(blank=True, help_text='Primary family contact for DoC communications', max_length=200)),
                ('family_contact_relationship', models.CharField(blank=True, help_text='e.g., Daughter, Son, Power of Attorney', max_length=100)),
                ('family_contact_phone', models.CharField(blank=True, max_length=20)),
                ('family_contact_email', models.EmailField(blank=True, max_length=254)),
                ('family_preferred_contact_method', models.CharField(blank=True, choices=[('PHONE', 'Phone Call'), ('EMAIL', 'Email'), ('IN_PERSON', 'In-Person Meeting'), ('LETTER', 'Written Letter')], max_length=50)),
                ('notification_date', models.DateField(blank=True, help_text='Date family was first notified', null=True)),
                ('notification_method', models.CharField(blank=True, max_length=50)),
                ('notification_details', models.TextField(blank=True, help_text='Summary of initial notification conversation')),
                ('apology_provided', models.BooleanField(default=False)),
                ('apology_date', models.DateField(blank=True, null=True)),
                ('apology_method', models.CharField(blank=True, choices=[('VERBAL', 'Verbal Apology'), ('WRITTEN', 'Written Letter'), ('BOTH', 'Verbal and Written')], max_length=50)),
                ('apology_letter_sent', models.BooleanField(default=False)),
                ('apology_letter_file', models.FileField(blank=True, null=True, upload_to='duty_of_candour/apology_letters/')),
                ('investigation_findings_shared', models.BooleanField(default=False)),
                ('findings_shared_date', models.DateField(blank=True, null=True)),
                ('findings_summary_provided', models.TextField(blank=True, help_text='Summary of investigation findings shared with family')),
                ('actions_shared_with_family', models.BooleanField(default=False)),
                ('actions_shared_date', models.DateField(blank=True, null=True)),
                ('actions_summary', models.TextField(blank=True, help_text='Summary of corrective actions shared with family')),
                ('follow_up_offered', models.BooleanField(default=False)),
                ('follow_up_date', models.DateField(blank=True, null=True)),
                ('follow_up_notes', models.TextField(blank=True, help_text='Notes from follow-up meeting/contact with family')),
                ('family_questions_addressed', models.TextField(blank=True, help_text='Questions raised by family and responses')),
                ('current_stage', models.CharField(choices=[('ASSESSMENT', 'Assessment - Determining if DoC applies'), ('NOTIFICATION', 'Notification - Initial contact with family'), ('APOLOGY', 'Apology - Formal apology provided'), ('INVESTIGATION', 'Investigation - Incident being investigated'), ('FEEDBACK', 'Feedback - Findings shared with family'), ('REVIEW', 'Review - Follow-up with family'), ('COMPLETE', 'Complete - All requirements met')], default='ASSESSMENT', max_length=20)),
                ('all_requirements_met', models.BooleanField(default=False, help_text='All DoC requirements completed?')),
                ('completion_date', models.DateField(blank=True, null=True)),
                ('communication_log', models.JSONField(blank=True, default=list, help_text='Log of all communications with family (dates, method, summary)')),
                ('reported_to_care_inspectorate', models.BooleanField(default=False)),
                ('ci_report_date', models.DateField(blank=True, null=True)),
                ('ci_reference', models.CharField(blank=True, max_length=100)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('assessed_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='doc_assessments', to=settings.AUTH_USER_MODEL)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='doc_records_created', to=settings.AUTH_USER_MODEL)),
                ('incident', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='duty_of_candour', to='scheduling.incidentreport')),
                ('notification_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='doc_notifications_made', to=settings.AUTH_USER_MODEL)),
                ('resident', models.ForeignKey(blank=True, help_text='Resident affected (if applicable)', null=True, on_delete=django.db.models.deletion.SET_NULL, to='scheduling.resident')),
            ],
            options={
                'verbose_name': 'Duty of Candour Record',
                'verbose_name_plural': 'Duty of Candour Records',
                'ordering': ['-incident__incident_date'],
            },
        ),
        migrations.CreateModel(
            name='CorrectivePreventiveAction',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('reference_number', models.CharField(help_text='e.g., CAPA-2026-001', max_length=50, unique=True)),
                ('action_type', models.CharField(choices=[('CORRECTIVE', 'Corrective Action - Fix existing problem'), ('PREVENTIVE', 'Preventive Action - Prevent future problems'), ('IMPROVEMENT', 'Improvement Action - Enhance process')], max_length=20)),
                ('priority', models.CharField(choices=[('IMMEDIATE', 'Immediate (24 hours)'), ('HIGH', 'High (1 week)'), ('MEDIUM', 'Medium (1 month)'), ('LOW', 'Low (3 months)')], max_length=20)),
                ('status', models.CharField(choices=[('IDENTIFIED', 'Identified'), ('ASSIGNED', 'Assigned'), ('IN_PROGRESS', 'In Progress'), ('COMPLETED', 'Completed - Awaiting Verification'), ('VERIFIED', 'Verified Effective'), ('NOT_EFFECTIVE', 'Not Effective - Needs Revision'), ('CLOSED', 'Closed')], default='IDENTIFIED', max_length=20)),
                ('problem_statement', models.TextField(help_text='What problem is this action addressing?')),
                ('action_description', models.TextField(help_text='Detailed description of the action to be taken')),
                ('expected_outcome', models.TextField(help_text='What success looks like')),
                ('identified_date', models.DateField(default=django.utils.timezone.now)),
                ('target_completion_date', models.DateField()),
                ('actual_completion_date', models.DateField(blank=True, null=True)),
                ('implementation_plan', models.TextField(blank=True, help_text='Step-by-step plan for implementing this action')),
                ('resources_required', models.TextField(blank=True, help_text='Budget, staff time, equipment needed')),
                ('barriers_identified', models.TextField(blank=True, help_text='Potential obstacles to implementation')),
                ('percent_complete', models.IntegerField(default=0, validators=[django.core.validators.MinValueValidator(0), django.core.validators.MaxValueValidator(100)])),
                ('progress_notes', models.TextField(blank=True, help_text='Regular updates on progress')),
                ('verification_method', models.TextField(blank=True, help_text='How will we verify this action is effective?')),
                ('verification_date', models.DateField(blank=True, null=True)),
                ('verification_outcome', models.TextField(blank=True, help_text='Was the action effective? Evidence?')),
                ('effectiveness_review_due', models.DateField(blank=True, null=True)),
                ('effectiveness_review_completed', models.BooleanField(default=False)),
                ('effectiveness_review_notes', models.TextField(blank=True, help_text='Long-term effectiveness assessment')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('action_owner', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='capa_actions_owned', to=settings.AUTH_USER_MODEL)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='capa_actions_created', to=settings.AUTH_USER_MODEL)),
                ('incident', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='capa_actions', to='scheduling.incidentreport')),
                ('root_cause_analysis', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='capa_actions', to='incident_safety.rootcauseanalysis')),
                ('supporting_staff', models.ManyToManyField(blank=True, related_name='capa_actions_supporting', to=settings.AUTH_USER_MODEL)),
                ('verified_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='capa_actions_verified', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Corrective/Preventive Action',
                'verbose_name_plural': 'Corrective/Preventive Actions',
                'ordering': ['priority', 'target_completion_date'],
            },
        ),
        migrations.CreateModel(
            name='IncidentTrendAnalysis',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('period_type', models.CharField(choices=[('WEEKLY', 'Weekly'), ('MONTHLY', 'Monthly'), ('QUARTERLY', 'Quarterly'), ('ANNUAL', 'Annual')], max_length=20)),
                ('start_date', models.DateField()),
                ('end_date', models.DateField()),
                ('total_incidents', models.IntegerField(default=0)),
                ('incidents_by_type', models.JSONField(default=dict, help_text='Count of each incident type')),
                ('incidents_by_severity', models.JSONField(default=dict, help_text='Count of each severity level')),
                ('trend_vs_previous_period', models.CharField(blank=True, choices=[('INCREASING', 'Increasing'), ('STABLE', 'Stable'), ('DECREASING', 'Decreasing')], max_length=20)),
                ('percentage_change', models.DecimalField(blank=True, decimal_places=2, help_text='Percentage change vs previous period', max_digits=5, null=True)),
                ('most_common_incident_type', models.CharField(blank=True, max_length=50)),
                ('most_common_location', models.CharField(blank=True, max_length=200)),
                ('peak_incident_times', models.JSONField(default=list, help_text='Time of day when most incidents occur')),
                ('average_staffing_level', models.DecimalField(blank=True, decimal_places=2, max_digits=5, null=True)),
                ('incidents_during_low_staffing', models.IntegerField(default=0, help_text='Incidents during below-average staffing')),
                ('key_findings', models.TextField(help_text='Summary of key findings from analysis')),
                ('recommendations', models.TextField(help_text='Recommended actions based on trends')),
                ('improvement_actions_created', models.IntegerField(default=0, help_text='Number of PDSA/CAPA actions created from this analysis')),
                ('generated_date', models.DateField(auto_now_add=True)),
                ('care_home', models.ForeignKey(blank=True, help_text='Leave blank for organization-wide analysis', null=True, on_delete=django.db.models.deletion.CASCADE, to='scheduling.carehome')),
                ('generated_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='trend_analyses_generated', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Incident Trend Analysis',
                'verbose_name_plural': 'Incident Trend Analyses',
                'ordering': ['-end_date'],
                'unique_together': {('period_type', 'start_date', 'end_date', 'care_home')},
            },
        ),
    ]
