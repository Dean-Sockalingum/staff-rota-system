{% extends 'scheduling/base.html' %}
{% load static %}

{% block title %}Delete RCA {{ rca.reference_number }}?{% endblock %}

{% block extra_css %}
<style>
    .gradient-header {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px 10px 0 0;
        margin: -1.5rem -1.5rem 1.5rem -1.5rem;
    }
    
    .warning-icon {
        font-size: 4rem;
        color: #ef4444;
        margin-bottom: 1rem;
    }
    
    .delete-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        padding: 2rem;
        max-width: 700px;
        margin: 0 auto;
    }
    
    .rca-details {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        border-left: 4px solid #667eea;
    }
    
    .rca-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .detail-item {
        margin-bottom: 0.5rem;
    }
    
    .detail-label {
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .detail-value {
        font-size: 1rem;
        color: #1f2937;
        font-weight: 600;
    }
    
    .consequences-list {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 1.5rem;
        border-radius: 8px;
        margin: 1.5rem 0;
    }
    
    .consequences-list h5 {
        color: #92400e;
        font-weight: 700;
        margin-bottom: 1rem;
    }
    
    .consequences-list ul {
        margin-bottom: 0;
    }
    
    .consequences-list li {
        margin-bottom: 0.5rem;
        color: #78350f;
    }
    
    .action-plans-warning {
        background: #fee2e2;
        border-left: 4px solid #ef4444;
        padding: 1.5rem;
        border-radius: 8px;
        margin: 1.5rem 0;
    }
    
    .action-plans-warning h5 {
        color: #991b1b;
        font-weight: 700;
        margin-bottom: 1rem;
    }
    
    .action-plan-item {
        background: white;
        padding: 0.75rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        border-left: 3px solid #667eea;
    }
    
    .alternatives-box {
        background: #dbeafe;
        border-left: 4px solid #3b82f6;
        padding: 1.5rem;
        border-radius: 8px;
        margin: 1.5rem 0;
    }
    
    .alternatives-box h5 {
        color: #1e40af;
        font-weight: 700;
        margin-bottom: 1rem;
    }
    
    .alternatives-box ul {
        margin-bottom: 0.5rem;
    }
    
    .alternatives-box li {
        margin-bottom: 0.5rem;
        color: #1e3a8a;
    }
    
    .btn-delete-confirm {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border: none;
        color: white;
        font-weight: 600;
        padding: 0.75rem 2rem;
    }
    
    .btn-delete-confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        color: white;
    }
    
    .btn-cancel {
        background-color: #6b7280;
        border-color: #6b7280;
        color: white;
        font-weight: 600;
        padding: 0.75rem 2rem;
    }
    
    .btn-cancel:hover {
        background-color: #4b5563;
        border-color: #4b5563;
        color: white;
    }
    
    .approved-warning {
        background: #fee2e2;
        border: 2px solid #ef4444;
        padding: 1.5rem;
        border-radius: 8px;
        margin: 1.5rem 0;
    }
    
    .approved-warning h5 {
        color: #991b1b;
        font-weight: 700;
        margin-bottom: 0.75rem;
    }
    
    .approved-warning p {
        margin-bottom: 0;
        color: #7f1d1d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="delete-card">
        <!-- Header -->
        <div class="gradient-header">
            <div class="text-center">
                <i class="bi bi-shield-x"></i>
                <h2 class="mb-0">Delete Root Cause Analysis</h2>
            </div>
        </div>

        <!-- Warning Icon -->
        <div class="text-center">
            <i class="bi bi-exclamation-triangle-fill warning-icon"></i>
            <h4 class="text-danger fw-bold">Are you sure you want to delete this RCA?</h4>
            <p class="text-muted">This action cannot be undone.</p>
        </div>

        <!-- RCA Details -->
        <div class="rca-details">
            <h5 class="mb-3"><i class="bi bi-file-text me-2"></i>RCA Details</h5>
            <div class="rca-details-grid">
                <div class="detail-item">
                    <div class="detail-label">Reference Number</div>
                    <div class="detail-value">{{ rca.reference_number }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Incident</div>
                    <div class="detail-value">{{ rca.incident.reference_number }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Lead Investigator</div>
                    <div class="detail-value">{{ rca.lead_investigator.get_full_name }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Investigation Date</div>
                    <div class="detail-value">{{ rca.investigation_date|date:"d M Y" }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Status</div>
                    <div class="detail-value">{{ rca.get_status_display }}</div>
                </div>
                {% if rca.root_cause_statement %}
                <div class="detail-item" style="grid-column: 1 / -1;">
                    <div class="detail-label">Root Cause Statement</div>
                    <div class="detail-value">{{ rca.root_cause_statement|truncatewords:20 }}</div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Linked Action Plans Warning -->
        {% if rca.safety_action_plans.exists %}
        <div class="action-plans-warning">
            <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Linked Health and Safety Action Plans</h5>
            <p class="mb-3">
                <strong>Warning:</strong> This RCA has {{ rca.safety_action_plans.count }} linked Health and Safety Action Plan(s).
                Deleting this RCA will remove the link to these plans, but the plans themselves will not be deleted.
            </p>
            {% for plan in rca.safety_action_plans.all %}
                <div class="action-plan-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ plan.reference_number }}</strong>
                            <div class="small text-muted">{{ plan.action_description|truncatewords:10 }}</div>
                        </div>
                        <div>
                            <span class="badge bg-{{ plan.priority|lower }}">{{ plan.get_priority_display }}</span>
                            <span class="badge bg-secondary">{{ plan.get_status_display }}</span>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Approved RCA Warning -->
        {% if rca.status == 'APPROVED' %}
        <div class="approved-warning">
            <h5><i class="bi bi-shield-exclamation me-2"></i>Approved Investigation</h5>
            <p>
                <strong>Important:</strong> This RCA has been approved by {{ rca.approved_by.get_full_name }} on 
                {{ rca.approval_date|date:"d M Y" }}. Deleting an approved investigation may impact compliance
                and regulatory records. Consider archiving instead of deleting.
            </p>
        </div>
        {% endif %}

        <!-- Consequences -->
        <div class="consequences-list">
            <h5><i class="bi bi-info-circle-fill me-2"></i>What will be deleted:</h5>
            <ul>
                <li>All investigation details (5 Whys analysis, Fishbone categories)</li>
                <li>Root cause statement and findings</li>
                <li>Lessons learned documentation</li>
                <li>Recommendations for improvement</li>
                <li>Investigation team assignments</li>
                <li>All approval records (if approved)</li>
                <li>Links to Health and Safety Action Plans (plans themselves remain)</li>
                <li>Complete audit trail for this RCA</li>
            </ul>
            <p class="mb-0 mt-3">
                <strong>Note:</strong> The original incident record will <u>not</u> be deleted and remains in the system.
            </p>
        </div>

        <!-- Alternatives -->
        <div class="alternatives-box">
            <h5><i class="bi bi-lightbulb-fill me-2"></i>Consider these alternatives:</h5>
            <ul>
                <li><strong>Update the status</strong> - Mark the RCA as "Completed" or "Approved" instead of deleting</li>
                <li><strong>Add notes</strong> - Document why the investigation is no longer needed in the notes field</li>
                <li><strong>Archive</strong> - Keep the record for compliance but mark it as archived (contact system admin)</li>
                <li><strong>Review with Quality Manager</strong> - Discuss whether deletion is truly necessary</li>
            </ul>
            <p class="mb-0">
                <a href="{% url 'incident_safety:rca_update' rca.pk %}" class="btn btn-sm btn-primary">
                    <i class="bi bi-pencil"></i> Edit RCA Instead
                </a>
            </p>
        </div>

        <!-- Confirmation Message -->
        {% if rca.status == 'APPROVED' or rca.safety_action_plans.exists %}
        <div class="alert alert-danger mt-4">
            <i class="bi bi-exclamation-octagon-fill me-2"></i>
            <strong>Additional Confirmation Required:</strong>
            Due to the significance of this RCA (approved status or linked action plans), please confirm that you
            have consulted with the Quality Manager before proceeding with deletion.
        </div>
        {% endif %}

        <!-- Delete Form -->
        <form method="post" class="mt-4">
            {% csrf_token %}
            <div class="d-flex gap-3 justify-content-center">
                <a href="{% url 'incident_safety:rca_detail' rca.pk %}" class="btn btn-cancel">
                    <i class="bi bi-x-circle"></i> Cancel
                </a>
                <button type="submit" class="btn btn-delete-confirm">
                    <i class="bi bi-trash"></i> Yes, Delete RCA
                </button>
            </div>
        </form>

        <!-- Final Warning -->
        <div class="text-center mt-4">
            <small class="text-muted">
                <i class="bi bi-info-circle"></i>
                Deletion will be logged in the system audit trail for compliance purposes
            </small>
        </div>
    </div>
</div>
{% endblock %}
