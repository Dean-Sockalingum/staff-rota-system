{% extends 'scheduling/base.html' %}
{% load static %}

{% block title %}Safety Action Plan - {{ capa.reference_number }}{% endblock %}

{% block extra_css %}
<style>
    .detail-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }

    .section-card {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .info-item {
        padding: 1rem;
        background: #f9fafb;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }

    .info-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 0.25rem;
    }

    .info-value {
        font-size: 1rem;
        color: #1f2937;
    }

    .priority-badge {
        padding: 6px 14px;
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .priority-immediate { background: #fee2e2; color: #991b1b; }
    .priority-high { background: #fed7aa; color: #9a3412; }
    .priority-medium { background: #fef3c7; color: #854d0e; }
    .priority-low { background: #d1fae5; color: #065f46; }

    .status-badge {
        padding: 6px 14px;
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .status-identified { background: #e0e7ff; color: #3730a3; }
    .status-planned { background: #dbeafe; color: #1e40af; }
    .status-in-progress { background: #fef3c7; color: #854d0e; }
    .status-implemented { background: #d1fae5; color: #065f46; }
    .status-verified { background: #e0e7ff; color: #5b21b6; }
    .status-effective { background: #d1fae5; color: #065f46; }
    .status-closed { background: #f3f4f6; color: #374151; }

    .action-type-badge {
        padding: 6px 14px;
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .type-corrective { background: #fee2e2; color: #991b1b; }
    .type-preventive { background: #dbeafe; color: #1e40af; }
    .type-improvement { background: #d1fae5; color: #065f46; }

    .progress-section {
        background: #f9fafb;
        padding: 1.5rem;
        border-radius: 8px;
        margin: 1.5rem 0;
    }

    .progress-bar-large {
        height: 30px;
        background: #e5e7eb;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }

    .progress-bar-fill-large {
        height: 100%;
        background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 1rem;
        color: white;
        font-weight: 600;
        transition: width 0.5s ease;
    }

    .text-content {
        background: #f9fafb;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        margin: 1rem 0;
        line-height: 1.6;
    }

    .team-list {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
    }

    .team-member {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #eff6ff;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        border: 2px solid #dbeafe;
    }

    .team-member-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }

    .verification-panel {
        background: #eff6ff;
        border: 2px solid #3b82f6;
        padding: 1.5rem;
        border-radius: 8px;
        margin: 1.5rem 0;
    }

    .verification-panel.success {
        background: #d1fae5;
        border-color: #10b981;
    }

    .verification-panel.warning {
        background: #fef3c7;
        border-color: #f59e0b;
    }

    .timeline-item {
        padding: 1rem;
        background: #f9fafb;
        border-radius: 8px;
        border-left: 4px solid #10b981;
        margin-bottom: 1rem;
    }

    .timeline-date {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.25rem;
    }

    .timeline-event {
        font-weight: 600;
        color: #1f2937;
    }

    .btn-custom {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-block;
        border: none;
    }

    .btn-primary-custom {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .btn-success-custom {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .btn-warning-custom {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }

    .btn-danger-custom {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    .btn-secondary-custom {
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 2rem;
    }

    .sidebar-card {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }

    .sidebar-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e5e7eb;
    }

    .effectiveness-rating {
        display: flex;
        gap: 0.25rem;
        font-size: 1.5rem;
    }

    .star-filled {
        color: #fbbf24;
    }

    .star-empty {
        color: #d1d5db;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="detail-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="mb-2">
                    <i class="bi bi-shield-check"></i> Health and Safety Action Plan
                </h1>
                <h3 class="mb-3">{{ capa.reference_number }}</h3>
                <div class="d-flex gap-2 flex-wrap">
                    <span class="priority-badge priority-{{ capa.priority|lower }}">
                        {{ capa.get_priority_display }} Priority
                    </span>
                    <span class="status-badge status-{{ capa.status|lower|cut:'_' }}">
                        {{ capa.get_status_display }}
                    </span>
                    <span class="action-type-badge type-{{ capa.action_type|lower }}">
                        {{ capa.get_action_type_display }} Action
                    </span>
                </div>
            </div>
            <div class="text-end text-white-50">
                Created: {{ capa.created_at|date:"d M Y" }}
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Problem & Action -->
            <div class="section-card">
                <div class="section-title">
                    <i class="bi bi-exclamation-diamond"></i> Problem & Action
                </div>
                
                <h5 class="mb-2">Problem Statement</h5>
                <div class="text-content">
                    {{ capa.problem_statement }}
                </div>

                <h5 class="mb-2 mt-4">Action Description</h5>
                <div class="text-content">
                    {{ capa.action_description }}
                </div>

                <h5 class="mb-2 mt-4">Expected Outcome</h5>
                <div class="text-content">
                    {{ capa.expected_outcome }}
                </div>
            </div>

            <!-- Progress -->
            <div class="section-card">
                <div class="section-title">
                    <i class="bi bi-bar-chart"></i> Implementation Progress
                </div>
                
                <div class="progress-section">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-bold">Completion Status</span>
                        <span class="fw-bold">{{ capa.percent_complete }}%</span>
                    </div>
                    <div class="progress-bar-large">
                        <div class="progress-bar-fill-large" style="width: {{ capa.percent_complete }}%;">
                            {{ capa.percent_complete }}%
                        </div>
                    </div>
                </div>

                {% if capa.implementation_plan %}
                <h5 class="mb-2 mt-4">Implementation Plan</h5>
                <div class="text-content">
                    {{ capa.implementation_plan }}
                </div>
                {% endif %}

                {% if capa.implementation_evidence %}
                <h5 class="mb-2 mt-4">Implementation Evidence</h5>
                <div class="text-content">
                    {{ capa.implementation_evidence }}
                </div>
                {% endif %}
            </div>

            <!-- Verification -->
            {% if capa.status in 'VERIFIED,EFFECTIVE,CLOSED' %}
            <div class="section-card">
                <div class="section-title">
                    <i class="bi bi-check-circle"></i> Verification
                </div>

                <div class="verification-panel {% if capa.verification_outcome == 'EFFECTIVE' %}success{% elif capa.verification_outcome == 'PARTIALLY_EFFECTIVE' %}warning{% endif %}">
                    <h5 class="mb-3">Verification Results</h5>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Verified By</div>
                            <div class="info-value">{{ capa.verified_by.get_full_name }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Verification Date</div>
                            <div class="info-value">{{ capa.verification_date|date:"d M Y" }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Outcome</div>
                            <div class="info-value">{{ capa.get_verification_outcome_display }}</div>
                        </div>
                    </div>

                    {% if capa.verification_notes %}
                    <h6 class="mt-3 mb-2">Verification Notes</h6>
                    <div class="text-content">
                        {{ capa.verification_notes }}
                    </div>
                    {% endif %}
                </div>

                {% if capa.effectiveness_review_date %}
                <h5 class="mb-2 mt-4">Effectiveness Review</h5>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Review Date</div>
                        <div class="info-value">{{ capa.effectiveness_review_date|date:"d M Y" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Reviewer</div>
                        <div class="info-value">{{ capa.effectiveness_reviewed_by.get_full_name }}</div>
                    </div>
                </div>
                {% if capa.effectiveness_notes %}
                <div class="text-content mt-3">
                    {{ capa.effectiveness_notes }}
                </div>
                {% endif %}
                {% endif %}
            </div>
            {% endif %}

            <!-- Resources & Barriers -->
            <div class="section-card">
                <div class="section-title">
                    <i class="bi bi-tools"></i> Resources & Barriers
                </div>

                {% if capa.resources_required %}
                <h5 class="mb-2">Resources Required</h5>
                <div class="text-content">
                    {{ capa.resources_required }}
                </div>
                {% endif %}

                {% if capa.barriers_identified %}
                <h5 class="mb-2 mt-4">Barriers Identified</h5>
                <div class="text-content">
                    {{ capa.barriers_identified }}
                </div>
                {% endif %}

                {% if capa.verification_method %}
                <h5 class="mb-2 mt-4">Verification Method</h5>
                <div class="text-content">
                    {{ capa.verification_method }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="sidebar-card">
                <div class="sidebar-title">
                    <i class="bi bi-lightning"></i> Quick Actions
                </div>
                <div class="d-grid gap-2">
                    <a href="{% url 'incident_safety:action_plan_update' capa.pk %}" class="btn btn-warning-custom">
                        <i class="bi bi-pencil"></i> Edit Plan
                    </a>
                    {% if capa.status == 'IMPLEMENTED' %}
                    <a href="{% url 'incident_safety:action_plan_verify' capa.pk %}" class="btn btn-success-custom">
                        <i class="bi bi-check-circle"></i> Verify Action
                    </a>
                    {% endif %}
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-exclamation-triangle"></i> <strong>{{ capa.incident.reference_number }}</strong>
                    </div>
                    {% if capa.root_cause_analysis %}
                    <a href="{% url 'incident_safety:rca_detail' capa.root_cause_analysis.pk %}" class="btn btn-primary-custom">
                        <i class="bi bi-diagram-3"></i> View RCA
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Key Details -->
            <div class="sidebar-card">
                <div class="sidebar-title">
                    <i class="bi bi-info-circle"></i> Key Details
                </div>
                <div class="info-item mb-2">
                    <div class="info-label">Linked Incident</div>
                    <div class="info-value">
                        <strong>{{ capa.incident.reference_number }}</strong>
                    </div>
                </div>
                {% if capa.root_cause_analysis %}
                <div class="info-item mb-2">
                    <div class="info-label">Linked RCA</div>
                    <div class="info-value">
                        <a href="{% url 'incident_safety:rca_detail' capa.root_cause_analysis.pk %}">
                            {{ capa.root_cause_analysis.reference_number }}
                        </a>
                    </div>
                </div>
                {% endif %}
                <div class="info-item mb-2">
                    <div class="info-label">Target Date</div>
                    <div class="info-value">
                        {{ capa.target_completion_date|date:"d M Y" }}
                        {% if capa.is_overdue %}
                            <span class="text-danger fw-bold">
                                <i class="bi bi-exclamation-circle"></i> Overdue
                            </span>
                        {% endif %}
                    </div>
                </div>
                {% if capa.actual_completion_date %}
                <div class="info-item mb-2">
                    <div class="info-label">Completed</div>
                    <div class="info-value">{{ capa.actual_completion_date|date:"d M Y" }}</div>
                </div>
                {% endif %}
            </div>

            <!-- Team -->
            <div class="sidebar-card">
                <div class="sidebar-title">
                    <i class="bi bi-people"></i> Team
                </div>
                <div class="info-item mb-3">
                    <div class="info-label">Action Owner</div>
                    <div class="team-member">
                        <div class="team-member-icon">
                            {{ capa.action_owner.first_name.0 }}{{ capa.action_owner.last_name.0 }}
                        </div>
                        <span>{{ capa.action_owner.get_full_name }}</span>
                    </div>
                </div>

                {% if capa.supporting_staff.exists %}
                <div class="info-label mb-2">Supporting Staff</div>
                <div class="team-list">
                    {% for staff in capa.supporting_staff.all %}
                    <div class="team-member">
                        <div class="team-member-icon">
                            {{ staff.first_name.0 }}{{ staff.last_name.0 }}
                        </div>
                        <span>{{ staff.get_full_name }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Timestamps -->
            <div class="sidebar-card">
                <div class="sidebar-title">
                    <i class="bi bi-clock-history"></i> Timeline
                </div>
                <div class="timeline-item">
                    <div class="timeline-date">{{ capa.created_at|date:"d M Y H:i" }}</div>
                    <div class="timeline-event">Action Plan Created</div>
                </div>
                {% if capa.updated_at != capa.created_at %}
                <div class="timeline-item">
                    <div class="timeline-date">{{ capa.updated_at|date:"d M Y H:i" }}</div>
                    <div class="timeline-event">Last Updated</div>
                </div>
                {% endif %}
                {% if capa.actual_completion_date %}
                <div class="timeline-item">
                    <div class="timeline-date">{{ capa.actual_completion_date|date:"d M Y" }}</div>
                    <div class="timeline-event">Action Completed</div>
                </div>
                {% endif %}
                {% if capa.verification_date %}
                <div class="timeline-item">
                    <div class="timeline-date">{{ capa.verification_date|date:"d M Y" }}</div>
                    <div class="timeline-event">Action Verified</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <a href="{% url 'incident_safety:action_plan_list' %}" class="btn-custom btn-secondary-custom">
            <i class="bi bi-arrow-left"></i> Back to List
        </a>
        <a href="{% url 'incident_safety:action_plan_update' capa.pk %}" class="btn-custom btn-warning-custom">
            <i class="bi bi-pencil"></i> Edit
        </a>
        <a href="{% url 'incident_safety:action_plan_delete' capa.pk %}" class="btn-custom btn-danger-custom">
            <i class="bi bi-trash"></i> Delete
        </a>
    </div>
</div>
{% endblock %}
