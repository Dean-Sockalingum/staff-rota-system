{% extends "scheduling/base.html" %}
{% load static %}

{% block title %}Incident Trend Analysis Dashboard{% endblock %}

{% block extra_css %}
<style>
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s;
    }
    
    .chart-card:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    
    .chart-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .kpi-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }
    
    .kpi-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        opacity: 0.8;
    }
    
    .kpi-value {
        font-size: 2.8rem;
        font-weight: bold;
        color: #667eea;
        margin: 10px 0;
    }
    
    .kpi-label {
        color: #666;
        font-size: 0.95rem;
        font-weight: 500;
    }
    
    .kpi-trend {
        margin-top: 10px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }
    
    .trend-up {
        color: #dc3545;
    }
    
    .trend-down {
        color: #28a745;
    }
    
    .trend-stable {
        color: #ffc107;
    }
    
    .filter-bar {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .filter-bar select {
        padding: 8px 15px;
        border-radius: 6px;
        border: 1px solid #dee2e6;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
    }
    
    .insight-box {
        background: #e7f3ff;
        border-left: 4px solid #0066cc;
        padding: 15px 20px;
        border-radius: 6px;
        margin-top: 15px;
    }
    
    .insight-box h6 {
        color: #0066cc;
        margin-bottom: 8px;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2">
                    <i class="bi bi-graph-up"></i> Incident Trend Analysis Dashboard
                </h1>
                <p class="mb-0 opacity-75">
                    12-month trending data and performance metrics for incident management
                </p>
            </div>
            <div>
                <a href="{% url 'incident_safety:dashboard' %}" class="btn btn-light">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="filter-bar">
        <label class="fw-bold">Filter Data:</label>
        <select id="timeRangeFilter" class="form-select" style="width: auto;">
            <option value="12">Last 12 Months</option>
            <option value="6">Last 6 Months</option>
            <option value="3">Last 3 Months</option>
        </select>
        <select id="homeFilter" class="form-select" style="width: auto;">
            <option value="all">All Care Homes</option>
            {% for home in care_homes %}
            <option value="{{ home.id }}">{{ home.name }}</option>
            {% endfor %}
        </select>
        <button class="btn btn-primary ms-auto" onclick="window.print()">
            <i class="bi bi-printer"></i> Print Report
        </button>
    </div>
    
    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-icon text-primary">
                <i class="bi bi-exclamation-triangle-fill"></i>
            </div>
            <div class="kpi-value">{{ kpis.total_incidents }}</div>
            <div class="kpi-label">Total Incidents (12mo)</div>
            <div class="kpi-trend {% if kpis.incident_trend > 0 %}trend-up{% elif kpis.incident_trend < 0 %}trend-down{% else %}trend-stable{% endif %}">
                <i class="bi bi-{% if kpis.incident_trend > 0 %}arrow-up{% elif kpis.incident_trend < 0 %}arrow-down{% else %}dash{% endif %}"></i>
                {{ kpis.incident_trend|floatformat:1 }}% vs last year
            </div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-icon text-success">
                <i class="bi bi-check-circle-fill"></i>
            </div>
            <div class="kpi-value">{{ kpis.rca_completion_rate|floatformat:0 }}%</div>
            <div class="kpi-label">RCA Completion Rate</div>
            <div class="kpi-trend trend-down">
                <i class="bi bi-check"></i>
                Target: 95%
            </div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-icon text-warning">
                <i class="bi bi-clipboard-check-fill"></i>
            </div>
            <div class="kpi-value">{{ kpis.action_plan_effectiveness|floatformat:0 }}%</div>
            <div class="kpi-label">Action Plan Effectiveness</div>
            <div class="kpi-trend trend-down">
                <i class="bi bi-graph-up"></i>
                Improving
            </div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-icon text-info">
                <i class="bi bi-clock-fill"></i>
            </div>
            <div class="kpi-value">{{ kpis.avg_investigation_days|floatformat:1 }}</div>
            <div class="kpi-label">Avg Days to Complete RCA</div>
            <div class="kpi-trend trend-down">
                <i class="bi bi-arrow-down"></i>
                Faster than target (30 days)
            </div>
        </div>
    </div>
    
    <!-- Charts Row 1 -->
    <div class="row">
        <div class="col-lg-8">
            <div class="chart-card">
                <div class="chart-title">
                    <i class="bi bi-graph-up text-primary"></i>
                    Incident Trends (12 Months)
                </div>
                <div class="chart-container">
                    <canvas id="incidentTrendChart"></canvas>
                </div>
                <div class="insight-box">
                    <h6><i class="bi bi-lightbulb"></i> Key Insight</h6>
                    <p class="mb-0">Incidents have decreased by {{ kpis.incident_reduction|floatformat:1 }}% compared to the previous 12-month period, primarily due to improved safety protocols.</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="chart-card">
                <div class="chart-title">
                    <i class="bi bi-pie-chart text-warning"></i>
                    By Severity
                </div>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="severityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Row 2 -->
    <div class="row">
        <div class="col-lg-6">
            <div class="chart-card">
                <div class="chart-title">
                    <i class="bi bi-bar-chart text-success"></i>
                    By Incident Type
                </div>
                <div class="chart-container" style="height: 350px;">
                    <canvas id="incidentTypeChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="chart-card">
                <div class="chart-title">
                    <i class="bi bi-building text-info"></i>
                    By Location
                </div>
                <div class="chart-container" style="height: 350px;">
                    <canvas id="locationChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Row 3 -->
    <div class="row">
        <div class="col-12">
            <div class="chart-card">
                <div class="chart-title">
                    <i class="bi bi-speedometer text-danger"></i>
                    RCA Performance Metrics
                </div>
                <div class="chart-container">
                    <canvas id="rcaPerformanceChart"></canvas>
                </div>
                <div class="insight-box">
                    <h6><i class="bi bi-info-circle"></i> Performance Summary</h6>
                    <p class="mb-0">
                        {{ kpis.rca_completion_rate|floatformat:0 }}% of required RCAs completed within target timeframe. 
                        Action plan effectiveness at {{ kpis.action_plan_effectiveness|floatformat:0 }}%, showing strong follow-through on safety improvements.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Chart.js Global Configuration
    Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    Chart.defaults.plugins.legend.position = 'bottom';
    Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(0, 0, 0, 0.8)';
    
    // Data from Django
    const trendData = {{ trend_data|safe }};
    const severityData = {{ severity_data|safe }};
    const typeData = {{ type_data|safe }};
    const locationData = {{ location_data|safe }};
    const rcaMetrics = {{ rca_metrics|safe }};
    
    // Incident Trend Chart (Line)
    const trendCtx = document.getElementById('incidentTrendChart').getContext('2d');
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: trendData.months,
            datasets: [{
                label: 'Total Incidents',
                data: trendData.counts,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    
    // Severity Distribution (Doughnut)
    const severityCtx = document.getElementById('severityChart').getContext('2d');
    new Chart(severityCtx, {
        type: 'doughnut',
        data: {
            labels: severityData.labels,
            datasets: [{
                data: severityData.values,
                backgroundColor: [
                    '#dc3545',  // Critical
                    '#fd7e14',  // Major
                    '#ffc107',  // Moderate
                    '#0dcaf0',  // Minor
                    '#198754'   // Near Miss
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
    
    // Incident Type Chart (Horizontal Bar)
    const typeCtx = document.getElementById('incidentTypeChart').getContext('2d');
    new Chart(typeCtx, {
        type: 'bar',
        data: {
            labels: typeData.labels,
            datasets: [{
                label: 'Count',
                data: typeData.values,
                backgroundColor: '#28a745',
                borderRadius: 6
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Location Chart (Bar)
    const locationCtx = document.getElementById('locationChart').getContext('2d');
    new Chart(locationCtx, {
        type: 'bar',
        data: {
            labels: locationData.labels,
            datasets: [{
                label: 'Incidents',
                data: locationData.values,
                backgroundColor: '#17a2b8',
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // RCA Performance Chart (Multi-line)
    const rcaCtx = document.getElementById('rcaPerformanceChart').getContext('2d');
    new Chart(rcaCtx, {
        type: 'line',
        data: {
            labels: rcaMetrics.months,
            datasets: [{
                label: 'RCA Completion Rate (%)',
                data: rcaMetrics.completion_rate,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }, {
                label: 'Action Plan Effectiveness (%)',
                data: rcaMetrics.effectiveness,
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
