"""
Management command to apply the exact 3-week SCW/SCA day shift rotation pattern.
This implements the comprehensive rota table provided by the user.
"""

from django.core.management.base import BaseCommand
from django.db import transaction
from scheduling.models import User, Shift, ShiftType, Unit
from datetime import datetime, timedelta
from collections import defaultdict


class Command(BaseCommand):
    # Make patterns accessible as a class variable
    patterns = {
        # TEAM A - SCW Days (3 shifts/week)
        'SCWD3A01': ('A', 'DEMENTIA', 3, [0,0,0,1,0,1,1], [1,0,0,1,1,0,0], [0,1,1,1,0,0,0]),
        'SCWD3A02': ('A', 'BLUE', 3, [0,0,0,1,0,1,1], [1,0,0,1,1,0,0], [0,1,1,1,0,0,0]),
        'SCWD3A03': ('A', 'ORANGE', 3, [0,0,0,1,0,1,1], [1,0,0,1,1,0,0], [0,1,1,1,0,0,0]),
        # TEAM A - SCW Days (2 shifts/week)
        'SCWD2A01': ('A', 'GREEN', 2, [0,0,0,0,0,1,1], [1,0,0,0,1,0,0], [0,1,1,0,0,0,0]),
        'SCWD2A02': ('A', 'VIOLET', 2, [0,0,0,0,0,1,1], [1,0,0,0,1,0,0], [0,1,1,0,0,0,0]),
        'SCWD2A03': ('A', 'ROSE', 2, [0,0,0,0,0,1,1], [1,0,0,0,1,0,0], [0,1,1,0,0,0,0]),
        'SCWD2A04': ('A', 'GRAPE', 2, [0,0,0,0,0,1,1], [1,0,0,0,1,0,0], [0,1,1,0,0,0,0]),
        'SCWD2A05': ('A', 'PEACH', 2, [0,0,0,0,0,1,1], [1,0,0,0,1,0,0], [0,1,1,0,0,0,0]),
        'SCWD2A06': ('A', 'DEMENTIA', 2, [0,0,0,0,0,1,1], [1,0,0,0,1,0,0], [0,1,1,0,0,0,0]),
        # TEAM A - SCA Days (3 shifts/week)
        'SCAD3A03': ('A', 'DEMENTIA', 3, [0,0,0,1,0,1,1], [1,0,0,1,1,0,0], [0,1,1,1,0,0,0]),
        'SCAD3A04': ('A', 'BLUE', 3, [0,0,0,1,0,1,1], [1,0,0,1,1,0,0], [0,1,1,1,0,0,0]),
        'SCAD3A05': ('A', 'ORANGE', 3, [0,0,0,1,0,1,1], [1,0,0,1,1,0,0], [0,1,1,1,0,0,0]),
        'SCAD3A06': ('A', 'GREEN', 3, [0,0,0,1,0,1,1], [1,0,0,1,1,0,0], [0,1,1,1,0,0,0]),
        'SCAD3A07': ('A', 'VIOLET', 3, [0,0,0,1,0,1,1], [1,0,0,1,1,0,0], [0,1,1,1,0,0,0]),
        'SCAD3A08': ('A', 'ROSE', 3, [0,0,0,1,0,1,1], [1,0,0,1,1,0,0], [0,1,1,1,0,0,0]),
        'SCAD3A09': ('A', 'GRAPE', 3, [0,0,0,1,0,1,1], [1,0,0,1,1,0,0], [0,1,1,1,0,0,0]),
        'SCAD3A10': ('A', 'PEACH', 3, [0,0,0,1,0,1,1], [1,0,0,1,1,0,0], [0,1,1,1,0,0,0]),
        'SCAD3B09': ('A', 'VIOLET', 3, [0,0,0,1,0,1,1], [1,0,0,1,1,0,0], [0,1,1,1,0,0,0]),
        # TEAM A - SCA Days (2 shifts/week)
        'SCAD2A02': ('A', 'PEACH', 2, [0,0,0,0,0,1,1], [1,0,0,0,1,0,0], [0,1,1,0,0,0,0]),
        'SCAD2A03': ('A', 'BLUE', 2, [0,0,0,0,0,1,1], [1,0,0,0,1,0,0], [0,1,1,0,0,0,0]),
        'SCAD2A04': ('A', 'ORANGE', 2, [0,0,0,0,0,1,1], [1,0,0,0,1,0,0], [0,1,1,0,0,0,0]),
        'SCAD2A05': ('A', 'GREEN', 2, [0,0,0,0,0,1,1], [1,0,0,0,1,0,0], [0,1,1,0,0,0,0]),
        'SCAD2A06': ('A', 'VIOLET', 2, [0,0,0,0,0,1,1], [1,0,0,0,1,0,0], [0,1,1,0,0,0,0]),
        'SCAD2A07': ('A', 'ROSE', 2, [0,0,0,0,0,1,1], [1,0,0,0,1,0,0], [0,1,1,0,0,0,0]),
        'SCAD2B02': ('A', 'GRAPE', 2, [0,0,0,0,0,1,1], [1,0,0,0,1,0,0], [0,1,1,0,0,0,0]),
        # TEAM B - SCW Days (3 shifts/week)
        'SCWD3B01': ('B', 'GREEN', 3, [1,0,0,1,1,0,0], [0,1,1,1,0,0,0], [0,0,0,1,0,1,1]),
        'SCWD3B02': ('B', 'VIOLET', 3, [1,0,0,1,1,0,0], [0,1,1,1,0,0,0], [0,0,0,1,0,1,1]),
        'SCWD3B03': ('B', 'ROSE', 3, [1,0,0,1,1,0,0], [0,1,1,1,0,0,0], [0,0,0,1,0,1,1]),
        # TEAM B - SCW Days (2 shifts/week)
        'SCWD2B01': ('B', 'GRAPE', 2, [1,0,0,0,1,0,0], [0,1,1,0,0,0,0], [0,0,0,0,0,1,1]),
        'SCWD2B02': ('B', 'PEACH', 2, [1,0,0,0,1,0,0], [0,1,1,0,0,0,0], [0,0,0,0,0,1,1]),
        'SCWD2B03': ('B', 'DEMENTIA', 2, [1,0,0,0,1,0,0], [0,1,1,0,0,0,0], [0,0,0,0,0,1,1]),
        'SCWD2B04': ('B', 'BLUE', 2, [1,0,0,0,1,0,0], [0,1,1,0,0,0,0], [0,0,0,0,0,1,1]),
        'SCWD2B05': ('B', 'ORANGE', 2, [1,0,0,0,1,0,0], [0,1,1,0,0,0,0], [0,0,0,0,0,1,1]),
        'SCWD2B06': ('B', 'GREEN', 2, [1,0,0,0,1,0,0], [0,1,1,0,0,0,0], [0,0,0,0,0,1,1]),
        # TEAM B - SCA Days (3 shifts/week)
        'SCAD3A01': ('B', 'VIOLET', 3, [1,0,0,1,1,0,0], [0,1,1,1,0,0,0], [0,0,0,1,0,1,1]),
        'SCAD3B01': ('B', 'ROSE', 3, [1,0,0,1,1,0,0], [0,1,1,1,0,0,0], [0,0,0,1,0,1,1]),
        'SCAD3B02': ('B', 'GRAPE', 3, [1,0,0,1,1,0,0], [0,1,1,1,0,0,0], [0,0,0,1,0,1,1]),
        'SCAD3B03': ('B', 'PEACH', 3, [1,0,0,1,1,0,0], [0,1,1,1,0,0,0], [0,0,0,1,0,1,1]),
        'SCAD3B04': ('B', 'DEMENTIA', 3, [1,0,0,1,1,0,0], [0,1,1,1,0,0,0], [0,0,0,1,0,1,1]),
        'SCAD3B05': ('B', 'BLUE', 3, [1,0,0,1,1,0,0], [0,1,1,1,0,0,0], [0,0,0,1,0,1,1]),
        'SCAD3B06': ('B', 'GRAPE', 3, [1,0,0,1,1,0,0], [0,1,1,1,0,0,0], [0,0,0,1,0,1,1]),
        'SCAD3B07': ('B', 'ORANGE', 3, [1,0,0,1,1,0,0], [0,1,1,1,0,0,0], [0,0,0,1,0,1,1]),
        'SCAD3B08': ('B', 'GREEN', 3, [1,0,0,1,1,0,0], [0,1,1,1,0,0,0], [0,0,0,1,0,1,1]),
        # TEAM B - SCA Days (2 shifts/week)
        'SCAD2B01': ('B', 'VIOLET', 2, [1,0,0,0,1,0,0], [0,1,1,0,0,0,0], [0,0,0,0,0,1,1]),
        'SCAD2B03': ('B', 'ROSE', 2, [1,0,0,0,1,0,0], [0,1,1,0,0,0,0], [0,0,0,0,0,1,1]),
        'SCAD2B04': ('B', 'GRAPE', 2, [1,0,0,0,1,0,0], [0,1,1,0,0,0,0], [0,0,0,0,0,1,1]),
        'SCAD2B05': ('B', 'PEACH', 2, [1,0,0,0,1,0,0], [0,1,1,0,0,0,0], [0,0,0,0,0,1,1]),
        'SCAD2B06': ('B', 'DEMENTIA', 2, [1,0,0,0,1,0,0], [0,1,1,0,0,0,0], [0,0,0,0,0,1,1]),
        'SCAD2B07': ('B', 'BLUE', 2, [1,0,0,0,1,0,0], [0,1,1,0,0,0,0], [0,0,0,0,0,1,1]),
        'SCAD2B08': ('B', 'ORANGE', 2, [1,0,0,0,1,0,0], [0,1,1,0,0,0,0], [0,0,0,0,0,1,1]),
        # TEAM C - SCW Days (3 shifts/week)
        'SCWD3C01': ('C', 'GRAPE', 3, [0,1,1,1,0,0,0], [0,0,0,1,0,1,1], [1,0,0,1,1,0,0]),
        'SCWD3C02': ('C', 'PEACH', 3, [0,1,1,1,0,0,0], [0,0,0,1,0,1,1], [1,0,0,1,1,0,0]),
        'SCWD3C03': ('C', 'DEMENTIA', 3, [0,1,1,1,0,0,0], [0,0,0,1,0,1,1], [1,0,0,1,1,0,0]),
        # TEAM C - SCW Days (2 shifts/week)
        'SCWD2C01': ('C', 'BLUE', 2, [0,1,1,0,0,0,0], [0,0,0,0,0,1,1], [1,0,0,0,1,0,0]),
        'SCWD2C02': ('C', 'ORANGE', 2, [0,1,1,0,0,0,0], [0,0,0,0,0,1,1], [1,0,0,0,1,0,0]),
        'SCWD2C03': ('C', 'GREEN', 2, [0,1,1,0,0,0,0], [0,0,0,0,0,1,1], [1,0,0,0,1,0,0]),
        'SCWD2C04': ('C', 'VIOLET', 2, [0,1,1,0,0,0,0], [0,0,0,0,0,1,1], [1,0,0,0,1,0,0]),
        'SCWD2C05': ('C', 'ROSE', 2, [0,1,1,0,0,0,0], [0,0,0,0,0,1,1], [1,0,0,0,1,0,0]),
        'SCWD2C06': ('C', 'GRAPE', 2, [0,1,1,0,0,0,0], [0,0,0,0,0,1,1], [1,0,0,0,1,0,0]),
        # TEAM C - SCA Days (3 shifts/week)
        'SCAD3A02': ('C', 'PEACH', 3, [0,1,1,1,0,0,0], [0,0,0,1,0,1,1], [1,0,0,1,1,0,0]),
        'SCAD3C01': ('C', 'DEMENTIA', 3, [0,1,1,1,0,0,0], [0,0,0,1,0,1,1], [1,0,0,1,1,0,0]),
        'SCAD3C02': ('C', 'BLUE', 3, [0,1,1,1,0,0,0], [0,0,0,1,0,1,1], [1,0,0,1,1,0,0]),
        'SCAD3C03': ('C', 'ORANGE', 3, [0,1,1,1,0,0,0], [0,0,0,1,0,1,1], [1,0,0,1,1,0,0]),
        'SCAD3C04': ('C', 'GREEN', 3, [0,1,1,1,0,0,0], [0,0,0,1,0,1,1], [1,0,0,1,1,0,0]),
        'SCAD3C05': ('C', 'VIOLET', 3, [0,1,1,1,0,0,0], [0,0,0,1,0,1,1], [1,0,0,1,1,0,0]),
        'SCAD3C06': ('C', 'ROSE', 3, [0,1,1,1,0,0,0], [0,0,0,1,0,1,1], [1,0,0,1,1,0,0]),
        'SCAD3C07': ('C', 'GRAPE', 3, [0,1,1,1,0,0,0], [0,0,0,1,0,1,1], [1,0,0,1,1,0,0]),
        'SCAD3C08': ('C', 'PEACH', 3, [0,1,1,1,0,0,0], [0,0,0,1,0,1,1], [1,0,0,1,1,0,0]),
        'SCAD3C09': ('C', 'DEMENTIA', 3, [0,1,1,1,0,0,0], [0,0,0,1,0,1,1], [1,0,0,1,1,0,0]),
        'SCAD3C10': ('C', 'BLUE', 3, [0,1,1,1,0,0,0], [0,0,0,1,0,1,1], [1,0,0,1,1,0,0]),
        'SCAD3C11': ('C', 'ORANGE', 3, [0,1,1,1,0,0,0], [0,0,0,1,0,1,1], [1,0,0,1,1,0,0]),
        # TEAM C - SCA Days (2 shifts/week)
        'SCAD2C08': ('C', 'GREEN', 2, [0,1,1,0,0,0,0], [0,0,0,0,0,1,1], [1,0,0,0,1,0,0]),
        'SCAD2A01': ('C', 'VIOLET', 2, [0,1,1,0,0,0,0], [0,0,0,0,0,1,1], [1,0,0,0,1,0,0]),
        'SCAD2A08': ('C', 'ROSE', 2, [0,1,1,0,0,0,0], [0,0,0,0,0,1,1], [1,0,0,0,1,0,0]),
        'SCAD2C01': ('C', 'GRAPE', 2, [0,1,1,0,0,0,0], [0,0,0,0,0,1,1], [1,0,0,0,1,0,0]),
        'SCAD2C02': ('C', 'PEACH', 2, [0,1,1,0,0,0,0], [0,0,0,0,0,1,1], [1,0,0,0,1,0,0]),
        'SCAD2C03': ('C', 'DEMENTIA', 2, [0,1,1,0,0,0,0], [0,0,0,0,0,1,1], [1,0,0,0,1,0,0]),
        'SCAD2C04': ('C', 'BLUE', 2, [0,1,1,0,0,0,0], [0,0,0,0,0,1,1], [1,0,0,0,1,0,0]),
        'SCAD2C05': ('C', 'ORANGE', 2, [0,1,1,0,0,0,0], [0,0,0,0,0,1,1], [1,0,0,0,1,0,0]),
    }
    help = 'Apply exact 3-week SCW/SCA day rotation pattern from provided table'

    def add_arguments(self, parser):
        parser.add_argument('--start_date', type=str, default=None, help='Start date for the rota (YYYY-MM-DD)')
        parser.add_argument('--weeks', type=int, default=12, help='Number of weeks to generate (default: 12)')
        parser.add_argument('--dry_run', action='store_true', help='Dry run mode (no DB writes)')

    def handle(self, *args, **options):
        # Set default start date if not provided
        if options.get('start_date'):
            start_date = datetime.strptime(options['start_date'], '%Y-%m-%d').date()
        else:
            # Default to 2026-01-04 if not provided
            start_date = datetime(2026, 1, 4).date()
        cycles = options.get('weeks', 12)
        dry_run = options.get('dry_run', False)

        self.stdout.write(f"Applying 3-week SCW/SCA day rotation starting {start_date}")
        self.stdout.write(f"Cycles: {cycles} (total {cycles * 3} weeks)")
        self.stdout.write(f"Mode: {'DRY RUN' if dry_run else 'LIVE'}\n")

        # ...existing code continues...
