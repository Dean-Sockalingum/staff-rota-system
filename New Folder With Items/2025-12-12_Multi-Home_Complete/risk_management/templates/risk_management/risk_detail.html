{% extends "base.html" %}
{% load static %}

{% block title %}{{ risk.title }} - Risk Detail{% endblock %}

{% block extra_css %}
<style>
    .risk-score-box {
        padding: 20px;
        text-align: center;
        border-radius: 8px;
        color: white;
        font-weight: bold;
    }
    .risk-score-box.critical { background-color: #dc3545; }
    .risk-score-box.high { background-color: #fd7e14; }
    .risk-score-box.medium { background-color: #ffc107; color: #212529; }
    .risk-score-box.low { background-color: #28a745; }
    
    .timeline-item {
        border-left: 3px solid #007bff;
        padding-left: 20px;
        margin-bottom: 20px;
        position: relative;
    }
    .timeline-item:before {
        content: "";
        position: absolute;
        left: -8px;
        top: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #007bff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-shield-alt"></i> {{ risk.title }}</h1>
        <div>
            <a href="{% url 'risk_management:risk_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Register
            </a>
            <a href="{% url 'risk_management:risk_edit' risk.pk %}" class="btn btn-primary">
                <i class="fas fa-edit"></i> Edit Risk
            </a>
            <a href="{% url 'risk_management:review_create' risk.pk %}" class="btn btn-success">
                <i class="fas fa-clipboard-check"></i> Conduct Review
            </a>
        </div>
    </div>
    
    <!-- Risk Summary -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Risk Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">Risk ID:</dt>
                        <dd class="col-sm-9"><strong>{{ risk.risk_id }}</strong></dd>
                        
                        <dt class="col-sm-3">Care Home:</dt>
                        <dd class="col-sm-9">{{ risk.care_home.name }}</dd>
                        
                        <dt class="col-sm-3">Category:</dt>
                        <dd class="col-sm-9">
                            <span class="badge" style="background-color: {{ risk.category.color }};">
                                {{ risk.category.name }}
                            </span>
                        </dd>
                        
                        <dt class="col-sm-3">Affected Area:</dt>
                        <dd class="col-sm-9">{{ risk.affected_area|default:"Not specified" }}</dd>
                        
                        <dt class="col-sm-3">Description:</dt>
                        <dd class="col-sm-9">{{ risk.description }}</dd>
                        
                        <dt class="col-sm-3">Risk Owner:</dt>
                        <dd class="col-sm-9">{{ risk.risk_owner.get_full_name }}</dd>
                        
                        <dt class="col-sm-3">Identified By:</dt>
                        <dd class="col-sm-9">{{ risk.identified_by.get_full_name }} on {{ risk.identified_date }}</dd>
                        
                        <dt class="col-sm-3">Status:</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-primary">{{ risk.get_status_display }}</span>
                        </dd>
                        
                        <dt class="col-sm-3">Priority:</dt>
                        <dd class="col-sm-9">
                            <span class="badge {% if risk.priority == 'CRITICAL' %}bg-danger
                                          {% elif risk.priority == 'HIGH' %}bg-warning
                                          {% elif risk.priority == 'MEDIUM' %}bg-info
                                          {% else %}bg-success{% endif %}">
                                {{ risk.get_priority_display }}
                            </span>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Inherent Risk -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Inherent Risk</h6>
                </div>
                <div class="card-body">
                    <div class="risk-score-box {% if risk.inherent_score >= 15 %}critical
                                                 {% elif risk.inherent_score >= 10 %}high
                                                 {% elif risk.inherent_score >= 5 %}medium
                                                 {% else %}low{% endif %}">
                        <h2>{{ risk.inherent_score }}</h2>
                        <p class="mb-0">L{{ risk.inherent_likelihood }} × I{{ risk.inherent_impact }}</p>
                    </div>
                </div>
            </div>
            
            <!-- Residual Risk -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Residual Risk (Current)</h6>
                </div>
                <div class="card-body">
                    <div class="risk-score-box {% if risk.residual_score >= 15 %}critical
                                                 {% elif risk.residual_score >= 10 %}high
                                                 {% elif risk.residual_score >= 5 %}medium
                                                 {% else %}low{% endif %}">
                        <h2>{{ risk.residual_score }}</h2>
                        <p class="mb-0">L{{ risk.residual_likelihood }} × I{{ risk.residual_impact }}</p>
                    </div>
                </div>
            </div>
            
            {% if risk.target_likelihood %}
            <!-- Target Risk -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Target Risk</h6>
                </div>
                <div class="card-body">
                    <div class="risk-score-box {% if risk.target_score >= 15 %}critical
                                                 {% elif risk.target_score >= 10 %}high
                                                 {% elif risk.target_score >= 5 %}medium
                                                 {% else %}low{% endif %}">
                        <h2>{{ risk.target_score }}</h2>
                        <p class="mb-0">L{{ risk.target_likelihood }} × I{{ risk.target_impact }}</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Current Controls -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Current Controls</h5>
                </div>
                <div class="card-body">
                    <p>{{ risk.current_controls|linebreaks }}</p>
                    <hr>
                    <p><strong>Control Effectiveness:</strong> 
                        <span class="badge bg-info">{{ risk.control_effectiveness }}/5</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mitigations -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Mitigation Actions ({{ total_mitigations }})</h5>
                    <a href="{% url 'risk_management:mitigation_create' risk.pk %}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus"></i> Add Mitigation
                    </a>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 30px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ mitigation_completion_pct }}%;">
                            {{ completed_mitigations }}/{{ total_mitigations }} Complete ({{ mitigation_completion_pct|floatformat:0 }}%)
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Action</th>
                                    <th>Type</th>
                                    <th>Assigned To</th>
                                    <th>Target Date</th>
                                    <th>Status</th>
                                    <th>Expected Reduction</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mitigation in mitigations %}
                                <tr>
                                    <td>{{ mitigation.action }}</td>
                                    <td><span class="badge bg-secondary">{{ mitigation.get_mitigation_type_display }}</span></td>
                                    <td>{{ mitigation.assigned_to.get_full_name }}</td>
                                    <td>
                                        {% if mitigation.is_overdue %}
                                            <span class="text-danger">{{ mitigation.target_completion_date }}</span>
                                        {% else %}
                                            {{ mitigation.target_completion_date }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge {% if mitigation.status == 'COMPLETED' %}bg-success
                                                      {% elif mitigation.status == 'IN_PROGRESS' %}bg-info
                                                      {% elif mitigation.status == 'OVERDUE' %}bg-danger
                                                      {% else %}bg-secondary{% endif %}">
                                            {{ mitigation.get_status_display }}
                                        </span>
                                    </td>
                                    <td>L-{{ mitigation.expected_likelihood_reduction }}, I-{{ mitigation.expected_impact_reduction }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No mitigations defined</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Review History -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Review History ({{ reviews.count }})</h5>
                </div>
                <div class="card-body">
                    {% for review in reviews %}
                    <div class="timeline-item">
                        <h6>{{ review.review_date }} - {{ review.reviewed_by.get_full_name }}</h6>
                        <p><strong>Decision:</strong> <span class="badge bg-primary">{{ review.get_decision_display }}</span></p>
                        <p><strong>Reassessed Score:</strong> {{ review.reassessed_score }} (L{{ review.reassessed_likelihood }} × I{{ review.reassessed_impact }})</p>
                        <p><strong>Controls Effective:</strong> 
                            {% if review.controls_effective %}
                                <span class="text-success"><i class="fas fa-check-circle"></i> Yes</span>
                            {% else %}
                                <span class="text-danger"><i class="fas fa-times-circle"></i> No</span>
                            {% endif %}
                        </p>
                        {% if review.recommended_actions %}
                        <p><strong>Recommendations:</strong> {{ review.recommended_actions }}</p>
                        {% endif %}
                        {% if review.next_review_date %}
                        <p><strong>Next Review:</strong> {{ review.next_review_date }}</p>
                        {% endif %}
                    </div>
                    {% empty %}
                    <p class="text-muted text-center">No reviews conducted yet</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    {% if treatment_plan %}
    <!-- Treatment Plan -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Treatment Plan</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">Treatment Strategy:</dt>
                        <dd class="col-sm-9">{{ treatment_plan.get_treatment_strategy_display }}</dd>
                        
                        <dt class="col-sm-3">Plan Owner:</dt>
                        <dd class="col-sm-9">{{ treatment_plan.plan_owner.get_full_name }}</dd>
                        
                        <dt class="col-sm-3">Budget:</dt>
                        <dd class="col-sm-9">£{{ treatment_plan.estimated_budget }} (Spent: £{{ treatment_plan.actual_spend }})</dd>
                        
                        <dt class="col-sm-3">Timeline:</dt>
                        <dd class="col-sm-9">{{ treatment_plan.start_date }} → {{ treatment_plan.target_completion_date }}</dd>
                        
                        <dt class="col-sm-3">Status:</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-info">{{ treatment_plan.get_plan_status_display }}</span>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Regulatory & Notes -->
    <div class="row mb-4">
        <div class="col-md-6">
            {% if risk.regulatory_requirement %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Regulatory Requirement</h6>
                </div>
                <div class="card-body">
                    <p>{{ risk.regulatory_requirement|linebreaks }}</p>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="col-md-6">
            {% if risk.notes %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Notes</h6>
                </div>
                <div class="card-body">
                    <p>{{ risk.notes|linebreaks }}</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
