# Generated by Django 4.2.27 on 2026-01-14 19:29

from django.conf import settings
import django.core.validators
from django.db import migrations, models
import django.db.models.deletion
import django.utils.timezone


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('quality_audits', '0001_initial'),
        ('scheduling', '0058_alter_user_sms_notifications_enabled'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='RiskCategory',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=200, unique=True)),
                ('description', models.TextField()),
                ('color', models.CharField(default='#6c757d', help_text='Hex color for dashboards (e.g., #dc3545)', max_length=7)),
                ('is_active', models.BooleanField(default=True)),
                ('his_domain', models.CharField(blank=True, help_text='Healthcare Improvement Scotland domain', max_length=100)),
                ('care_inspectorate_theme', models.CharField(blank=True, help_text='Care Inspectorate quality theme', max_length=100)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('parent', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='subcategories', to='risk_management.riskcategory')),
            ],
            options={
                'verbose_name_plural': 'Risk Categories',
                'ordering': ['name'],
            },
        ),
        migrations.CreateModel(
            name='RiskRegister',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('risk_id', models.CharField(editable=False, max_length=20, unique=True)),
                ('title', models.CharField(max_length=300)),
                ('description', models.TextField(help_text='Detailed description of the risk')),
                ('affected_area', models.CharField(blank=True, help_text='Specific unit, department, or area affected', max_length=200)),
                ('inherent_likelihood', models.IntegerField(choices=[(1, 'Rare (1) - <5% chance'), (2, 'Unlikely (2) - 5-25% chance'), (3, 'Possible (3) - 25-50% chance'), (4, 'Likely (4) - 50-75% chance'), (5, 'Almost Certain (5) - >75% chance')], validators=[django.core.validators.MinValueValidator(1), django.core.validators.MaxValueValidator(5)])),
                ('inherent_impact', models.IntegerField(choices=[(1, 'Negligible (1) - Minor injury/disruption'), (2, 'Minor (2) - First aid/short-term effects'), (3, 'Moderate (3) - Medical treatment/moderate harm'), (4, 'Major (4) - Severe harm/long-term effects'), (5, 'Catastrophic (5) - Death/permanent disability')], validators=[django.core.validators.MinValueValidator(1), django.core.validators.MaxValueValidator(5)])),
                ('inherent_score', models.IntegerField(editable=False)),
                ('current_controls', models.TextField(help_text='Existing controls and measures in place')),
                ('control_effectiveness', models.IntegerField(choices=[(1, 'Ineffective'), (2, 'Partially Effective'), (3, 'Mostly Effective'), (4, 'Fully Effective')], default=2)),
                ('residual_likelihood', models.IntegerField(choices=[(1, 'Rare (1) - <5% chance'), (2, 'Unlikely (2) - 5-25% chance'), (3, 'Possible (3) - 25-50% chance'), (4, 'Likely (4) - 50-75% chance'), (5, 'Almost Certain (5) - >75% chance')], validators=[django.core.validators.MinValueValidator(1), django.core.validators.MaxValueValidator(5)])),
                ('residual_impact', models.IntegerField(choices=[(1, 'Negligible (1) - Minor injury/disruption'), (2, 'Minor (2) - First aid/short-term effects'), (3, 'Moderate (3) - Medical treatment/moderate harm'), (4, 'Major (4) - Severe harm/long-term effects'), (5, 'Catastrophic (5) - Death/permanent disability')], validators=[django.core.validators.MinValueValidator(1), django.core.validators.MaxValueValidator(5)])),
                ('residual_score', models.IntegerField(editable=False)),
                ('target_likelihood', models.IntegerField(blank=True, choices=[(1, 'Rare (1) - <5% chance'), (2, 'Unlikely (2) - 5-25% chance'), (3, 'Possible (3) - 25-50% chance'), (4, 'Likely (4) - 50-75% chance'), (5, 'Almost Certain (5) - >75% chance')], null=True, validators=[django.core.validators.MinValueValidator(1), django.core.validators.MaxValueValidator(5)])),
                ('target_impact', models.IntegerField(blank=True, choices=[(1, 'Negligible (1) - Minor injury/disruption'), (2, 'Minor (2) - First aid/short-term effects'), (3, 'Moderate (3) - Medical treatment/moderate harm'), (4, 'Major (4) - Severe harm/long-term effects'), (5, 'Catastrophic (5) - Death/permanent disability')], null=True, validators=[django.core.validators.MinValueValidator(1), django.core.validators.MaxValueValidator(5)])),
                ('target_score', models.IntegerField(blank=True, editable=False, null=True)),
                ('status', models.CharField(choices=[('IDENTIFIED', 'Identified'), ('ASSESSED', 'Assessed'), ('MITIGATED', 'Mitigation in Progress'), ('CONTROLLED', 'Controlled'), ('ACCEPTED', 'Accepted'), ('TRANSFERRED', 'Transferred'), ('CLOSED', 'Closed'), ('ESCALATED', 'Escalated')], default='IDENTIFIED', max_length=20)),
                ('priority', models.CharField(editable=False, help_text='Auto-calculated from residual score', max_length=20)),
                ('last_reviewed', models.DateField(blank=True, null=True)),
                ('next_review_date', models.DateField()),
                ('review_frequency', models.CharField(choices=[('DAILY', 'Daily'), ('WEEKLY', 'Weekly'), ('MONTHLY', 'Monthly'), ('QUARTERLY', 'Quarterly'), ('BIANNUALLY', 'Bi-Annually'), ('ANNUALLY', 'Annually')], default='MONTHLY', max_length=20)),
                ('regulatory_requirement', models.TextField(blank=True, help_text='Scottish regulatory requirements (HIS, Care Inspectorate, SSSC)')),
                ('compliance_deadline', models.DateField(blank=True, null=True)),
                ('identified_date', models.DateField(default=django.utils.timezone.now)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('notes', models.TextField(blank=True)),
                ('is_escalated', models.BooleanField(default=False)),
                ('escalation_reason', models.TextField(blank=True)),
                ('assigned_to', models.ForeignKey(blank=True, help_text='Person assigned to implement mitigations', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='assigned_risks', to=settings.AUTH_USER_MODEL)),
                ('care_home', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='risks', to='scheduling.carehome')),
                ('category', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='risk_management.riskcategory')),
                ('identified_by', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='identified_risks', to=settings.AUTH_USER_MODEL)),
                ('related_incidents', models.ManyToManyField(blank=True, help_text='Incidents that led to risk identification', related_name='risks', to='scheduling.incidentreport')),
                ('risk_owner', models.ForeignKey(help_text='Person responsible for managing this risk', on_delete=django.db.models.deletion.PROTECT, related_name='owned_risks', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-residual_score', 'next_review_date'],
            },
        ),
        migrations.CreateModel(
            name='RiskTreatmentPlan',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('plan_name', models.CharField(max_length=300)),
                ('objectives', models.TextField(help_text='Goals of this treatment plan')),
                ('treatment_strategy', models.TextField(help_text='Overall strategy to manage this risk')),
                ('success_criteria', models.TextField(help_text='How to measure success of this plan')),
                ('status', models.CharField(choices=[('DRAFT', 'Draft'), ('PENDING_APPROVAL', 'Pending Approval'), ('APPROVED', 'Approved'), ('IN_PROGRESS', 'In Progress'), ('COMPLETED', 'Completed'), ('CANCELLED', 'Cancelled')], default='DRAFT', max_length=20)),
                ('approval_date', models.DateField(blank=True, null=True)),
                ('start_date', models.DateField()),
                ('target_completion_date', models.DateField()),
                ('actual_completion_date', models.DateField(blank=True, null=True)),
                ('total_budget', models.DecimalField(decimal_places=2, help_text='Total budget in GBP', max_digits=12)),
                ('spent_to_date', models.DecimalField(decimal_places=2, default=0, help_text='Amount spent so far in GBP', max_digits=12)),
                ('overall_progress', models.IntegerField(default=0, help_text='Overall plan completion (0-100%)', validators=[django.core.validators.MinValueValidator(0), django.core.validators.MaxValueValidator(100)])),
                ('last_updated', models.DateField(auto_now=True)),
                ('monthly_updates', models.TextField(blank=True, help_text='Monthly progress updates')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('approved_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='approved_treatment_plans', to=settings.AUTH_USER_MODEL)),
                ('created_by', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='created_treatment_plans', to=settings.AUTH_USER_MODEL)),
                ('linked_pdsa_projects', models.ManyToManyField(blank=True, related_name='risk_treatment_plans', to='quality_audits.pdsaproject')),
                ('plan_owner', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='owned_treatment_plans', to=settings.AUTH_USER_MODEL)),
                ('risk', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='treatment_plan', to='risk_management.riskregister')),
                ('team_members', models.ManyToManyField(blank=True, related_name='treatment_plan_teams', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='RiskMitigation',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('action', models.CharField(help_text='Specific mitigation action', max_length=300)),
                ('description', models.TextField(help_text='Detailed description of how to implement')),
                ('mitigation_type', models.CharField(choices=[('ELIMINATE', 'Eliminate - Remove the hazard'), ('SUBSTITUTE', 'Substitute - Replace with safer alternative'), ('ENGINEERING', 'Engineering Controls - Physical changes'), ('ADMINISTRATIVE', 'Administrative - Policies and procedures'), ('PPE', 'PPE - Personal protective equipment')], max_length=20)),
                ('expected_likelihood_reduction', models.IntegerField(choices=[(1, '1'), (2, '2'), (3, '3'), (4, '4'), (5, '5')], help_text='Expected reduction in likelihood (1-5)')),
                ('expected_impact_reduction', models.IntegerField(choices=[(1, '1'), (2, '2'), (3, '3'), (4, '4'), (5, '5')], help_text='Expected reduction in impact (1-5)')),
                ('status', models.CharField(choices=[('PLANNED', 'Planned'), ('IN_PROGRESS', 'In Progress'), ('COMPLETED', 'Completed'), ('ON_HOLD', 'On Hold'), ('CANCELLED', 'Cancelled'), ('OVERDUE', 'Overdue')], default='PLANNED', max_length=20)),
                ('priority', models.CharField(choices=[('IMMEDIATE', 'Immediate'), ('HIGH', 'High'), ('MEDIUM', 'Medium'), ('LOW', 'Low')], default='MEDIUM', max_length=20)),
                ('start_date', models.DateField(blank=True, null=True)),
                ('target_completion_date', models.DateField()),
                ('actual_completion_date', models.DateField(blank=True, null=True)),
                ('estimated_cost', models.DecimalField(blank=True, decimal_places=2, help_text='Estimated cost in GBP', max_digits=10, null=True)),
                ('actual_cost', models.DecimalField(blank=True, decimal_places=2, help_text='Actual cost in GBP', max_digits=10, null=True)),
                ('resources_required', models.TextField(blank=True)),
                ('effectiveness_rating', models.IntegerField(blank=True, choices=[(1, 'Ineffective'), (2, 'Partially Effective'), (3, 'Mostly Effective'), (4, 'Fully Effective')], help_text='Post-implementation effectiveness', null=True)),
                ('effectiveness_notes', models.TextField(blank=True)),
                ('regulatory_requirement', models.BooleanField(default=False, help_text='Required by Scottish regulations')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('completion_percentage', models.IntegerField(default=0, help_text='Completion percentage (0-100%)', validators=[django.core.validators.MinValueValidator(0), django.core.validators.MaxValueValidator(100)])),
                ('progress_notes', models.TextField(blank=True)),
                ('assigned_to', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='mitigation_tasks', to=settings.AUTH_USER_MODEL)),
                ('created_by', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='created_mitigations', to=settings.AUTH_USER_MODEL)),
                ('linked_pdsa_project', models.ForeignKey(blank=True, help_text='PDSA improvement project', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='risk_mitigations', to='quality_audits.pdsaproject')),
                ('risk', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='mitigations', to='risk_management.riskregister')),
            ],
            options={
                'ordering': ['priority', 'target_completion_date'],
            },
        ),
        migrations.CreateModel(
            name='RiskReview',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('review_date', models.DateField(default=django.utils.timezone.now)),
                ('reassessed_likelihood', models.IntegerField(choices=[(1, 'Rare (1) - <5% chance'), (2, 'Unlikely (2) - 5-25% chance'), (3, 'Possible (3) - 25-50% chance'), (4, 'Likely (4) - 50-75% chance'), (5, 'Almost Certain (5) - >75% chance')], validators=[django.core.validators.MinValueValidator(1), django.core.validators.MaxValueValidator(5)])),
                ('reassessed_impact', models.IntegerField(choices=[(1, 'Negligible (1) - Minor injury/disruption'), (2, 'Minor (2) - First aid/short-term effects'), (3, 'Moderate (3) - Medical treatment/moderate harm'), (4, 'Major (4) - Severe harm/long-term effects'), (5, 'Catastrophic (5) - Death/permanent disability')], validators=[django.core.validators.MinValueValidator(1), django.core.validators.MaxValueValidator(5)])),
                ('reassessed_score', models.IntegerField(editable=False)),
                ('controls_effective', models.BooleanField(default=True, help_text='Are current controls effective?')),
                ('control_gaps', models.TextField(blank=True, help_text='Identified gaps in current controls')),
                ('new_mitigations_required', models.BooleanField(default=False)),
                ('recommended_actions', models.TextField(blank=True)),
                ('decision', models.CharField(choices=[('CONTINUE', 'Continue Monitoring'), ('ESCALATE', 'Escalate'), ('DE_ESCALATE', 'De-Escalate'), ('CLOSE', 'Close Risk'), ('ACCEPT', 'Accept Risk'), ('TRANSFER', 'Transfer Risk'), ('ADDITIONAL_MITIGATION', 'Additional Mitigation Required')], max_length=30)),
                ('decision_rationale', models.TextField()),
                ('next_review_date', models.DateField()),
                ('follow_up_actions', models.TextField(blank=True)),
                ('changes_in_environment', models.TextField(blank=True, help_text='Changes in care home environment, regulations, or operations')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('notes', models.TextField(blank=True)),
                ('incidents_since_last_review', models.ManyToManyField(blank=True, help_text='Related incidents since last review', to='scheduling.incidentreport')),
                ('reviewed_by', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to=settings.AUTH_USER_MODEL)),
                ('risk', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='reviews', to='risk_management.riskregister')),
            ],
            options={
                'ordering': ['-review_date'],
                'indexes': [models.Index(fields=['risk', '-review_date'], name='risk_manage_risk_id_5c7691_idx')],
            },
        ),
        migrations.AddIndex(
            model_name='riskregister',
            index=models.Index(fields=['care_home', 'status'], name='risk_manage_care_ho_6ee04c_idx'),
        ),
        migrations.AddIndex(
            model_name='riskregister',
            index=models.Index(fields=['residual_score'], name='risk_manage_residua_d09853_idx'),
        ),
        migrations.AddIndex(
            model_name='riskregister',
            index=models.Index(fields=['next_review_date'], name='risk_manage_next_re_3789d6_idx'),
        ),
        migrations.AddIndex(
            model_name='riskmitigation',
            index=models.Index(fields=['risk', 'status'], name='risk_manage_risk_id_861b1c_idx'),
        ),
        migrations.AddIndex(
            model_name='riskmitigation',
            index=models.Index(fields=['target_completion_date'], name='risk_manage_target__68c658_idx'),
        ),
    ]
