{% extends "scheduling/base.html" %}
{% load static %}

{% block title %}Live OT Rankings{% endblock %}

{% block extra_css %}
<style>
    .ranking-card {
        background: white;
        border-left: 4px solid #e5e7eb;
        padding: 1rem;
        margin-bottom: 0.75rem;
        border-radius: 4px;
        transition: all 0.2s;
    }
    .ranking-card:hover {
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transform: translateX(4px);
    }
    .ranking-card.rank-1 { border-left-color: #f59e0b; }
    .ranking-card.rank-2 { border-left-color: #d97706; }
    .ranking-card.rank-3 { border-left-color: #b45309; }
    
    .score-bar {
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }
    .score-fill {
        height: 100%;
        background: linear-gradient(to right, #3b82f6, #10b981);
        transition: width 0.5s;
    }
    
    .breakdown-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.25rem 0;
        font-size: 0.85rem;
    }
    .breakdown-label {
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .breakdown-value {
        font-weight: 600;
        color: #1f2937;
    }
    
    .filter-panel {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2><i class="fas fa-list-ol"></i> Live OT Rankings</h2>
            <p class="text-muted">Real-time staff rankings for overtime coverage</p>
        </div>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel">
        <form method="GET" class="row align-items-end">
            <div class="col-md-3">
                <label class="font-weight-bold">Shift Date</label>
                <input type="date" name="date" class="form-control" value="{{ shift_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-3">
                <label class="font-weight-bold">Shift Type</label>
                <select name="shift_type" class="form-control">
                    <option value="DAY" {% if shift_type == 'DAY' %}selected{% endif %}>Day Shift</option>
                    <option value="NIGHT" {% if shift_type == 'NIGHT' %}selected{% endif %}>Night Shift</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="font-weight-bold">Care Home</label>
                <select name="care_home_id" class="form-control">
                    {% for home in care_homes %}
                    <option value="{{ home.id }}" {% if home.id == care_home.id %}selected{% endif %}>
                        {{ home.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-sync"></i> Update Rankings
                </button>
            </div>
        </form>
        
        <div class="mt-3 text-muted small">
            <strong>Scenario:</strong> {{ shift_type }} shift on {{ shift_date|date:"D, M d, Y" }} at {{ care_home.name }}
            <br>
            <strong>Eligible Staff:</strong> {{ total_eligible }} out of all OT-willing staff
        </div>
    </div>

    <!-- Rankings List -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-trophy"></i> Ranked Candidates 
                        <span class="badge badge-light text-primary ml-2">Top {{ ranked_staff|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if ranked_staff %}
                        {% for candidate in ranked_staff %}
                        <div class="ranking-card rank-{{ forloop.counter }}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge badge-{{ forloop.counter|add:'-1'|divisibleby:3|yesno:'warning,info,secondary' }} mr-2" style="font-size: 1.1rem;">
                                            #{{ forloop.counter }}
                                        </span>
                                        <h5 class="mb-0">{{ candidate.staff.full_name }}</h5>
                                        <span class="badge badge-outline-secondary">{{ candidate.staff.role.name }}</span>
                                    </div>
                                    <div class="text-muted small mt-1">
                                        SAP: {{ candidate.staff.sap }} • 
                                        Contact: {{ candidate.contact_method }} •
                                        {{ candidate.min_notice_hours }}h notice required
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="h4 mb-0" style="color: {% if candidate.total_score >= 80 %}#10b981{% elif candidate.total_score >= 60 %}#3b82f6{% elif candidate.total_score >= 40 %}#f59e0b{% else %}#ef4444{% endif %}">
                                        {{ candidate.total_score }}/100
                                    </div>
                                    <div class="text-muted small">Total Score</div>
                                </div>
                            </div>

                            <!-- Score Bar -->
                            <div class="score-bar mb-3">
                                <div class="score-fill" style="width: {{ candidate.total_score }}%"></div>
                            </div>

                            <!-- Score Breakdown -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="breakdown-row">
                                        <span class="breakdown-label">
                                            <i class="fas fa-check-circle text-success"></i>
                                            Availability (40%)
                                        </span>
                                        <span class="breakdown-value">{{ candidate.breakdown.availability }}/100</span>
                                    </div>
                                    <div class="breakdown-row">
                                        <span class="breakdown-label">
                                            <i class="fas fa-thumbs-up text-primary"></i>
                                            Acceptance Rate (25%)
                                        </span>
                                        <span class="breakdown-value">{{ candidate.breakdown.acceptance_rate }}/100</span>
                                    </div>
                                    <div class="breakdown-row">
                                        <span class="breakdown-label">
                                            <i class="fas fa-balance-scale text-warning"></i>
                                            Fairness (20%)
                                        </span>
                                        <span class="breakdown-value">{{ candidate.breakdown.fairness }}/100</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="breakdown-row">
                                        <span class="breakdown-label">
                                            <i class="fas fa-map-marker-alt text-info"></i>
                                            Proximity (10%)
                                        </span>
                                        <span class="breakdown-value">{{ candidate.breakdown.proximity }}/100</span>
                                    </div>
                                    <div class="breakdown-row">
                                        <span class="breakdown-label">
                                            <i class="fas fa-star text-success"></i>
                                            Reliability (5%)
                                        </span>
                                        <span class="breakdown-value">{{ candidate.breakdown.reliability }}/100</span>
                                    </div>
                                    <div class="breakdown-row">
                                        <span class="breakdown-label">
                                            <i class="fas fa-phone text-secondary"></i>
                                            Contact Method
                                        </span>
                                        <span class="breakdown-value">{{ candidate.contact_method }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="mt-3 d-flex gap-2">
                                <a href="{% url 'ot_staff_detail' candidate.staff.sap %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-user"></i> View Profile
                                </a>
                                {% if forloop.counter <= 5 %}
                                <button class="btn btn-sm btn-success" onclick="contactStaff('{{ candidate.staff.sap }}', '{{ candidate.phone }}')">
                                    <i class="fas fa-paper-plane"></i> Send Alert
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}

                        {% if total_eligible > ranked_staff|length %}
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle"></i>
                            Showing top {{ ranked_staff|length }} candidates. 
                            {{ total_eligible|add:ranked_staff|length|stringformat:'d'|add:'-' }} more staff are eligible but scored lower.
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            No eligible staff found for this scenario. Try adjusting the filters above.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Explanation Panel -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-lightbulb"></i> How Rankings Work</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Availability (40%)</h6>
                            <ul class="small">
                                <li>Shift type match (day/night)</li>
                                <li>Day preference (weekday/weekend)</li>
                                <li>Willing to work at this home</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>Acceptance Rate (25%)</h6>
                            <ul class="small">
                                <li>% of past OT requests accepted</li>
                                <li>Higher rate = higher ranking</li>
                                <li>Rewards reliable responders</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>Fairness (20%)</h6>
                            <ul class="small">
                                <li>Recent OT hours (last 30 days)</li>
                                <li>Less OT = higher fairness score</li>
                                <li>Ensures equal distribution</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function contactStaff(sap, phone) {
    if (confirm(`Send OT alert to ${sap} (${phone})?`)) {
        alert('Alert sent! (Integration with SMS/app pending)');
        // TODO: Trigger actual SMS/app notification
    }
}
</script>
{% endblock %}
