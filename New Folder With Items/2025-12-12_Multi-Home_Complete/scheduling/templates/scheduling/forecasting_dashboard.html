{% extends "scheduling/base.html" %}

{% block title %}Forecasting Dashboard - Staff Rota System{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-chart-line"></i> Staffing Demand Forecasting</h2>
                    <p class="text-muted">
                        Prophet ML predictions with 80% confidence intervals | 
                        <span class="badge bg-info">{{ total_forecasts }} forecasts</span>
                        <span class="badge bg-success">{{ avg_mape }}% MAPE</span>
                    </p>
                </div>
                <div>
                    <a href="{% url 'forecast_accuracy' %}" class="btn btn-outline-primary">
                        <i class="fas fa-check-circle"></i> View Accuracy
                    </a>
                    <a href="{% url 'unit_performance' %}" class="btn btn-outline-info">
                        <i class="fas fa-trophy"></i> Unit Performance
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- High-Risk Alerts -->
    {% if alerts %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning">
                <h5><i class="fas fa-exclamation-triangle"></i> High Uncertainty Alerts ({{ alert_count }})</h5>
                <p class="mb-2">The following forecasts have wide confidence intervals (&gt;50% uncertainty):</p>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Care Home</th>
                                <th>Unit</th>
                                <th>Predicted</th>
                                <th>80% CI</th>
                                <th>Uncertainty</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alert in alerts %}
                            <tr>
                                <td>{{ alert.date|date:"D, M j" }}</td>
                                <td>{{ alert.care_home }}</td>
                                <td><span class="badge bg-secondary">{{ alert.unit }}</span></td>
                                <td>{{ alert.predicted|floatformat:1 }} shifts</td>
                                <td>[{{ alert.ci_lower|floatformat:1 }}, {{ alert.ci_upper|floatformat:1 }}]</td>
                                <td>
                                    <span class="badge bg-danger">
                                        {{ alert.uncertainty_pct|floatformat:0 }}%
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Care Home</label>
                            <select name="care_home" class="form-select">
                                <option value="">All Care Homes</option>
                                {% for home in care_homes %}
                                <option value="{{ home.name }}" {% if home.name == selected_care_home %}selected{% endif %}>
                                    {{ home.get_name_display }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Unit</label>
                            <select name="unit" class="form-select">
                                <option value="">All Units</option>
                                {% for unit in units %}
                                <option value="{{ unit.name }}" {% if unit.name == selected_unit %}selected{% endif %}>
                                    {{ unit.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Forecast Horizon</label>
                            <select name="days_ahead" class="form-select">
                                <option value="7" {% if days_ahead == 7 %}selected{% endif %}>7 days</option>
                                <option value="14" {% if days_ahead == 14 %}selected{% endif %}>14 days</option>
                                <option value="21" {% if days_ahead == 21 %}selected{% endif %}>21 days</option>
                                <option value="30" {% if days_ahead == 30 %}selected{% endif %}>30 days</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h6 class="card-title">Date Range</h6>
                    <p class="h4 mb-0">{{ start_date|date:"M j" }} - {{ end_date|date:"M j" }}</p>
                    <small>{{ days_ahead }} days ahead</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h6 class="card-title">Avg Daily Demand</h6>
                    <p class="h4 mb-0">{{ avg_predicted|floatformat:1 }} shifts</p>
                    <small>Predicted staffing need</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h6 class="card-title">Model Accuracy</h6>
                    <p class="h4 mb-0">{{ avg_mape|floatformat:1 }}%</p>
                    <small>Mean Absolute % Error</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h6 class="card-title">High Risk Days</h6>
                    <p class="h4 mb-0">{{ alert_count }}</p>
                    <small>Wide confidence intervals</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Forecast Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-area"></i> Demand Forecast with Confidence Intervals</h5>
                </div>
                <div class="card-body">
                    <canvas id="forecastChart" style="max-height: 400px;"></canvas>
                </div>
                <div class="card-footer text-muted">
                    <small>
                        <i class="fas fa-info-circle"></i> 
                        Shaded area represents 80% confidence interval. 
                        Higher/wider intervals indicate greater uncertainty.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Forecast Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-table"></i> Detailed Forecasts</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Care Home</th>
                                    <th>Unit</th>
                                    <th>Predicted Shifts</th>
                                    <th>80% Confidence Interval</th>
                                    <th>Uncertainty</th>
                                    <th>Model Accuracy (MAPE)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for forecast in forecasts %}
                                <tr>
                                    <td>
                                        <strong>{{ forecast.forecast_date|date:"D, M j" }}</strong><br>
                                        <small class="text-muted">{{ forecast.forecast_date|date:"Y-m-d" }}</small>
                                    </td>
                                    <td>{{ forecast.care_home.get_name_display }}</td>
                                    <td>
                                        <span class="badge bg-secondary">{{ forecast.unit.name }}</span>
                                    </td>
                                    <td>
                                        <strong>{{ forecast.predicted_shifts|floatformat:1 }}</strong> shifts
                                    </td>
                                    <td>
                                        [{{ forecast.confidence_lower|floatformat:1 }}, {{ forecast.confidence_upper|floatformat:1 }}]
                                        <br>
                                        <small class="text-muted">
                                            Â±{{ forecast.uncertainty_range|floatformat:1 }} shifts
                                        </small>
                                    </td>
                                    <td>
                                        {% if forecast.is_high_uncertainty %}
                                            <span class="badge bg-danger">High</span>
                                        {% else %}
                                            <span class="badge bg-success">Normal</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if forecast.mape %}
                                            {{ forecast.mape|floatformat:1 }}%
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        No forecasts available for selected filters.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scottish Design Info Box -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Scottish Design Principles</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Evidence-Based:</strong>
                            <p class="small mb-0">Forecasts validated with {{ avg_mape|floatformat:1 }}% MAPE (industry benchmark: &lt;30%)</p>
                        </div>
                        <div class="col-md-4">
                            <strong>Transparent:</strong>
                            <p class="small mb-0">Confidence intervals show prediction uncertainty (80% probability range)</p>
                        </div>
                        <div class="col-md-4">
                            <strong>User-Centered:</strong>
                            <p class="small mb-0">High-risk alerts highlight days requiring extra planning attention</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Parse chart data from Django
    const chartData = {{ chart_data|safe }};
    
    // Prepare datasets for Chart.js
    const datasets = [];
    
    chartData.datasets.forEach(dataset => {
        // Main prediction line
        datasets.push({
            label: dataset.label,
            data: dataset.dates.map((date, idx) => ({
                x: date,
                y: dataset.predicted[idx]
            })),
            borderColor: dataset.borderColor,
            backgroundColor: 'transparent',
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6,
        });
        
        // Confidence interval (shaded area)
        datasets.push({
            label: dataset.label + ' (CI)',
            data: dataset.dates.map((date, idx) => ({
                x: date,
                y: [dataset.ci_lower[idx], dataset.ci_upper[idx]]
            })),
            backgroundColor: dataset.backgroundColor,
            borderColor: 'transparent',
            fill: true,
            pointRadius: 0,
        });
    });
    
    // Extract all unique dates
    const allDates = [...new Set(chartData.datasets.flatMap(d => d.dates))].sort();
    
    // Create chart
    const ctx = document.getElementById('forecastChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: allDates,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        filter: (item) => !item.text.includes('(CI)')
                    }
                },
                title: {
                    display: true,
                    text: 'Predicted Staffing Demand'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (Array.isArray(context.parsed.y)) {
                                return `CI: [${context.parsed.y[0].toFixed(1)}, ${context.parsed.y[1].toFixed(1)}]`;
                            }
                            return `Predicted: ${context.parsed.y.toFixed(1)} shifts`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'category',
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Shifts'
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
