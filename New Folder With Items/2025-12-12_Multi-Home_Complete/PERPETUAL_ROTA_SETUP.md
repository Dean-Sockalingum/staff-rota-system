# Perpetual Rota System Setup

## Overview
The rota system now automatically generates future shifts based on your 3-week rolling pattern, ensuring continuous coverage indefinitely without manual intervention.

## How It Works

### 1. Pattern Detection
- The system analyzes the last 21 days (3 weeks) of shifts in the database
- This becomes the template pattern that repeats indefinitely
- Each staff member's schedule, shift types, and assignments are preserved

### 2. Automatic Generation
- Shifts are generated by repeating the 3-week pattern forward in time
- The pattern cycles continuously: Day 1-21, then repeats from Day 1
- All shift details are preserved: user, unit, shift type, overtime, agency, etc.

## Manual Commands

### Generate Future Shifts
```bash
# Generate 26 weeks (6 months) of future shifts
python manage.py generate_future_shifts

# Generate 52 weeks (1 year) ahead
python manage.py generate_future_shifts --weeks 52

# Force regeneration even if shifts exist
python manage.py generate_future_shifts --weeks 26 --force
```

### Check Coverage
```bash
# Check if coverage is sufficient and auto-generate if needed
python manage.py check_rota_coverage

# Custom threshold (generate if less than 90 days ahead)
python manage.py check_rota_coverage --threshold-days 90 --generate-weeks 52
```

## Automated Setup (Recommended)

### Option 1: Cron Job (macOS/Linux)
Add to your crontab to run automatically:

```bash
# Edit crontab
crontab -e

# Add this line to check coverage daily at 2 AM
0 2 * * * cd /Users/deansockalingum/Desktop/Staff_Rota_Backups/2025-12-12_Multi-Home_Complete && /Users/deansockalingum/Desktop/Staff_Rota_Backups/.venv/bin/python manage.py check_rota_coverage >> /tmp/rota_coverage.log 2>&1
```

### Option 2: Weekly Generation
Generate shifts every Sunday at 3 AM:

```bash
0 3 * * 0 cd /Users/deansockalingum/Desktop/Staff_Rota_Backups/2025-12-12_Multi-Home_Complete && /Users/deansockalingum/Desktop/Staff_Rota_Backups/.venv/bin/python manage.py generate_future_shifts --weeks 52 >> /tmp/rota_generation.log 2>&1
```

## Initial Setup for 2026

Run this now to generate shifts for 2026:

```bash
cd /Users/deansockalingum/Desktop/Staff_Rota_Backups/2025-12-12_Multi-Home_Complete
python manage.py generate_future_shifts --weeks 52
```

This will:
- Analyze the 3-week pattern from late December 2025
- Generate all of 2026 (52 weeks) based on that pattern
- Create approximately 5.6 million shifts (109,267 shifts × 52 weeks)

## How the 3-Week Cycle Works

Example:
- **Week 1 (Days 1-7)**: Pattern A
- **Week 2 (Days 8-14)**: Pattern B  
- **Week 3 (Days 15-21)**: Pattern C
- **Week 4 (Days 22-28)**: Repeats Pattern A
- **Week 5 (Days 29-35)**: Repeats Pattern B
- And so on indefinitely...

Each staff member's individual rotation within the 3-week cycle is preserved.

## Maintenance

### Override Individual Shifts
When management needs to change circumstances:
1. Edit shifts directly in Django admin
2. The automatic generation won't overwrite existing shifts (unless using `--force`)
3. Future cycles will continue with the original pattern

### Update the Base Pattern
If you want to change the rolling pattern permanently:
1. Update the shifts for the most recent 3-week period
2. Run: `python manage.py generate_future_shifts --weeks 52 --force`
3. This will regenerate future shifts based on the new pattern

### Monitor Coverage
Check current coverage anytime:
```bash
python manage.py check_rota_coverage
```

## Troubleshooting

### "No pattern shifts found"
- Ensure you have at least 21 days of continuous shifts in the database
- The command needs a complete 3-week cycle to use as a template

### Coverage keeps running low
- Check if the cron job is running: `crontab -l`
- Check logs: `tail -f /tmp/rota_coverage.log`
- Manually run: `python manage.py check_rota_coverage`

### Shifts not appearing
- Verify generation completed: Check Django admin for shift count
- Check date range: Shifts are generated from last existing shift forward
- Run with verbose output to see progress

## Benefits

✅ **No Year-End Issues**: Automatically transitions from 2025 → 2026 → 2027
✅ **Self-Maintaining**: Cron job ensures perpetual coverage
✅ **Pattern Fidelity**: Exact 3-week rotation preserved for all staff
✅ **Override Friendly**: Manual edits don't break auto-generation
✅ **Scalable**: Handles years of data efficiently with bulk operations

## Next Steps

1. **Run initial generation**: `python manage.py generate_future_shifts --weeks 52`
2. **Setup cron job**: Follow "Automated Setup" section above
3. **Test navigation**: Visit rota and navigate to 2026 weeks
4. **Verify pattern**: Check that staff rotations match expectations
